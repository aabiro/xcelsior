<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xcelsior</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
  h1 { color: #ff3333; margin-bottom: 4px; font-size: 28px; }
  .subtitle { color: #666; margin-bottom: 24px; font-size: 13px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .card { background: #111; border: 1px solid #222; border-radius: 6px; padding: 16px; }
  .card h2 { color: #ff3333; font-size: 14px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #222; padding-bottom: 8px; }
  .card.full { grid-column: 1 / -1; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; color: #666; font-weight: normal; padding: 4px 8px; border-bottom: 1px solid #222; }
  td { padding: 4px 8px; border-bottom: 1px solid #1a1a1a; }
  .status { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; }
  .status-active, .status-running { background: #0a2e0a; color: #4caf50; }
  .status-dead, .status-failed { background: #2e0a0a; color: #f44336; }
  .status-queued { background: #2e2e0a; color: #ff9800; }
  .status-completed { background: #0a1a2e; color: #2196f3; }
  .tier { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; }
  .tier-free { background: #1a1a1a; color: #666; }
  .tier-standard { background: #1a1a2e; color: #90caf9; }
  .tier-premium { background: #2e2e0a; color: #ffd700; }
  .tier-urgent { background: #2e0a0a; color: #ff3333; }
  .stat-row { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
  .stat { background: #111; border: 1px solid #222; border-radius: 6px; padding: 16px; flex: 1; text-align: center; min-width: 120px; }
  .stat .num { font-size: 32px; font-weight: bold; color: #ff3333; }
  .stat .label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 4px; }
  .btn { background: #ff3333; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; }
  .btn:hover { background: #cc2222; }
  .btn-row { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .refresh-note { color: #444; font-size: 11px; margin-top: 8px; }
  .canada-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 11px; background: #1a0a0a; color: #ff3333; }
</style>
</head>
<body>

<h1>XCELSIOR</h1>
<p class="subtitle">Distributed GPU scheduler. Ever upward. v2.0.0 <span id="sse-status" style="color:#666">âšª connecting...</span></p>

<div class="btn-row">
  <button class="btn" onclick="refresh()">Refresh</button>
  <button class="btn" onclick="processQueue()">Process Queue</button>
  <button class="btn" onclick="billAll()">Bill All</button>
  <button class="btn" onclick="pingHosts()">Ping Hosts</button>
  <button class="btn" onclick="runFailover()">Failover</button>
  <button class="btn" onclick="runAutoscale()">Autoscale</button>
</div>

<div class="stat-row">
  <div class="stat"><div class="num" id="stat-hosts">-</div><div class="label">Active Hosts</div></div>
  <div class="stat"><div class="num" id="stat-jobs">-</div><div class="label">Total Jobs</div></div>
  <div class="stat"><div class="num" id="stat-running">-</div><div class="label">Running</div></div>
  <div class="stat"><div class="num" id="stat-queued">-</div><div class="label">Queued</div></div>
  <div class="stat"><div class="num" id="stat-revenue">-</div><div class="label">Revenue</div></div>
  <div class="stat"><div class="num" id="stat-market">-</div><div class="label">Marketplace</div></div>
  <div class="stat"><div class="num" id="stat-pool">-</div><div class="label">Pool</div></div>
  <div class="stat"><div class="num" id="stat-spot">-</div><div class="label">Spot Listings</div></div>
</div>

<div class="grid">
  <div class="card">
    <h2>Hosts</h2>
    <table>
      <thead><tr><th>ID</th><th>IP</th><th>GPU</th><th>VRAM Free</th><th>$/hr</th><th>Country</th><th>Status</th></tr></thead>
      <tbody id="hosts-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Jobs</h2>
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>VRAM</th><th>Tier</th><th>Host</th><th>Status</th></tr></thead>
      <tbody id="jobs-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Marketplace</h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>VRAM</th><th>$/hr</th><th>Owner</th><th>Jobs</th><th>Earned</th></tr></thead>
      <tbody id="market-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Autoscale Pool</h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>VRAM</th><th>$/hr</th><th>Country</th><th>Status</th></tr></thead>
      <tbody id="pool-table"></tbody>
    </table>
  </div>
  <div class="card full">
    <h2>Billing</h2>
    <table>
      <thead><tr><th>Job</th><th>Name</th><th>Host</th><th>Tier</th><th>Duration</th><th>Rate</th><th>Cost</th></tr></thead>
      <tbody id="billing-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Spot Prices</h2>
    <table>
      <thead><tr><th>GPU Model</th><th>Spot $/hr</th><th>Supply</th><th>Demand</th></tr></thead>
      <tbody id="spot-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Compute Scores (XCU)</h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>XCU</th></tr></thead>
      <tbody id="score-table"></tbody>
    </table>
  </div>
  <div class="card full">
    <h2>Event Log <span style="font-size:11px;color:#666">(SSE live stream)</span></h2>
    <div id="event-log" style="max-height:200px;overflow-y:auto;font-size:12px;color:#888;"></div>
  </div>
</div>

<p class="refresh-note">Real-time updates via SSE. Falls back to polling every 10s.</p>

<script>
const API = '';

function s(status) {
  return `<span class="status status-${status}">${status}</span>`;
}

function t(tier) {
  return `<span class="tier tier-${tier || 'free'}">${tier || 'free'}</span>`;
}

async function fetchHosts() {
  const r = await fetch(`${API}/hosts?active_only=false`);
  const d = await r.json();
  const active = d.hosts.filter(h => h.status === 'active').length;
  document.getElementById('stat-hosts').textContent = active;
  document.getElementById('hosts-table').innerHTML = d.hosts.map(h =>
    `<tr><td>${h.host_id}</td><td>${h.ip}</td><td>${h.gpu_model}</td><td>${h.free_vram_gb}GB</td><td>$${h.cost_per_hour}</td><td>${h.country || 'â€”'}</td><td>${s(h.status)}</td></tr>`
  ).join('');
}

async function fetchJobs() {
  const r = await fetch(`${API}/jobs`);
  const d = await r.json();
  const running = d.jobs.filter(j => j.status === 'running').length;
  const queued = d.jobs.filter(j => j.status === 'queued').length;
  document.getElementById('stat-jobs').textContent = d.jobs.length;
  document.getElementById('stat-running').textContent = running;
  document.getElementById('stat-queued').textContent = queued;
  document.getElementById('jobs-table').innerHTML = d.jobs.map(j =>
    `<tr><td>${j.job_id}</td><td>${j.name}</td><td>${j.vram_needed_gb}GB</td><td>${t(j.tier)}</td><td>${j.host_id || 'â€”'}</td><td>${s(j.status)}</td></tr>`
  ).join('');
}

async function fetchBilling() {
  const r = await fetch(`${API}/billing`);
  const d = await r.json();
  document.getElementById('stat-revenue').textContent = `$${d.total_revenue}`;
  document.getElementById('billing-table').innerHTML = d.records.map(b =>
    `<tr><td>${b.job_id}</td><td>${b.job_name}</td><td>${b.host_id || 'â€”'}</td><td>${t(b.tier)}</td><td>${b.duration_sec}s</td><td>$${b.rate_per_hour}/hr</td><td>$${b.cost}</td></tr>`
  ).join('');
}

async function fetchMarketplace() {
  const r = await fetch(`${API}/marketplace`);
  const d = await r.json();
  document.getElementById('stat-market').textContent = d.listings.length;
  document.getElementById('market-table').innerHTML = d.listings.map(l =>
    `<tr><td>${l.host_id}</td><td>${l.gpu_model}</td><td>${l.vram_gb}GB</td><td>$${l.price_per_hour}</td><td>${l.owner}</td><td>${l.total_jobs || 0}</td><td>$${l.total_earned || 0}</td></tr>`
  ).join('');
}

async function fetchPool() {
  const r = await fetch(`${API}/autoscale/pool`);
  const d = await r.json();
  document.getElementById('stat-pool').textContent = d.pool.length;
  document.getElementById('pool-table').innerHTML = d.pool.map(p =>
    `<tr><td>${p.host_id}</td><td>${p.gpu_model}</td><td>${p.vram_gb}GB</td><td>$${p.cost_per_hour}</td><td>${p.country || 'â€”'}</td><td>${p.provisioned ? s('active') : s('queued')}</td></tr>`
  ).join('');
}

async function fetchSpotPrices() {
  try {
    const r = await fetch(`${API}/spot-prices`);
    const d = await r.json();
    const prices = d.prices || {};
    const keys = Object.keys(prices);
    document.getElementById('stat-spot').textContent = keys.length;
    document.getElementById('spot-table').innerHTML = keys.map(k => {
      const p = prices[k];
      return `<tr><td>${k}</td><td>$${(p.spot_price || 0).toFixed(3)}</td><td>${p.supply || 0}</td><td>${p.demand || 0}</td></tr>`;
    }).join('');
  } catch(e) {
    document.getElementById('stat-spot').textContent = '?';
  }
}

async function fetchComputeScores() {
  try {
    const r = await fetch(`${API}/compute-scores`);
    const d = await r.json();
    const scores = d.scores || {};
    document.getElementById('score-table').innerHTML = Object.entries(scores).map(([hid, s]) =>
      `<tr><td>${hid}</td><td>${s.gpu_model}</td><td>${s.score.toFixed(1)}</td></tr>`
    ).join('');
  } catch(e) {}
}

async function refresh() {
  await Promise.all([fetchHosts(), fetchJobs(), fetchBilling(), fetchMarketplace(), fetchPool(), fetchSpotPrices(), fetchComputeScores()]);
}

async function processQueue() {
  await fetch(`${API}/queue/process`, { method: 'POST' });
  refresh();
}

async function billAll() {
  await fetch(`${API}/billing/bill-all`, { method: 'POST' });
  refresh();
}

async function pingHosts() {
  await fetch(`${API}/hosts/check`, { method: 'POST' });
  refresh();
}

async function runFailover() {
  await fetch(`${API}/failover`, { method: 'POST' });
  refresh();
}

async function runAutoscale() {
  await fetch(`${API}/autoscale/cycle`, { method: 'POST' });
  refresh();
}

// â”€â”€ SSE (Server-Sent Events) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let evtSource = null;
const eventLog = document.getElementById('event-log');
const sseStatus = document.getElementById('sse-status');
const MAX_LOG_ENTRIES = 100;

function addLogEntry(event, data) {
  const time = new Date().toLocaleTimeString();
  const el = document.createElement('div');
  el.style.borderBottom = '1px solid #1a1a1a';
  el.style.padding = '2px 0';
  el.innerHTML = `<span style="color:#444">${time}</span> <span style="color:#ff3333">${event}</span> ${JSON.stringify(data).substring(0, 200)}`;
  eventLog.prepend(el);
  // Trim old entries
  while (eventLog.children.length > MAX_LOG_ENTRIES) {
    eventLog.removeChild(eventLog.lastChild);
  }
}

function connectSSE() {
  if (evtSource) { evtSource.close(); }

  evtSource = new EventSource(`${API}/api/stream`);

  evtSource.addEventListener('connected', function(e) {
    sseStatus.textContent = 'ðŸŸ¢ live';
    sseStatus.style.color = '#4caf50';
    addLogEntry('connected', JSON.parse(e.data));
  });

  // Refresh on data-changing events
  const refreshEvents = [
    'host_update', 'host_removed', 'job_submitted', 'job_status',
    'queue_processed', 'spot_prices_updated', 'spot_job_submitted',
    'benchmark_result', 'node_admission',
  ];
  refreshEvents.forEach(evt => {
    evtSource.addEventListener(evt, function(e) {
      const data = JSON.parse(e.data);
      addLogEntry(evt, data);
      refresh();  // Update all panels on any event
    });
  });

  // Alert events (don't refresh, just log)
  evtSource.addEventListener('mining_alert', function(e) {
    const data = JSON.parse(e.data);
    addLogEntry('âš ï¸ MINING ALERT', data);
  });

  evtSource.addEventListener('preemption_scheduled', function(e) {
    const data = JSON.parse(e.data);
    addLogEntry('âš ï¸ PREEMPTION', data);
    refresh();
  });

  evtSource.onerror = function() {
    sseStatus.textContent = 'ðŸ”´ disconnected';
    sseStatus.style.color = '#f44336';
    // EventSource auto-reconnects, but let's update status
    setTimeout(() => {
      if (evtSource.readyState === EventSource.CONNECTING) {
        sseStatus.textContent = 'ðŸŸ¡ reconnecting...';
        sseStatus.style.color = '#ff9800';
      }
    }, 1000);
  };
}

// Initial load
refresh();
connectSSE();

// Fallback polling (in case SSE is not available or disconnected)
setInterval(() => {
  if (!evtSource || evtSource.readyState === EventSource.CLOSED) {
    refresh();
  }
}, 10000);
</script>
</body>
</html>
