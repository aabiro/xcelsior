<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xcelsior</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
  h1 { color: #ff3333; margin-bottom: 4px; font-size: 28px; }
  .subtitle { color: #666; margin-bottom: 24px; font-size: 13px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .card { background: #111; border: 1px solid #222; border-radius: 6px; padding: 16px; }
  .card h2 { color: #ff3333; font-size: 14px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #222; padding-bottom: 8px; }
  .card.full { grid-column: 1 / -1; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; color: #666; font-weight: normal; padding: 4px 8px; border-bottom: 1px solid #222; }
  td { padding: 4px 8px; border-bottom: 1px solid #1a1a1a; }
  .status { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; }
  .status-active, .status-running { background: #0a2e0a; color: #4caf50; }
  .status-dead, .status-failed { background: #2e0a0a; color: #f44336; }
  .status-queued { background: #2e2e0a; color: #ff9800; }
  .status-completed { background: #0a1a2e; color: #2196f3; }
  .tier { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; }
  .tier-free { background: #1a1a1a; color: #666; }
  .tier-standard { background: #1a1a2e; color: #90caf9; }
  .tier-premium { background: #2e2e0a; color: #ffd700; }
  .tier-urgent { background: #2e0a0a; color: #ff3333; }
  .stat-row { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
  .stat { background: #111; border: 1px solid #222; border-radius: 6px; padding: 16px; flex: 1; text-align: center; min-width: 120px; }
  .stat .num { font-size: 32px; font-weight: bold; color: #ff3333; }
  .stat .label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 4px; }
  .btn { background: #ff3333; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; }
  .btn:hover { background: #cc2222; }
  .btn-row { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .refresh-note { color: #444; font-size: 11px; margin-top: 8px; }
  .canada-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 11px; background: #1a0a0a; color: #ff3333; }
  .tier-community { background: #1a1a1a; color: #888; }
  .tier-residency { background: #0a1a2e; color: #64b5f6; }
  .tier-sovereignty { background: #1a0a2e; color: #ce93d8; }
  .tier-regulated { background: #2e1a0a; color: #ffb74d; }
  .rep-new_user { color: #888; }
  .rep-new-user { color: #888; }
  .rep-bronze { color: #cd7f32; }
  .rep-silver { color: #c0c0c0; }
  .rep-gold { color: #ffd700; }
  .rep-platinum { color: #e5e4e2; text-shadow: 0 0 6px rgba(229,228,226,0.4); }
  .rep-diamond { color: #b388ff; text-shadow: 0 0 8px rgba(179,136,255,0.5); }
  .badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; }
  .tier-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
  .tier-badge.new_user, .tier-badge.new-user { background: #1a1a1a; color: #888; border: 1px solid #333; }
  .tier-badge.bronze { background: #2e1a0a; color: #cd7f32; border: 1px solid #cd7f32; }
  .tier-badge.silver { background: #1a1a2e; color: #c0c0c0; border: 1px solid #c0c0c0; }
  .tier-badge.gold { background: #2e2e0a; color: #ffd700; border: 1px solid #ffd700; }
  .tier-badge.platinum { background: #1a1a2e; color: #e5e4e2; border: 1px solid #e5e4e2; }
  .tier-badge.diamond { background: #1a0a2e; color: #b388ff; border: 1px solid #b388ff; box-shadow: 0 0 6px rgba(179,136,255,0.3); }
  /* User navbar */
  .user-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .user-bar .left { display: flex; align-items: center; gap: 12px; }
  .user-bar .right { display: flex; align-items: center; gap: 12px; }
  .wallet-display { background: #111; border: 1px solid #222; border-radius: 6px; padding: 4px 12px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
  .wallet-display .amount { font-weight: bold; color: #4caf50; }
  .wallet-display .amount.low { color: #ff9800; }
  .wallet-display .amount.critical { color: #f44336; }
  .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #fff; cursor: pointer; }
  .user-menu { position: relative; }
  .user-dropdown { display: none; position: absolute; right: 0; top: 36px; background: #111; border: 1px solid #333; border-radius: 6px; min-width: 180px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
  .user-dropdown.active { display: block; }
  .user-dropdown a { display: block; padding: 8px 14px; color: #ccc; text-decoration: none; font-size: 12px; border-bottom: 1px solid #222; }
  .user-dropdown a:hover { background: #1a1a1a; color: #fff; }
  .user-dropdown a:last-child { border-bottom: none; }
  /* Login page */
  .login-page { display: none; max-width: 400px; margin: 80px auto; }
  .login-page.active { display: block; }
  .login-card { background: #111; border: 1px solid #222; border-radius: 8px; padding: 32px; }
  .login-card h2 { color: #ff3333; margin-bottom: 8px; text-align: center; }
  .login-card .login-subtitle { color: #888; font-size: 12px; text-align: center; margin-bottom: 24px; }
  .oauth-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 16px; border-radius: 6px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; cursor: pointer; font-family: inherit; font-size: 13px; margin-bottom: 8px; transition: border-color 0.2s; }
  .oauth-btn:hover { border-color: #ff3333; background: #222; }
  .oauth-btn svg { width: 18px; height: 18px; flex-shrink: 0; }
  .divider { display: flex; align-items: center; gap: 12px; margin: 16px 0; color: #555; font-size: 11px; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #333; }
  /* Toast notifications */
  .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column-reverse; gap: 8px; }
  .toast { background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px 16px; font-size: 12px; color: #e0e0e0; min-width: 280px; max-width: 380px; animation: slideIn 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; }
  .toast.success { border-color: #4caf50; }
  .toast.error { border-color: #f44336; }
  .toast.warning { border-color: #ff9800; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  /* Job detail modal */
  .detail-panel { max-width: 640px; width: 95%; max-height: 80vh; overflow-y: auto; }
  .detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #1a1a1a; font-size: 12px; }
  .detail-row .label { color: #666; }
  .detail-row .value { color: #e0e0e0; }
  /* Analytics charts */
  .chart-bar { display: flex; align-items: flex-end; gap: 4px; height: 120px; padding: 4px 0; }
  .chart-col { flex: 1; min-width: 16px; background: linear-gradient(180deg, #ff3333, #ff5555); border-radius: 3px 3px 0 0; position: relative; transition: height 0.4s ease; }
  .chart-col:hover { opacity: 0.8; }
  .chart-col .chart-label { position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); font-size: 8px; color: #555; white-space: nowrap; }
  .chart-col .chart-val { position: absolute; top: -16px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #aaa; white-space: nowrap; }
  /* Pricing cards */
  .pricing-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 16px; text-align: center; transition: border-color 0.2s; }
  .pricing-card:hover { border-color: #ff3333; }
  .pricing-card h3 { color: #ff3333; margin: 0 0 4px; font-size: 15px; }
  .pricing-card .discount { font-size: 28px; font-weight: bold; color: #4caf50; margin: 8px 0; }
  .pricing-card .period { font-size: 12px; color: #888; margin-bottom: 8px; }
  .pricing-card .detail { font-size: 11px; color: #666; }
  /* Admin panel */
  .admin-toggle { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #1a1a1a; }
  .admin-toggle label { font-size: 12px; color: #aaa; flex: 1; }
  .switch { position: relative; width: 36px; height: 20px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 20px; transition: 0.3s; }
  .switch .slider::before { content: ''; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: 0.3s; }
  .switch input:checked + .slider { background: #4caf50; }
  .switch input:checked + .slider::before { transform: translateX(16px); background: #fff; }
  .badge-verified { background: #0a2e0a; color: #4caf50; }
  .badge-unverified { background: #2e2e0a; color: #ff9800; }
  .badge-deverified { background: #2e0a0a; color: #f44336; }
  .fund-highlight { color: #4caf50; font-weight: bold; }
  .tab-bar { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
  .tab-btn { background: #1a1a1a; border: 1px solid #333; color: #888; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; }
  .tab-btn.active { background: #ff3333; color: #fff; border-color: #ff3333; }
  /* Gauge bars for GPU telemetry */
  .gauge-bar { height: 16px; background: #1a1a1a; border-radius: 3px; overflow: hidden; margin: 2px 0; position: relative; }
  .gauge-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .gauge-fill.util { background: linear-gradient(90deg, #4caf50, #ff9800, #f44336); }
  .gauge-fill.temp { background: linear-gradient(90deg, #2196f3, #ff9800, #f44336); }
  .gauge-fill.mem { background: linear-gradient(90deg, #64b5f6, #ce93d8); }
  .gauge-label { position: absolute; top: 0; left: 4px; font-size: 10px; color: #fff; line-height: 16px; }
  .gauge-val { position: absolute; top: 0; right: 4px; font-size: 10px; color: #ccc; line-height: 16px; }
  /* Province badges */
  .prov-badge { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; background: #1a1a2e; color: #90caf9; margin-left: 2px; }
  /* Status pending */
  .status-pending { background: #2e2e0a; color: #ff9800; }
  /* Admitted badge */
  .badge-admitted { background: #0a2e0a; color: #4caf50; }
  .badge-not-admitted { background: #2e0a0a; color: #f44336; }
  /* Forms */
  .form-group { margin-bottom: 10px; }
  .form-group label { display: block; font-size: 11px; color: #888; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
  .form-group input, .form-group select, .form-group textarea { background: #1a1a1a; color: #e0e0e0; border: 1px solid #333; padding: 7px 10px; border-radius: 4px; font-family: inherit; font-size: 12px; width: 100%; transition: border-color 0.2s; }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #ff3333; outline: none; box-shadow: 0 0 0 2px rgba(255,51,51,0.15); }
  .form-group input::placeholder { color: #555; }
  .form-group .hint { font-size: 10px; color: #555; margin-top: 2px; }
  .form-group .required::after { content: ' *'; color: #ff3333; }
  .form-group.error input, .form-group.error select { border-color: #f44336; }
  .form-group.error .hint { color: #f44336; }
  .form-row { display: flex; gap: 10px; }
  .form-row .form-group { flex: 1; }
  .form-section { border-top: 1px solid #222; margin-top: 14px; padding-top: 10px; }
  .form-section-title { font-size: 11px; color: #ff3333; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
  .estimate-box { background: #0a1a0a; border: 1px solid #1a3a1a; border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: #4caf50; }
  .estimate-box .est-label { color: #666; font-size: 10px; text-transform: uppercase; }
  .estimate-box .est-value { font-size: 18px; font-weight: bold; margin: 2px 0; }
  /* Modal */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
  .modal-overlay.active { display: flex; }
  .modal { background: #111; border: 1px solid #333; border-radius: 8px; padding: 32px; max-width: 420px; width: 90%; text-align: center; }
  .modal h2 { color: #ff3333; margin-bottom: 12px; }
  .modal p { color: #aaa; font-size: 13px; margin-bottom: 20px; }
  .modal .btn { margin: 4px; padding: 10px 24px; }
  .btn-secondary { background: #333; color: #e0e0e0; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; }
  .btn-secondary:hover { background: #444; }
  .btn-danger { background: #f44336; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; }
  .btn-danger:hover { background: #d32f2f; }
  /* Host detail modal */
  .host-detail-panel { max-width: 720px; width: 96%; max-height: 85vh; overflow-y: auto; }
  .host-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0; }
  .host-stat { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 4px; padding: 10px; text-align: center; }
  .host-stat .hs-val { font-size: 22px; font-weight: bold; color: #ff3333; }
  .host-stat .hs-label { font-size: 10px; color: #666; text-transform: uppercase; margin-top: 2px; }
  /* Severity colors for event log */
  .sev-info { color: #2196f3; }
  .sev-warning { color: #ff9800; }
  .sev-error { color: #f44336; }
  .sev-critical { color: #f44336; font-weight: bold; text-shadow: 0 0 4px rgba(244,67,54,0.4); }
  .sev-badge { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 9px; font-weight: bold; text-transform: uppercase; }
  .sev-badge.info { background: #0a1a2e; color: #2196f3; }
  .sev-badge.warning { background: #2e2e0a; color: #ff9800; }
  .sev-badge.error { background: #2e0a0a; color: #f44336; }
  .sev-badge.critical { background: #2e0a0a; color: #ff3333; border: 1px solid #f44336; }
  /* Compliance matrix */
  .compliance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px; }
  .compliance-cell { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 4px; padding: 8px; text-align: center; font-size: 11px; }
  .compliance-cell .prov-name { font-weight: bold; color: #90caf9; margin-bottom: 2px; }
  .compliance-cell .prov-status { color: #4caf50; font-size: 10px; }
  /* Detail tabs inside modals */
  .detail-tabs { display: flex; gap: 2px; margin-bottom: 12px; border-bottom: 1px solid #222; }
  .detail-tab { padding: 6px 12px; font-size: 11px; color: #888; cursor: pointer; border-bottom: 2px solid transparent; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
  .detail-tab.active { color: #ff3333; border-bottom-color: #ff3333; }
  .detail-tab:hover { color: #e0e0e0; }
  /* Filter bar */
  .filter-bar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
  .filter-bar select, .filter-bar input { background: #1a1a1a; color: #e0e0e0; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; font-family: inherit; font-size: 11px; }
  /* Collapsible sections */
  .collapsible-header { cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 0; font-size: 12px; color: #ff3333; text-transform: uppercase; }
  .collapsible-header::before { content: '‚ñ∏'; transition: transform 0.2s; }
  .collapsible-header.open::before { transform: rotate(90deg); }
  .collapsible-body { display: none; padding: 8px 0; }
  .collapsible-body.open { display: block; }
  /* Log viewer in modal */
  .log-viewer { background: #0a0a0a; border: 1px solid #222; border-radius: 4px; padding: 8px; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; color: #888; }
  /* Tooltips */
  .tooltip-wrap { position: relative; display: inline-block; cursor: help; }
  .tooltip-wrap .tooltip-text { visibility: hidden; background: #222; color: #eee; text-align: center; border-radius: 4px; padding: 6px 10px; position: absolute; z-index: 999; bottom: 125%; left: 50%; transform: translateX(-50%); white-space: nowrap; font-size: 11px; opacity: 0; transition: opacity 0.2s; pointer-events: none; border: 1px solid #444; }
  .tooltip-wrap:hover .tooltip-text { visibility: visible; opacity: 1; }
  /* SLA status cards */
  .sla-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
  .sla-card { background: #161616; border: 1px solid #2a2a2a; border-radius: 6px; padding: 12px 16px; }
  .sla-card .sla-host { font-weight: bold; color: #90caf9; font-size: 13px; }
  .sla-card .sla-uptime { font-size: 22px; font-weight: bold; }
  .sla-card .sla-uptime.ok { color: #4caf50; }
  .sla-card .sla-uptime.warn { color: #ff9800; }
  .sla-card .sla-uptime.crit { color: #f44336; }
  .sla-card .sla-meta { font-size: 11px; color: #777; margin-top: 4px; }
  /* Invoice table */
  .inv-status { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; }
  .inv-paid { background: #1b3a1b; color: #4caf50; }
  .inv-pending { background: #3a3a1b; color: #ff9800; }
  /* Progress bar for running jobs */
  .job-progress { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; color: #aaa; }
  .job-progress-bar { width: 60px; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
  .job-progress-fill { height: 100%; background: #4caf50; border-radius: 3px; transition: width 0.5s; }
  /* Session timeout modal overlay */
  .session-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; }
  .session-modal { background: #1e1e1e; border: 1px solid #444; border-radius: 8px; padding: 24px 32px; text-align: center; max-width: 380px; }
  .session-modal h3 { color: #ff9800; margin-bottom: 12px; }
  .session-modal p { color: #aaa; font-size: 13px; margin-bottom: 16px; }
  /* Low balance banner */
  .low-balance-banner { background: #3a2a0a; border: 1px solid #ff9800; border-radius: 4px; padding: 8px 16px; margin-bottom: 8px; font-size: 12px; color: #ff9800; display: none; }
  /* Transaction type filter pills */
  .txn-filter-bar { display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; }
  .txn-pill { padding: 3px 10px; border-radius: 12px; font-size: 10px; cursor: pointer; border: 1px solid #333; background: #1a1a1a; color: #aaa; transition: all 0.2s; }
  .txn-pill.active { background: #333; color: #eee; border-color: #555; }
  .txn-pill:hover { border-color: #555; }
  /* Event detail expansion */
  .event-row { cursor: pointer; transition: background 0.15s; }
  .event-row:hover { background: #1a1a1a; }
  .event-detail { display: none; padding: 6px 12px; background: #0d0d0d; border-left: 2px solid #333; font-size: 11px; color: #888; margin: 2px 0 4px 0; border-radius: 0 0 4px 4px; }
  .event-detail.open { display: block; }
  /* Team/org management */
  .team-card { background: #161616; border: 1px solid #2a2a2a; border-radius: 6px; padding: 14px 18px; margin-bottom: 10px; }
  .team-card .team-name { font-size: 15px; font-weight: bold; color: #ff3333; margin-bottom: 4px; }
  .team-card .team-meta { font-size: 11px; color: #777; }
  .team-member-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #1a1a1a; font-size: 12px; }
  .team-member-row .tm-email { color: #90caf9; }
  .team-member-row .tm-role { color: #999; font-size: 10px; text-transform: uppercase; }
  .team-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; background: #1a1a2e; color: #7c4dff; }
  /* Provider detail panel */
  .provider-panel { background: #0a0a0a; border: 1px solid #222; border-radius: 6px; padding: 16px; margin-bottom: 12px; }
  .provider-panel .pp-title { font-size: 13px; font-weight: bold; color: #ff3333; margin-bottom: 8px; text-transform: uppercase; }
  .provider-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
  .provider-stat { background: #111; border: 1px solid #1a1a1a; border-radius: 4px; padding: 8px; text-align: center; }
  .provider-stat .ps-val { font-size: 18px; font-weight: bold; color: #4caf50; }
  .provider-stat .ps-label { font-size: 10px; color: #666; text-transform: uppercase; margin-top: 2px; }
  /* Notification preferences */
  .notif-grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  .notif-item { font-size: 12px; color: #ccc; padding: 6px 0; border-bottom: 1px solid #1a1a1a; }
  .notif-item label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
  .notif-toggle { width: 36px; height: 18px; background: #333; border-radius: 9px; position: relative; cursor: pointer; transition: background 0.2s; -webkit-appearance: none; appearance: none; }
  .notif-toggle:checked { background: #4caf50; }
  .notif-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: #eee; border-radius: 50%; transition: transform 0.2s; }
  .notif-toggle:checked::after { transform: translateX(18px); }
  /* Privacy consent */
  .consent-card { background: #161616; border: 1px solid #222; border-radius: 6px; padding: 12px; margin-bottom: 8px; }
  .consent-card .cc-title { font-size: 12px; font-weight: bold; color: #e0e0e0; margin-bottom: 4px; }
  .consent-card .cc-desc { font-size: 11px; color: #888; margin-bottom: 8px; }
  .retention-table { font-size: 11px; }
  .retention-table td { padding: 3px 8px; }
  .retention-table .rt-cat { color: #90caf9; }
  .retention-table .rt-ttl { color: #aaa; }
  /* Slurm HPC tab */
  .slurm-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .slurm-form .form-group { display: flex; flex-direction: column; gap: 4px; }
  .slurm-form .form-group.full { grid-column: 1 / -1; }
  .slurm-form label { font-size: 11px; color: #888; text-transform: uppercase; }
  .slurm-form input, .slurm-form select { background: #0a0a0a; border: 1px solid #333; color: #e0e0e0; padding: 6px 8px; border-radius: 4px; font-family: inherit; font-size: 12px; }
  .cluster-card { background: #161616; border: 1px solid #2a2a2a; border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; transition: border-color 0.2s; }
  .cluster-card:hover, .cluster-card.selected { border-color: #ff3333; }
  .cluster-card .cc-name { font-size: 14px; font-weight: bold; color: #ff3333; }
  .cluster-card .cc-desc { font-size: 11px; color: #888; margin-top: 4px; }
  .slurm-job-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid #1a1a1a; font-size: 12px; }
  .slurm-job-row:hover { background: #161616; }
  .slurm-script-preview { background: #050505; border: 1px solid #222; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 11px; color: #4caf50; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
  .spot-bid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .spot-bid-form .form-group { display: flex; flex-direction: column; gap: 4px; }
  .spot-bid-form label { font-size: 11px; color: #888; text-transform: uppercase; }
  .spot-bid-form input, .spot-bid-form select { background: #0a0a0a; border: 1px solid #333; color: #e0e0e0; padding: 6px 8px; border-radius: 4px; font-family: inherit; font-size: 12px; }
  .sla-credit-table { font-size: 12px; }
  .sla-credit-table th { color: #ff3333; font-size: 11px; text-transform: uppercase; }
  .sla-credit-table td.pct-good { color: #4caf50; }
  .sla-credit-table td.pct-warn { color: #ff9800; }
  .sla-credit-table td.pct-bad { color: #f44336; }
  .residency-trace-panel { background: #0a0a0a; border: 1px solid #222; border-radius: 6px; padding: 14px; font-size: 12px; }
  .residency-trace-panel .rt-field { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #1a1a1a; }
  .residency-trace-panel .rt-label { color: #888; }
  .residency-trace-panel .rt-value { color: #e0e0e0; font-weight: bold; }
  /* Responsive design */
  @media (max-width: 1024px) {
    .grid { grid-template-columns: 1fr; }
    .stat-row { flex-wrap: wrap; }
    .stat { min-width: 100px; flex: 1 1 calc(50% - 8px); }
    .slurm-form { grid-template-columns: 1fr; }
    .spot-bid-form { grid-template-columns: 1fr; }
  }
  @media (max-width: 768px) {
    body { padding: 8px; }
    h1 { font-size: 20px; }
    .tab-bar { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding-bottom: 4px; }
    .tab-bar::-webkit-scrollbar { display: none; }
    .tab-btn { font-size: 11px; padding: 6px 10px; flex-shrink: 0; }
    .grid { grid-template-columns: 1fr; gap: 10px; }
    .card { padding: 10px; }
    .stat-row { gap: 8px; }
    .stat { min-width: 80px; flex: 1 1 calc(50% - 4px); }
    .stat .num { font-size: 22px; }
    .stat .label { font-size: 10px; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
    .user-bar { flex-direction: column; gap: 8px; align-items: flex-start !important; }
    .user-bar .right { flex-wrap: wrap; gap: 6px; }
    .btn-row { flex-wrap: wrap; }
    .btn { font-size: 11px; padding: 5px 10px; }
    .slurm-form { grid-template-columns: 1fr; }
    .spot-bid-form { grid-template-columns: 1fr; }
    .provider-stats { grid-template-columns: 1fr 1fr; }
    .notif-grid { grid-template-columns: 1fr auto; }
    /* Mobile-friendly modals */
    .modal-content { width: 95% !important; max-height: 85vh; overflow-y: auto; margin: 5vh auto !important; }
    .login-card { width: 95%; padding: 20px; }
    /* Cluster cards stack */
    .cluster-grid { grid-template-columns: 1fr !important; }
  }
  @media (max-width: 480px) {
    body { padding: 4px; }
    .stat { flex: 1 1 100%; }
    .btn-row { flex-direction: column; }
    .btn { width: 100%; text-align: center; }
    .tab-btn { font-size: 10px; padding: 5px 8px; }
  }

  /* ‚îÄ‚îÄ Loading Skeletons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  @keyframes skeleton-pulse {
    0% { opacity: 0.15; }
    50% { opacity: 0.3; }
    100% { opacity: 0.15; }
  }
  .skeleton-block {
    background: linear-gradient(90deg, #1a1a1a 25%, #222 50%, #1a1a1a 75%);
    background-size: 200% 100%;
    animation: skeleton-pulse 1.5s ease-in-out infinite;
    border-radius: 4px;
    min-height: 16px;
  }
  .skeleton-line { height: 12px; margin-bottom: 8px; border-radius: 3px; }
  .skeleton-row { display: flex; gap: 8px; margin-bottom: 8px; }
  .skeleton-row .skeleton-block { flex: 1; height: 14px; }

  /* ‚îÄ‚îÄ Empty States ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .empty-state {
    text-align: center; padding: 32px 16px; color: #555;
  }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
  .empty-state .empty-title { font-size: 14px; color: #888; margin-bottom: 4px; }
  .empty-state .empty-desc { font-size: 12px; color: #555; }

  /* ‚îÄ‚îÄ Score Breakdown Bars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .breakdown-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; }
  .breakdown-bar .bar-label { width: 100px; color: #888; text-align: right; flex-shrink: 0; }
  .breakdown-bar .bar-track { flex: 1; height: 14px; background: #1a1a1a; border-radius: 3px; overflow: hidden; }
  .breakdown-bar .bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .breakdown-bar .bar-value { width: 50px; color: #aaa; font-size: 11px; }
  .bar-fill.green { background: linear-gradient(90deg, #1b5e20, #4caf50); }
  .bar-fill.blue { background: linear-gradient(90deg, #0d47a1, #2196f3); }
  .bar-fill.red { background: linear-gradient(90deg, #b71c1c, #f44336); }
  .bar-fill.amber { background: linear-gradient(90deg, #e65100, #ff9800); }

  /* ‚îÄ‚îÄ Expiry Badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .expiry-badge { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; }
  .expiry-ok { background: #0a2e0a; color: #4caf50; }
  .expiry-warn { background: #2e2e0a; color: #ff9800; }
  .expiry-crit { background: #2e0a0a; color: #f44336; }

  /* ‚îÄ‚îÄ Profile Avatar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .profile-avatar-wrap { position: relative; }
  .profile-avatar-wrap .avatar-edit { display: none; position: absolute; bottom: 0; right: 0; background: #333; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 10px; cursor: pointer; }
  .profile-avatar-wrap:hover .avatar-edit { display: block; }

  /* ‚îÄ‚îÄ Notification sound toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .sound-toggle { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .sound-toggle label { font-size: 12px; color: #888; }
</style>
</head>
<body>

<!-- Login Page -->
<div id="login-page" class="login-page">
  <div class="login-card">
    <h2>XCELSIOR</h2>
    <p class="login-subtitle">Distributed Canadian GPU Compute ‚Äî Ever Upward</p>
    <button class="oauth-btn" onclick="oauthLogin('google')">
      <svg viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Sign in with Google
    </button>
    <button class="oauth-btn" onclick="oauthLogin('github')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      Sign in with GitHub
    </button>
    <button class="oauth-btn" onclick="oauthLogin('huggingface')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-1.5 14.5c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5 2.5 1.119 2.5 2.5-1.119 2.5-2.5 2.5zm5 0c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5 2.5 1.119 2.5 2.5-1.119 2.5-2.5 2.5z"/></svg>
      Sign in with Hugging Face
    </button>
    <div class="divider">or continue with email</div>
    <div class="form-group"><input id="login-email" type="email" placeholder="you@example.com"></div>
    <div class="form-group"><input id="login-password" type="password" placeholder="Password"></div>
    <button class="btn" onclick="emailLogin()" style="width:100%;padding:10px;margin-top:4px">Sign In</button>
    <p style="text-align:center;margin-top:8px;font-size:11px"><a href="#" onclick="showForgotPassword()" style="color:#888">Forgot your password?</a></p>
    <p style="text-align:center;margin-top:8px;font-size:11px;color:#666">Don't have an account? <a href="#" onclick="toggleSignup()" style="color:#ff3333">Sign up</a></p>
    <p style="text-align:center;margin-top:4px;font-size:11px"><a href="#" onclick="skipLogin()" style="color:#555">Continue without login (dev mode)</a></p>
    <!-- Password Reset Form (hidden by default) -->
    <div id="forgot-password-form" style="display:none;margin-top:16px;border-top:1px solid #222;padding-top:16px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">Enter your email to receive a password reset link.</p>
      <div class="form-group"><input id="reset-email" type="email" placeholder="you@example.com"></div>
      <button class="btn" onclick="requestPasswordReset()" style="width:100%;padding:10px;background:#ff9800">Send Reset Link</button>
      <p style="text-align:center;margin-top:8px;font-size:11px"><a href="#" onclick="hideForgotPassword()" style="color:#888">‚Üê Back to login</a></p>
    </div>
    <!-- Reset Confirm Form (hidden by default) -->
    <div id="reset-confirm-form" style="display:none;margin-top:16px;border-top:1px solid #222;padding-top:16px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">Enter your reset token and new password.</p>
      <div class="form-group"><input id="reset-token" placeholder="Paste your reset token"></div>
      <div class="form-group"><input id="reset-new-password" type="password" placeholder="New password (min 8 characters)"></div>
      <button class="btn" onclick="confirmPasswordReset()" style="width:100%;padding:10px;background:#4caf50">Set New Password</button>
      <p style="text-align:center;margin-top:8px;font-size:11px"><a href="#" onclick="hideForgotPassword()" style="color:#888">‚Üê Back to login</a></p>
    </div>
  </div>
</div>

<!-- Main App (hidden until login) -->
<div id="main-app">

<!-- User Navbar -->
<div class="user-bar">
  <div class="left">
    <h1 style="margin:0">XCELSIOR</h1>
    <span class="subtitle" style="margin:0">v2.8.0 <span id="sse-status" style="color:#666">‚ö™ connecting...</span></span>
  </div>
  <div class="right">
    <div class="wallet-display">
      <span>üí∞</span>
      <span class="amount" id="wallet-balance">$‚Äî</span>
      <button class="btn" style="padding:2px 8px;font-size:10px;margin-left:4px" onclick="showDepositModal()">+ Add</button>
    </div>
    <div class="user-menu">
      <div class="user-avatar" id="user-avatar" onclick="toggleUserMenu()">?</div>
      <div class="user-dropdown" id="user-dropdown">
        <a href="#" onclick="showTab('settings');closeUserMenu()">‚öôÔ∏è Settings</a>
        <a href="#" onclick="showTab('settings');closeUserMenu()">üîë API Keys</a>
        <a href="#" onclick="showTab('reputation-tab');closeUserMenu()">üèÜ My Reputation</a>
        <a href="#" onclick="showTab('billing-tab');closeUserMenu()">üí≥ Billing</a>
        <a href="#" onclick="doLogout()" style="color:#f44336">üö™ Sign Out</a>
      </div>
    </div>
  </div>
</div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('overview')">Overview</button>
  <button class="tab-btn" onclick="showTab('telemetry')">GPU Telemetry</button>
  <button class="tab-btn" onclick="showTab('trust')">Trust & Verification</button>
  <button class="tab-btn" onclick="showTab('billing-tab')">Billing & Fund</button>
  <button class="tab-btn" onclick="showTab('earnings')">My Earnings</button>
  <button class="tab-btn" onclick="showTab('reputation-tab')">Reputation</button>
  <button class="tab-btn" onclick="showTab('job-logs')">Job Logs</button>
  <button class="tab-btn" onclick="showTab('analytics')">üìä Analytics</button>
  <button class="tab-btn" onclick="showTab('artifacts')">üì¶ Artifacts</button>
  <button class="tab-btn" onclick="showTab('slurm')">üñ•Ô∏è HPC/Slurm</button>
  <button class="tab-btn" onclick="showTab('admin')" id="admin-tab-btn" style="display:none">üîß Admin</button>
  <button class="tab-btn" onclick="showTab('logs')">Event Log</button>
  <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
</div>

<div id="low-balance-banner" class="low-balance-banner">‚ö†Ô∏è Low balance! Your wallet is below $5.00. <a href="#" onclick="showDepositModal()" style="color:#ff9800;text-decoration:underline">Add credits now</a> to avoid job failures.</div>

<div class="btn-row">
  <button class="btn" onclick="refresh()">Refresh</button>
  <button class="btn" onclick="processQueue()">Process Queue</button>
  <button class="btn" onclick="processQueueSovereign()">üçÅ Sovereign Queue</button>
  <button class="btn" onclick="billAll()">Bill All</button>
  <button class="btn" onclick="pingHosts()">Ping Hosts</button>
  <button class="btn" onclick="runFailover()">Failover</button>
  <button class="btn" onclick="runAutoscale()">Autoscale</button>
  <button class="btn" onclick="showAddHostForm()" style="background:#4caf50">+ Add Host</button>
  <button class="btn" onclick="showSubmitJobForm()" style="background:#2196f3">+ Submit Job</button>
  <button class="btn" onclick="showProviderRegForm()" style="background:#ff9800">üè¢ Register Provider</button>
  <button class="btn btn-secondary" onclick="exportRebateDocs()">üìÑ Export Rebate Docs</button>
</div>

<div id="tab-overview">
<div class="stat-row">
  <div class="stat"><div class="num" id="stat-hosts">-</div><div class="label">Active Hosts</div></div>
  <div class="stat"><div class="num" id="stat-jobs">-</div><div class="label">Total Jobs</div></div>
  <div class="stat"><div class="num" id="stat-running">-</div><div class="label">Running</div></div>
  <div class="stat"><div class="num" id="stat-queued">-</div><div class="label">Queued</div></div>
  <div class="stat"><div class="num" id="stat-revenue">-</div><div class="label">Revenue</div></div>
  <div class="stat"><div class="num" id="stat-market">-</div><div class="label">Marketplace</div></div>
  <div class="stat"><div class="num" id="stat-pool">-</div><div class="label">Pool</div></div>
  <div class="stat"><div class="num" id="stat-spot">-</div><div class="label">Spot Listings</div></div>
</div>

<div class="grid">
  <div class="card">
    <h2>Hosts</h2>
    <table>
      <thead><tr><th>ID</th><th>IP</th><th>GPU</th><th>VRAM Free</th><th>$/hr</th><th>Location</th><th>Admitted</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="hosts-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Jobs</h2>
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>VRAM</th><th>Tier</th><th>Host</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="jobs-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Marketplace <span id="mkt-stats-badge" style="font-size:11px;color:#666;margin-left:8px"></span></h2>
    <div id="mkt-stats-summary" style="display:none;font-size:11px;color:#888;padding:4px 8px;margin-bottom:4px;background:#111;border-radius:3px">
      <span>Listings: <strong id="mkt-s-total">0</strong></span> ¬∑
      <span>Active: <strong id="mkt-s-active">0</strong></span> ¬∑
      <span>Avg $/hr: <strong id="mkt-s-avgprice">-</strong></span> ¬∑
      <span>Total VRAM: <strong id="mkt-s-vram">-</strong> GB</span>
    </div>
    <div class="filter-bar" style="margin-bottom:6px;padding:0 8px">
      <input id="mkt-search-gpu" placeholder="GPU model" style="width:100px">
      <input id="mkt-search-vram" type="number" placeholder="Min VRAM" style="width:80px" min="0">
      <input id="mkt-search-price" type="number" placeholder="Max $/hr" style="width:80px" min="0" step="0.01">
      <select id="mkt-search-prov" style="width:80px">
        <option value="">Province</option>
        <option value="ON">ON</option><option value="QC">QC</option><option value="BC">BC</option>
        <option value="AB">AB</option><option value="SK">SK</option><option value="MB">MB</option>
      </select>
      <select id="mkt-search-sort" style="width:100px">
        <option value="price">Sort: Price</option>
        <option value="vram">Sort: VRAM</option>
        <option value="reputation">Sort: Rep</option>
        <option value="score">Sort: Score</option>
      </select>
      <button class="btn btn-secondary" onclick="searchMarketplace()" style="font-size:10px;padding:3px 8px">üîç Search</button>
    </div>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>VRAM</th><th>$/hr</th><th>Owner</th><th>Jobs</th><th>Earned</th></tr></thead>
      <tbody id="market-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Autoscale Pool</h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>VRAM</th><th>$/hr</th><th>Country</th><th>Status</th></tr></thead>
      <tbody id="pool-table"></tbody>
    </table>
  </div>
  <div class="card full">
    <h2>Billing</h2>
    <table>
      <thead><tr><th>Job</th><th>Name</th><th>Host</th><th>Tier</th><th>Duration</th><th>Rate</th><th>Cost</th></tr></thead>
      <tbody id="billing-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Spot Prices</h2>
    <table>
      <thead><tr><th>GPU Model</th><th>Spot $/hr</th><th>Supply</th><th>Demand</th></tr></thead>
      <tbody id="spot-table"></tbody>
    </table>
    <div style="margin-top:12px;padding-top:10px;border-top:1px solid #222">
      <h3 style="font-size:13px;color:#ff3333;margin-bottom:10px">üí∞ Place Spot Bid</h3>
      <div class="spot-bid-form">
        <div class="form-group">
          <label>Job Name</label>
          <input id="spot-bid-name" type="text" placeholder="spot-inference-run">
        </div>
        <div class="form-group">
          <label>VRAM (GB)</label>
          <input id="spot-bid-vram" type="number" value="16" min="1">
        </div>
        <div class="form-group">
          <label>Max Bid ($/hr)</label>
          <input id="spot-bid-max" type="number" value="0.50" min="0.01" step="0.01">
        </div>
        <div class="form-group">
          <label>Priority (0‚Äì10)</label>
          <input id="spot-bid-priority" type="number" value="5" min="0" max="10">
        </div>
      </div>
      <button class="btn" onclick="submitSpotBid()" style="margin-top:8px;width:100%;background:#ff9800">üíπ Submit Spot Bid</button>
    </div>
  </div>
  <div class="card">
    <h2>Compute Scores (XCU)</h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>XCU</th></tr></thead>
      <tbody id="score-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>üõ°Ô∏è SLA Credit Calculator</h2>
    <div style="padding:8px">
      <table class="sla-credit-table">
        <thead><tr><th>Uptime Range</th><th>Credit %</th><th>Example ($100/mo)</th></tr></thead>
        <tbody>
          <tr><td class="pct-good">99‚Äì100%</td><td>0%</td><td>$0.00</td></tr>
          <tr><td class="pct-good">95‚Äì99%</td><td class="pct-warn">10%</td><td>$10.00</td></tr>
          <tr><td class="pct-warn">90‚Äì95%</td><td class="pct-warn">25%</td><td>$25.00</td></tr>
          <tr><td class="pct-bad">&lt;90%</td><td class="pct-bad">100%</td><td>$100.00</td></tr>
        </tbody>
      </table>
      <div style="margin-top:10px;border-top:1px solid #222;padding-top:10px">
        <h3 style="font-size:12px;color:#ccc;margin-bottom:8px">SLA Host Summary</h3>
        <div id="sla-hosts-summary" style="max-height:200px;overflow-y:auto;font-size:12px;color:#aaa">
          <button class="btn btn-secondary" onclick="fetchSLAHostsSummary()" style="font-size:11px">‚Üª Load SLA Summary</button>
        </div>
      </div>
    </div>
  </div>
  <div class="card full">
    <h2>üìç Residency Trace</h2>
    <div style="padding:8px">
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="residency-trace-jobid" type="text" placeholder="Enter Job ID" style="flex:1;background:#0a0a0a;border:1px solid #333;color:#e0e0e0;padding:6px 8px;border-radius:4px;font-family:inherit;font-size:12px">
        <button class="btn" onclick="fetchResidencyTrace()">üîç Trace</button>
      </div>
      <div id="residency-trace-result" style="font-size:12px;color:#aaa">Enter a Job ID to view data residency compliance trace.</div>
    </div>
  </div>
  <div class="card full">
    <h2>Event Log <span style="font-size:11px;color:#666">(SSE live stream)</span></h2>
    <div id="event-log" style="max-height:200px;overflow-y:auto;font-size:12px;color:#888;"></div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Trust & Verification Tab ‚ïê‚ïê‚ïê -->
<div id="tab-trust" style="display:none">
<div class="stat-row">
  <div class="stat"><div class="num" id="stat-verified">-</div><div class="label">Verified Hosts</div></div>
  <div class="stat"><div class="num" id="stat-reputation-avg">-</div><div class="label">Avg Reputation</div></div>
  <div class="stat"><div class="num" id="stat-ca-hosts">-</div><div class="label">üçÅ Canadian Hosts</div></div>
</div>

<div class="grid">
  <div class="card full">
    <h2>Host Verification Status <span style="font-size:11px;color:#666">(admin approve/reject)</span></h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>Status</th><th>Score</th><th>Last Check</th><th>Location</th><th>Actions</th></tr></thead>
      <tbody id="verification-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Reputation Leaderboard</h2>
    <table>
      <thead><tr><th>Host</th><th>Score</th><th>Tier</th><th>Jobs</th><th>Reliability</th></tr></thead>
      <tbody id="reputation-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Transparency Report</h2>
    <div id="transparency-report" style="font-size:12px;color:#aaa;">Loading...</div>
  </div>
  <div class="card">
    <h2>Trust Tiers</h2>
    <table>
      <thead><tr><th>Tier</th><th>Pricing</th><th>Requirements</th></tr></thead>
      <tbody id="trust-tier-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Jurisdiction Overview</h2>
    <div id="jurisdiction-info" style="font-size:13px;color:#aaa;"></div>
  </div>
  <div class="card">
    <h2>SLA Targets</h2>
    <table>
      <thead><tr><th>Tier</th><th>Target Uptime</th><th>Description</th></tr></thead>
      <tbody id="sla-targets-table">
        <tr><td><span class="tier tier-standard">Community</span></td><td>99.0%</td><td>Best-effort availability</td></tr>
        <tr><td><span class="tier tier-premium">Secure</span></td><td>99.5%</td><td>Verified + monitored hosts</td></tr>
        <tr><td><span class="tier tier-urgent">Sovereign</span></td><td>99.9%</td><td>Canada-only + compliance</td></tr>
      </tbody>
    </table>
    <div style="margin-top:8px">
      <button class="btn btn-secondary" onclick="fetchSLATargets()" style="font-size:10px;padding:2px 8px">‚Üª Refresh SLA Data</button>
    </div>
  </div>
  <div class="card full">
    <h2>üì° Per-Host SLA Status</h2>
    <div style="margin-bottom:8px">
      <button class="btn btn-secondary" onclick="fetchSLAHostCards()" style="font-size:11px">‚Üª Refresh Host SLA</button>
    </div>
    <div id="sla-host-cards" class="sla-card-grid">
      <div style="color:#555;font-size:12px;text-align:center;padding:16px">Click refresh to load per-host SLA status.</div>
    </div>
  </div>
  <div class="card">
    <h2>‚ö†Ô∏è SLA Violations</h2>
    <table>
      <thead><tr><th>Host</th><th>Type</th><th>Severity</th><th>Time</th><th>Details</th></tr></thead>
      <tbody id="sla-violations-table"><tr><td colspan="5" style="text-align:center;color:#555">No violations recorded</td></tr></tbody>
    </table>
  </div>
  <div class="card">
    <h2>üïê Active Downtimes</h2>
    <table>
      <thead><tr><th>Host</th><th>Started</th><th>Duration</th><th>Reason</th></tr></thead>
      <tbody id="sla-downtimes-table"><tr><td colspan="4" style="text-align:center;color:#555">No active downtimes</td></tr></tbody>
    </table>
    <button class="btn btn-secondary" onclick="fetchSLADowntimes()" style="font-size:10px;margin-top:4px">‚Üª Refresh</button>
  </div>
  <div class="card full">
    <h2>üìã Compliance Dashboard</h2>
    <div style="padding:8px">
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="fetchComplianceData()" style="font-size:11px">‚Üª Refresh Compliance</button>
        <button class="btn btn-secondary" onclick="runQuebecPIA()" style="font-size:11px">üîç Quebec PIA Check</button>
      </div>
      <div style="margin-bottom:16px">
        <h3 style="font-size:12px;color:#ff3333;margin-bottom:8px;text-transform:uppercase">Province Compliance Matrix</h3>
        <div id="compliance-provinces" class="compliance-grid" style="min-height:40px;font-size:12px;color:#666">Click refresh to load compliance data.</div>
      </div>
      <div style="margin-bottom:16px">
        <h3 style="font-size:12px;color:#ff3333;margin-bottom:8px;text-transform:uppercase">Tax Rates by Province</h3>
        <table>
          <thead><tr><th>Province</th><th>GST</th><th>PST/HST</th><th>Total</th><th>Type</th></tr></thead>
          <tbody id="compliance-tax-table"><tr><td colspan="5" style="text-align:center;color:#555">Loading...</td></tr></tbody>
        </table>
      </div>
      <div>
        <h3 style="font-size:12px;color:#ff3333;margin-bottom:8px;text-transform:uppercase">Trust Tier Requirements</h3>
        <table>
          <thead><tr><th>Tier</th><th>Checks Required</th><th>Min Score</th><th>Features</th></tr></thead>
          <tbody id="compliance-tier-req-table"><tr><td colspan="4" style="text-align:center;color:#555">Loading...</td></tr></tbody>
        </table>
      </div>
      <div id="quebec-pia-result" style="display:none;margin-top:12px;background:#0a1a0a;border:1px solid #1a3a1a;border-radius:4px;padding:12px;font-size:12px"></div>
      <div style="margin-top:16px">
        <h3 style="font-size:12px;color:#ff3333;margin-bottom:8px;text-transform:uppercase">GST Registration Threshold</h3>
        <div id="gst-threshold-display" style="min-height:40px;font-size:12px;color:#666">Click refresh to load GST data.</div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Billing & Fund Tab ‚ïê‚ïê‚ïê -->
<div id="tab-billing-tab" style="display:none">
<div class="stat-row">
  <div class="stat"><div class="num fund-highlight" id="stat-fund-eligible">-</div><div class="label">Fund Eligible (CAD)</div></div>
  <div class="stat"><div class="num" id="stat-ca-compute">-</div><div class="label">üçÅ CA Compute (CAD)</div></div>
  <div class="stat"><div class="num" id="stat-effective-cost">-</div><div class="label">Effective Cost (CAD)</div></div>
</div>

<div class="grid">
  <div class="card full">
    <h2>GPU Reference Pricing (CAD)</h2>
    <table>
      <thead><tr><th>GPU</th><th>Base $/hr</th><th>Subsidized</th><th>Premium</th><th>Min</th><th>Max</th></tr></thead>
      <tbody id="pricing-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Cost Estimator</h2>
    <div style="padding:8px">
      <select id="est-gpu" style="background:#1a1a1a;color:#e0e0e0;border:1px solid #333;padding:4px;font-family:inherit;">
        <option>RTX 3090</option><option selected>RTX 4090</option><option>A100</option><option>H100</option>
      </select>
      <input id="est-hours" type="number" value="1" min="0.1" step="0.5" style="width:60px;background:#1a1a1a;color:#e0e0e0;border:1px solid #333;padding:4px;font-family:inherit;"> hrs
      <label style="font-size:12px"><input type="checkbox" id="est-spot"> Spot</label>
      <label style="font-size:12px"><input type="checkbox" id="est-sov" checked> üçÅ Canada</label>
      <button class="btn" onclick="estimateCost()" style="margin-left:8px">Estimate</button>
      <div id="est-result" style="margin-top:8px;font-size:13px;color:#aaa;"></div>
    </div>
  </div>
  <div class="card">
    <h2>Provider Attestation</h2>
    <div id="attestation-info" style="font-size:13px;color:#aaa;"></div>
  </div>
  <div class="card">
    <h2>Reserved Pricing Plans</h2>
    <div id="reserved-plans" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:8px">
      <div class="pricing-card">
        <h3>1 Month</h3>
        <div class="discount">20% off</div>
        <div class="period">Monthly commitment</div>
        <div class="detail">Min 4 hrs/day usage</div>
        <button class="btn" onclick="reservePlan('1_month')" style="margin-top:8px;width:100%">Subscribe</button>
      </div>
      <div class="pricing-card" style="border-color:#ff3333">
        <h3>3 Months</h3>
        <div class="discount">30% off</div>
        <div class="period">Quarterly commitment</div>
        <div class="detail">Min 4 hrs/day usage</div>
        <button class="btn" onclick="reservePlan('3_month')" style="margin-top:8px;width:100%">Subscribe</button>
      </div>
      <div class="pricing-card">
        <h3>1 Year</h3>
        <div class="discount">45% off</div>
        <div class="period">Annual commitment</div>
        <div class="detail">No minimum usage</div>
        <button class="btn" onclick="reservePlan('1_year')" style="margin-top:8px;width:100%">Subscribe</button>
      </div>
    </div>
  </div>
  <div class="card full">
    <h2>Transaction History</h2>
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px;padding:0 8px">
      <div class="txn-filter-bar" style="flex:1">
        <span class="txn-pill active" onclick="filterTransactions('all')" data-txn-type="all">All</span>
        <span class="txn-pill" onclick="filterTransactions('deposit')" data-txn-type="deposit">üí∞ Deposits</span>
        <span class="txn-pill" onclick="filterTransactions('charge')" data-txn-type="charge">üí∏ Charges</span>
        <span class="txn-pill" onclick="filterTransactions('refund')" data-txn-type="refund">‚Ü©Ô∏è Refunds</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center;font-size:11px;color:#888">
        <label>From</label>
        <input type="date" id="txn-date-from" style="background:#1a1a1a;border:1px solid #333;color:#eee;padding:3px 6px;border-radius:4px;font-size:11px;font-family:inherit">
        <label>To</label>
        <input type="date" id="txn-date-to" style="background:#1a1a1a;border:1px solid #333;color:#eee;padding:3px 6px;border-radius:4px;font-size:11px;font-family:inherit">
        <button class="btn btn-secondary" onclick="applyDateFilter()" style="font-size:10px;padding:3px 8px">Apply</button>
        <button class="btn btn-secondary" onclick="clearDateFilter()" style="font-size:10px;padding:3px 8px">Clear</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Balance After</th></tr></thead>
      <tbody id="txn-history-table"><tr><td colspan="4" style="text-align:center;color:#555">Loading...</td></tr></tbody>
    </table>
    <div style="text-align:center;margin-top:8px">
      <button class="btn btn-secondary" onclick="fetchTransactionHistoryFiltered()" style="font-size:11px">‚Üª Refresh</button>
      <button class="btn btn-secondary" onclick="exportTransactions()" style="font-size:11px;margin-left:4px">üì• Export CSV</button>
    </div>
  </div>
  <div class="card full">
    <h2>üìä Balance Trend</h2>
    <div id="balance-chart" style="min-height:60px;font-family:monospace;font-size:12px;color:#aaa;padding:8px">
      <div class="skeleton-block" style="height:60px"></div>
    </div>
  </div>
  <div class="card full">
    <h2>üìÑ Invoices</h2>
    <table>
      <thead><tr><th>Invoice #</th><th>Period</th><th>Subtotal</th><th>Tax</th><th>Total (CAD)</th><th>CAF Eligible</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="invoice-table"><tr><td colspan="8" style="text-align:center;color:#555">Loading...</td></tr></tbody>
    </table>
    <div style="text-align:center;margin-top:8px">
      <button class="btn btn-secondary" onclick="fetchInvoices()" style="font-size:11px">‚Üª Refresh Invoices</button>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê GPU Telemetry Tab ‚ïê‚ïê‚ïê -->
<div id="tab-telemetry" style="display:none">
<div class="stat-row">
  <div class="stat"><div class="num" id="stat-telem-hosts">-</div><div class="label">Reporting Hosts</div></div>
  <div class="stat"><div class="num" id="stat-avg-util">-</div><div class="label">Avg GPU Util</div></div>
  <div class="stat"><div class="num" id="stat-avg-temp">-</div><div class="label">Avg Temp ¬∞C</div></div>
  <div class="stat"><div class="num" id="stat-mem-errors">-</div><div class="label">Memory Errors</div></div>
</div>
<div class="grid">
  <div class="card full">
    <h2>Live GPU Metrics <span style="font-size:11px;color:#666">(auto-refresh 5s)</span></h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>Utilization</th><th>Temperature</th><th>Memory</th><th>Power</th><th>ECC Errors</th><th>Updated</th></tr></thead>
      <tbody id="telemetry-table"></tbody>
    </table>
    <div id="telemetry-empty" style="color:#555;padding:12px;text-align:center;display:none">No telemetry data ‚Äî hosts report metrics every 5 seconds when the worker agent is running.</div>
  </div>
  <div class="card">
    <h2>GPU Utilization Distribution</h2>
    <div id="util-histogram" style="min-height:80px;font-size:12px;color:#aaa;padding:8px;">Loading...</div>
  </div>
  <div class="card">
    <h2>Thermal Status</h2>
    <div id="thermal-summary" style="min-height:80px;font-size:12px;color:#aaa;padding:8px;">Loading...</div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê My Earnings Tab ‚ïê‚ïê‚ïê -->
<div id="tab-earnings" style="display:none">
<div class="stat-row">
  <div class="stat"><div class="num fund-highlight" id="stat-total-earned">-</div><div class="label">Total Earned (CAD)</div></div>
  <div class="stat"><div class="num" id="stat-pending-payout">-</div><div class="label">Pending Payout</div></div>
  <div class="stat"><div class="num" id="stat-total-payouts">-</div><div class="label">Completed Payouts</div></div>
  <div class="stat"><div class="num" id="stat-utilization-rate">-</div><div class="label">Utilization Rate</div></div>
</div>
<div class="grid">
  <div class="card full">
    <h2>Payout History</h2>
    <table>
      <thead><tr><th>Date</th><th>Provider</th><th>Amount (CAD)</th><th>Method</th><th>Status</th></tr></thead>
      <tbody id="payouts-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Earnings by Host</h2>
    <table>
      <thead><tr><th>Host</th><th>GPU</th><th>Jobs</th><th>Hours</th><th>Earned (CAD)</th></tr></thead>
      <tbody id="earnings-by-host-table"></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Earnings by Period</h2>
    <table>
      <thead><tr><th>Period</th><th>Revenue</th><th>Fund Rebate</th><th>Net</th></tr></thead>
      <tbody id="earnings-by-period-table"></tbody>
    </table>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Event Log Tab ‚ïê‚ïê‚ïê -->
<div id="tab-logs" style="display:none">
<div class="grid">
  <div class="card full">
    <h2>Full Event Stream</h2>
    <div class="filter-bar">
      <select id="log-severity-filter" onchange="filterEventLog()">
        <option value="all">All Severities</option>
        <option value="info">‚ÑπÔ∏è Info</option>
        <option value="warning">‚ö†Ô∏è Warning</option>
        <option value="error">‚ùå Error</option>
        <option value="critical">üî¥ Critical</option>
      </select>
      <select id="log-type-filter" onchange="filterEventLog()">
        <option value="all">All Types</option>
        <option value="host">Host Events</option>
        <option value="job">Job Events</option>
        <option value="billing">Billing Events</option>
        <option value="sla">SLA Events</option>
        <option value="auth">Auth Events</option>
        <option value="system">System Events</option>
      </select>
      <input id="log-search" placeholder="üîç Search events..." oninput="filterEventLog()" style="flex:1;min-width:160px">
      <button class="btn btn-secondary" onclick="clearEventLog()" style="font-size:10px;padding:3px 8px">Clear</button>
      <span id="log-count" style="font-size:10px;color:#555">0 events</span>
    </div>
    <div id="event-log-full" style="max-height:500px;overflow-y:auto;font-size:12px;color:#888;"></div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Per-Job Log Streaming Tab ‚ïê‚ïê‚ïê -->
<div id="tab-job-logs" style="display:none">
<div class="grid">
  <div class="card full">
    <h2>Job Log Streaming <span style="font-size:11px;color:#666">(SSE per-job tail)</span></h2>
    <div style="margin-bottom:10px">
      <input id="jl-job-id" placeholder="Enter Job ID" style="padding:6px 12px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:4px;font-family:inherit;width:280px">
      <button class="btn" onclick="startJobLogStream()" style="margin-left:6px">‚ñ∂ Stream Logs</button>
      <button class="btn btn-secondary" onclick="stopJobLogStream()" style="margin-left:4px">‚ñ† Stop</button>
      <span id="jl-status" style="margin-left:10px;font-size:11px;color:#666"></span>
    </div>
    <div id="job-log-output" style="max-height:500px;overflow-y:auto;font-size:12px;color:#888;font-family:'Courier New',monospace;background:#0a0a0a;padding:10px;border-radius:4px;border:1px solid #222;">Select a job and click Stream Logs to begin tailing.</div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Reputation Tab ‚ïê‚ïê‚ïê -->
<div id="tab-reputation-tab" style="display:none">
<div class="stat-row">
  <div class="stat"><div class="num" id="stat-my-score">‚Äî</div><div class="label">My Score</div></div>
  <div class="stat"><div class="num" id="stat-my-tier">‚Äî</div><div class="label">My Tier</div></div>
  <div class="stat"><div class="num" id="stat-my-jobs">‚Äî</div><div class="label">Jobs Completed</div></div>
  <div class="stat"><div class="num" id="stat-my-rank">‚Äî</div><div class="label">Rank</div></div>
</div>
<div class="grid">
  <div class="card">
    <h2>My Reputation</h2>
    <div id="my-reputation-detail" style="padding:12px">
      <div style="text-align:center;margin-bottom:16px">
        <div id="my-tier-badge" style="font-size:48px;margin-bottom:8px">üîò</div>
        <div id="my-tier-label" style="font-size:18px;font-weight:bold;color:#888">NEW USER</div>
        <div style="margin-top:8px">
          <div style="background:#1a1a1a;border-radius:8px;height:12px;overflow:hidden;margin:8px 0">
            <div id="score-progress" style="height:100%;background:linear-gradient(90deg,#ff3333,#ffd700);width:0%;border-radius:8px;transition:width 0.5s"></div>
          </div>
          <span id="score-label" style="font-size:11px;color:#666">0 / 100 points to next tier</span>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>Tier Benefits</h2>
    <table>
      <thead><tr><th>Tier</th><th>Badge</th><th>Search Boost</th><th>Max Premium</th><th>Commission</th></tr></thead>
      <tbody>
        <tr><td>New User</td><td><span class="tier-badge new-user">üîò New</span></td><td>0.8√ó</td><td>‚Äî</td><td>15%</td></tr>
        <tr><td>Bronze</td><td><span class="tier-badge bronze">ü•â Bronze</span></td><td>1.0√ó</td><td>5%</td><td>15%</td></tr>
        <tr><td>Silver</td><td><span class="tier-badge silver">ü•à Silver</span></td><td>1.2√ó</td><td>15%</td><td>15%</td></tr>
        <tr><td>Gold</td><td><span class="tier-badge gold">ü•á Gold</span></td><td>1.5√ó</td><td>25%</td><td>12%</td></tr>
        <tr><td>Platinum</td><td><span class="tier-badge platinum">üíé Platinum</span></td><td>1.8√ó</td><td>35%</td><td>10%</td></tr>
        <tr><td>Diamond</td><td><span class="tier-badge diamond">üëë Diamond</span></td><td>2.0√ó</td><td>50%</td><td>8%</td></tr>
      </tbody>
    </table>
  </div>
  <div class="card">
    <h2>Verification Badges</h2>
    <div id="verification-badges" style="padding:8px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div class="badge-row" style="display:flex;align-items:center;gap:6px"><span style="font-size:16px">üìß</span> <span style="font-size:12px;color:#666">Email Verified</span> <span class="badge badge-unverified" id="vb-email">unverified</span></div>
        <div class="badge-row" style="display:flex;align-items:center;gap:6px"><span style="font-size:16px">üì±</span> <span style="font-size:12px;color:#666">Phone Verified</span> <span class="badge badge-unverified" id="vb-phone">unverified</span></div>
        <div class="badge-row" style="display:flex;align-items:center;gap:6px"><span style="font-size:16px">üñ•Ô∏è</span> <span style="font-size:12px;color:#666">Hardware Audited</span> <span class="badge badge-unverified" id="vb-hardware">unverified</span></div>
        <div class="badge-row" style="display:flex;align-items:center;gap:6px"><span style="font-size:16px">üè¢</span> <span style="font-size:12px;color:#666">Data Center</span> <span class="badge badge-unverified" id="vb-datacenter">unverified</span></div>
        <div class="badge-row" style="display:flex;align-items:center;gap:6px"><span style="font-size:16px">üìã</span> <span style="font-size:12px;color:#666">Incorporated</span> <span class="badge badge-unverified" id="vb-incorporation">unverified</span></div>
        <div class="badge-row" style="display:flex;align-items:center;gap:6px"><span style="font-size:16px">ü™™</span> <span style="font-size:12px;color:#666">Government ID</span> <span class="badge badge-unverified" id="vb-govid">unverified</span></div>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>Score Breakdown</h2>
    <div id="score-breakdown" style="min-height:80px;padding:8px;">
      <div class="skeleton-block" style="height:120px"></div>
    </div>
  </div>
  <div class="card">
    <h2>Score History</h2>
    <div id="score-history" style="min-height:80px;font-size:12px;color:#aaa;padding:8px;">
      <div class="skeleton-block" style="height:80px"></div>
    </div>
  </div>
  <div class="card">
    <h2>üìà Reputation Trend</h2>
    <div id="rep-history-chart" style="min-height:60px;font-size:12px;color:#aaa;padding:8px;font-family:monospace">Loading history...</div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Settings Tab ‚ïê‚ïê‚ïê -->
<div id="tab-settings" style="display:none">
<div class="grid">
  <div class="card">
    <h2>Profile</h2>
    <div style="padding:8px">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
        <div id="profile-avatar" style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#ff3333,#ff6666);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:bold;color:#fff;flex-shrink:0">?</div>
        <div>
          <div id="profile-name-display" style="font-size:16px;font-weight:bold;color:#eee">‚Äî</div>
          <div id="profile-email-display" style="font-size:12px;color:#888;margin-top:2px">‚Äî</div>
          <div id="profile-member-since" style="font-size:11px;color:#555;margin-top:4px">Member since ‚Äî</div>
        </div>
      </div>
      <div class="form-group"><label>Display Name</label><input id="set-name" placeholder="Your name"></div>
      <div class="form-group"><label>Email</label><input id="set-email" type="email" placeholder="you@example.com" readonly style="opacity:0.6"></div>
      <div class="form-group"><label>Customer ID</label><input id="set-customer-id" readonly style="opacity:0.6"></div>
      <div class="form-group"><label>Provider ID</label><input id="set-provider-id" placeholder="Not registered as provider" readonly style="opacity:0.6"></div>
      <div class="form-group"><label>Role</label>
        <select id="set-role">
          <option value="submitter">Job Submitter</option>
          <option value="provider">GPU Provider</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Country</label>
          <select id="set-country"><option value="CA" selected>üçÅ Canada</option><option value="US">üá∫üá∏ United States</option><option value="GB">üá¨üáß United Kingdom</option><option value="DE">üá©üá™ Germany</option></select>
        </div>
        <div class="form-group"><label>Province</label>
          <select id="set-province"><option value="">‚Äî</option><option value="ON">Ontario</option><option value="QC">Quebec</option><option value="BC">British Columbia</option><option value="AB">Alberta</option></select>
        </div>
      </div>
      <button class="btn" onclick="saveProfile()" style="margin-top:8px">Save Profile</button>
    </div>
  </div>
  <div class="card">
    <h2>API Keys</h2>
    <div style="padding:8px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">Generate API keys for programmatic access to Xcelsior.</p>
      <div style="margin-bottom:12px">
        <input id="key-name" placeholder="Key name (e.g. my-training-script)" style="width:200px;padding:6px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:4px;font-family:inherit;font-size:12px">
        <button class="btn" onclick="generateApiKey()" style="margin-left:6px;background:#4caf50">Generate Key</button>
      </div>
      <div id="new-key-display" style="display:none;background:#0a1a0a;border:1px solid #1a3a1a;border-radius:4px;padding:10px;margin-bottom:12px">
        <p style="font-size:11px;color:#4caf50;margin-bottom:4px">üîë New API key (copy now ‚Äî shown only once):</p>
        <code id="new-key-value" style="font-size:12px;color:#fff;word-break:break-all"></code>
        <button class="btn btn-secondary" onclick="copyApiKey()" style="margin-left:8px;font-size:10px;padding:2px 8px">üìã Copy</button>
      </div>
      <table>
        <thead><tr><th>Name</th><th>Created</th><th>Last Used</th><th>Key Preview</th><th>Actions</th></tr></thead>
        <tbody id="api-keys-table"><tr><td colspan="5" style="color:#555;text-align:center">No API keys yet</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h2>SSH Keys</h2>
    <div style="padding:8px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">SSH keys for connecting to GPU instances.</p>
      <div style="display:flex;gap:6px;margin-bottom:10px">
        <input id="ssh-upload-key" placeholder="Paste your SSH public key (ssh-rsa AAAA...)" style="flex:1;padding:6px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:4px;font-family:inherit;font-size:11px">
        <input id="ssh-key-label" placeholder="Key name" style="width:120px;padding:6px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:4px;font-family:inherit;font-size:11px">
        <button class="btn btn-secondary" onclick="uploadSshKey()" style="font-size:11px">üì§ Upload</button>
      </div>
      <button class="btn" onclick="generateSshKey()" style="background:#4caf50">üîê Generate SSH Key</button>
      <button class="btn btn-secondary" onclick="showSshPubkey()" style="margin-left:6px">Show Public Key</button>
      <div id="ssh-key-display" style="display:none;background:#111;border:1px solid #333;border-radius:4px;padding:10px;margin-top:10px;word-break:break-all;font-size:11px;color:#aaa"></div>
      <div id="ssh-keys-list" style="margin-top:12px">
        <table>
          <thead><tr><th>Name</th><th>Fingerprint</th><th>Added</th><th>Actions</th></tr></thead>
          <tbody id="ssh-keys-table"><tr><td colspan="4" style="color:#555;text-align:center;font-size:11px">No SSH keys uploaded</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>Privacy & Consent</h2>
    <div style="padding:8px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">Manage your data preferences per PIPEDA.</p>
      <div style="display:flex;flex-direction:column;gap:8px">
        <label style="font-size:12px;display:flex;align-items:center;gap:8px"><input type="checkbox" id="consent-telemetry" checked> Allow telemetry collection</label>
        <label style="font-size:12px;display:flex;align-items:center;gap:8px"><input type="checkbox" id="consent-cross-border"> Allow cross-border data transfer</label>
        <label style="font-size:12px;display:flex;align-items:center;gap:8px"><input type="checkbox" id="consent-profiling"> Allow usage profiling</label>
      </div>
      <button class="btn" onclick="saveConsent()" style="margin-top:10px">Save Preferences</button>
      <div style="margin-top:14px;border-top:1px solid #222;padding-top:10px">
        <div style="font-size:11px;color:#ff3333;text-transform:uppercase;margin-bottom:6px">Data Retention</div>
        <table class="retention-table">
          <tr><td class="rt-cat">Job logs</td><td class="rt-ttl">90 days</td></tr>
          <tr><td class="rt-cat">Telemetry</td><td class="rt-ttl">30 days</td></tr>
          <tr><td class="rt-cat">Billing records</td><td class="rt-ttl">7 years (CRA)</td></tr>
          <tr><td class="rt-cat">Account data</td><td class="rt-ttl">Until deletion</td></tr>
        </table>
        <button class="btn btn-secondary" onclick="revokeAllConsent()" style="margin-top:8px;font-size:10px">üö´ Revoke All Consent</button>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>üîî Notification Preferences</h2>
    <div style="padding:8px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">Configure which notifications you receive.</p>
      <div class="notif-grid">
        <div class="notif-item"><label><input type="checkbox" class="notif-toggle" id="notif-job-complete" checked> Job completion alerts</label></div>
        <div class="notif-item"><label><input type="checkbox" class="notif-toggle" id="notif-job-failed" checked> Job failure alerts</label></div>
        <div class="notif-item"><label><input type="checkbox" class="notif-toggle" id="notif-billing"> Billing & payment alerts</label></div>
        <div class="notif-item"><label><input type="checkbox" class="notif-toggle" id="notif-security" checked> Security alerts</label></div>
        <div class="notif-item"><label><input type="checkbox" class="notif-toggle" id="notif-sla"> SLA violation alerts</label></div>
        <div class="notif-item"><label><input type="checkbox" class="notif-toggle" id="notif-marketing"> Product updates & news</label></div>
      </div>
      <div class="form-group" style="margin-top:10px"><label style="font-size:11px">Digest Frequency</label>
        <select id="notif-digest-freq" style="font-size:11px">
          <option value="realtime">Real-time</option>
          <option value="hourly">Hourly digest</option>
          <option value="daily" selected>Daily digest</option>
          <option value="weekly">Weekly digest</option>
        </select>
      </div>
      <button class="btn" onclick="saveNotificationPrefs()" style="margin-top:8px">Save Notification Preferences</button>
      <div class="sound-toggle">
        <label><input type="checkbox" id="notif-sound-toggle" onchange="toggleNotifSound()"> üîä Play sound for critical alerts</label>
      </div>
      <div style="margin-top:8px">
        <label style="font-size:12px;display:flex;align-items:center;gap:8px"><input type="checkbox" id="notif-push-toggle" onchange="togglePushNotifs()"> üîî Enable browser push notifications</label>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>üë• Team Management</h2>
    <div style="padding:8px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">Create and manage teams for shared GPU access and billing.</p>
      <div style="display:flex;gap:6px;margin-bottom:12px">
        <input id="team-name-input" placeholder="New team name" style="flex:1;padding:6px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:4px;font-family:inherit;font-size:12px">
        <select id="team-plan-input" style="padding:6px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:4px;font-size:11px">
          <option value="free">Free (3 members)</option>
          <option value="pro">Pro (20 members)</option>
          <option value="enterprise">Enterprise (unlimited)</option>
        </select>
        <button class="btn" onclick="createTeam()" style="background:#4caf50;font-size:11px">+ Create</button>
      </div>
      <div id="teams-list" style="min-height:40px"><p style="font-size:11px;color:#555;text-align:center">Loading teams...</p></div>
    </div>
  </div>
  <div class="card">
    <h2>üîë Change Password</h2>
    <div style="padding:8px">
      <p style="font-size:12px;color:#888;margin-bottom:10px">Change your account password.</p>
      <div class="form-group"><label>Current Password</label><input id="set-current-pw" type="password" placeholder="Current password"></div>
      <div class="form-group"><label>New Password</label><input id="set-new-pw" type="password" placeholder="New password (min 8 characters)"></div>
      <div class="form-group"><label>Confirm New Password</label><input id="set-confirm-pw" type="password" placeholder="Confirm new password"></div>
      <button class="btn" onclick="changePassword()" style="margin-top:8px">Change Password</button>
    </div>
  </div>
  <div class="card">
    <h2 style="color:#f44336">‚ö†Ô∏è Danger Zone</h2>
    <div style="padding:8px">
      <div style="margin-bottom:16px">
        <p style="font-size:12px;color:#888;margin-bottom:8px">Export all your personal data (PIPEDA right to access).</p>
        <button class="btn btn-secondary" id="data-export-btn" onclick="requestDataExport()" style="width:100%">üì• Request Data Export</button>
        <div id="data-export-status" style="display:none;font-size:11px;color:#4caf50;margin-top:6px;text-align:center"></div>
      </div>
      <div style="border-top:1px solid #222;padding-top:12px">
        <p style="font-size:12px;color:#888;margin-bottom:8px">Permanently delete your account and all associated data. This action cannot be undone.</p>
        <button class="btn btn-danger" onclick="confirmDeleteAccount()" style="width:100%">üóëÔ∏è Delete My Account & Data</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Analytics Tab ‚ïê‚ïê‚ïê -->
<div id="tab-analytics" style="display:none">
<div class="stat-row">
  <div class="stat"><div class="num" id="stat-a-jobs">‚Äî</div><div class="label">Total Jobs</div></div>
  <div class="stat"><div class="num" id="stat-a-spend">‚Äî</div><div class="label">Total Spend (CAD)</div></div>
  <div class="stat"><div class="num" id="stat-a-hours">‚Äî</div><div class="label">GPU Hours</div></div>
  <div class="stat"><div class="num" id="stat-a-util">‚Äî</div><div class="label">Avg GPU Util %</div></div>
</div>
<div class="grid">
  <div class="card full">
    <h2>Compute Usage (Last 30 Days)</h2>
    <div style="display:flex;gap:12px;margin-bottom:8px;padding:0 8px">
      <select id="analytics-group" style="background:#1a1a1a;color:#e0e0e0;border:1px solid #333;padding:4px 8px;border-radius:4px;font-size:11px">
        <option value="day" selected>By Day</option>
        <option value="week">By Week</option>
        <option value="gpu_model">By GPU Model</option>
        <option value="province">By Province</option>
      </select>
      <select id="analytics-days" style="background:#1a1a1a;color:#e0e0e0;border:1px solid #333;padding:4px 8px;border-radius:4px;font-size:11px">
        <option value="7">7 days</option>
        <option value="30" selected>30 days</option>
        <option value="90">90 days</option>
      </select>
      <button class="btn btn-secondary" onclick="fetchAnalytics()" style="font-size:11px;padding:4px 12px">‚Üª Refresh</button>
    </div>
    <div id="analytics-chart" class="chart-bar" style="padding:8px 12px;min-height:140px"></div>
    <div id="analytics-chart-labels" style="display:flex;justify-content:space-around;font-size:9px;color:#555;padding:0 12px;margin-top:4px"></div>
  </div>
  <div class="card">
    <h2>Usage Breakdown</h2>
    <table>
      <thead><tr><th>Period</th><th>Jobs</th><th>GPU Hours</th><th>Spend (CAD)</th><th>üçÅ Canadian</th></tr></thead>
      <tbody id="analytics-table"><tr><td colspan="5" style="text-align:center;color:#555">Loading...</td></tr></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Canada vs International</h2>
    <div id="analytics-can-ratio" style="padding:12px;text-align:center">
      <div style="display:flex;gap:4px;height:24px;border-radius:4px;overflow:hidden;margin-bottom:8px">
        <div id="can-bar" style="background:#4caf50;transition:width 0.4s;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff">‚Äî</div>
        <div id="intl-bar" style="background:#2196f3;transition:width 0.4s;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff">‚Äî</div>
      </div>
      <div style="font-size:11px;color:#666">
        <span style="color:#4caf50">‚óè Canadian</span> &nbsp; <span style="color:#2196f3">‚óè International</span>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Artifacts Tab ‚ïê‚ïê‚ïê -->
<div id="tab-artifacts" style="display:none">
<div class="stat-row">
  <div class="stat"><div class="num" id="stat-art-count">‚Äî</div><div class="label">Total Artifacts</div></div>
  <div class="stat"><div class="num" id="stat-art-size">‚Äî</div><div class="label">Total Size</div></div>
</div>
<div class="grid">
  <div class="card full">
    <h2>Job Artifacts</h2>
    <div style="display:flex;gap:8px;margin-bottom:8px;padding:0 8px">
      <div class="form-group" style="margin:0;flex:1"><input id="art-job-id" placeholder="Job ID" style="width:100%"></div>
      <button class="btn" onclick="fetchArtifacts()" style="font-size:11px">üîç Lookup</button>
      <button class="btn btn-secondary" onclick="showUploadArtifact()" style="font-size:11px">üì§ Upload</button>
    </div>
    <table>
      <thead><tr><th>Artifact ID</th><th>Type</th><th>Job</th><th>Size</th><th>Residency</th><th>Created</th><th>Expires</th><th>Actions</th></tr></thead>
      <tbody id="artifacts-table"><tr><td colspan="8" style="text-align:center;color:#555">Enter a Job ID to view artifacts</td></tr></tbody>
    </table>
  </div>
  <div class="card">
    <h2>Upload Artifact</h2>
    <div id="upload-artifact-form" style="padding:8px">
      <div class="form-group"><label>Job ID</label><input id="art-upload-job" placeholder="job-xxx"></div>
      <div class="form-group"><label>Artifact Type</label>
        <select id="art-upload-type">
          <option value="job_output">Job Output</option>
          <option value="model_checkpoint">Model Checkpoint</option>
          <option value="dataset">Dataset</option>
          <option value="log_bundle">Log Bundle</option>
        </select>
      </div>
      <div class="form-group"><label>Residency Policy</label>
        <select id="art-upload-residency">
          <option value="canada_only" selected>üçÅ Canada Only</option>
          <option value="global">Global</option>
          <option value="region_locked">Region Locked</option>
        </select>
      </div>
      <div class="form-group"><label>Size (bytes)</label><input id="art-upload-size" type="number" value="1048576" min="1"></div>
      <button class="btn" onclick="uploadArtifact()" style="background:#4caf50;width:100%">üì§ Get Upload URL</button>
    </div>
  </div>
  <div class="card">
    <h2>Storage Regions</h2>
    <div style="padding:8px;font-size:12px;color:#aaa">
      <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #1a1a1a"><span style="font-size:16px">üçÅ</span><span><strong>B2 CA-East</strong> ‚Äî Montreal, QC<br><span style="color:#666">Primary storage for Canadian residency</span></span></div>
      <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #1a1a1a"><span style="font-size:16px">üåê</span><span><strong>R2 Global</strong> ‚Äî Cloudflare edge<br><span style="color:#666">Zero-egress global distribution</span></span></div>
      <div style="display:flex;align-items:center;gap:8px;padding:6px 0"><span style="font-size:16px">üìã</span><span><strong>Residency Routing</strong><br><span style="color:#666">Artifacts auto-routed based on job jurisdiction</span></span></div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê HPC/Slurm Tab ‚ïê‚ïê‚ïê -->
<div id="tab-slurm" style="display:none">
<div class="grid">
  <div class="card full">
    <h2>üñ•Ô∏è Cluster Profiles</h2>
    <div id="slurm-profiles" class="cluster-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;padding:8px">
      <div style="color:#888;font-size:12px">Loading profiles‚Ä¶</div>
    </div>
  </div>
  <div class="card">
    <h2>Submit HPC Job</h2>
    <div class="slurm-form">
      <div class="form-group">
        <label>Job Name</label>
        <input id="slurm-name" type="text" placeholder="my-training-job">
      </div>
      <div class="form-group">
        <label>VRAM (GB)</label>
        <input id="slurm-vram" type="number" value="16" min="1" step="1">
      </div>
      <div class="form-group">
        <label>Priority (0‚Äì10)</label>
        <input id="slurm-priority" type="number" value="5" min="0" max="10">
      </div>
      <div class="form-group">
        <label>Tier</label>
        <select id="slurm-tier">
          <option value="free">Free</option>
          <option value="standard" selected>Standard</option>
          <option value="premium">Premium</option>
          <option value="urgent">Urgent</option>
        </select>
      </div>
      <div class="form-group">
        <label>Num GPUs</label>
        <input id="slurm-gpus" type="number" value="1" min="1" max="8">
      </div>
      <div class="form-group">
        <label>Container Image</label>
        <input id="slurm-image" type="text" placeholder="nvcr.io/nvidia/pytorch:latest">
      </div>
      <div class="form-group">
        <label>Cluster Profile</label>
        <select id="slurm-profile">
          <option value="">Auto-select</option>
        </select>
      </div>
      <div class="form-group" style="justify-content:flex-end">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="slurm-dryrun"> Dry Run (preview script)</label>
      </div>
      <div class="form-group full" style="flex-direction:row;gap:8px">
        <button class="btn" onclick="submitSlurmJob()" style="flex:1">üöÄ Submit Job</button>
        <button class="btn" onclick="submitSlurmJob(true)" style="flex:1;background:#555">üìù Preview Script</button>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>Job Status Lookup</h2>
    <div style="padding:8px">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="slurm-status-id" type="text" placeholder="Slurm Job ID" style="flex:1;background:#0a0a0a;border:1px solid #333;color:#e0e0e0;padding:6px 8px;border-radius:4px;font-family:inherit;font-size:12px">
        <button class="btn" onclick="fetchSlurmStatus()">üîç Check</button>
        <button class="btn" onclick="cancelSlurmJob()" style="background:#f44336">‚úï Cancel</button>
      </div>
      <div id="slurm-status-result" style="font-size:12px;color:#aaa">Enter a Slurm Job ID to check status.</div>
    </div>
    <h2 style="margin-top:12px">Recent Submissions</h2>
    <div id="slurm-recent-jobs" style="max-height:250px;overflow-y:auto;font-size:12px;color:#aaa">
      No recent submissions.
    </div>
  </div>
  <div class="card full" id="slurm-script-card" style="display:none">
    <h2>üìù Generated sbatch Script</h2>
    <div id="slurm-script-content" class="slurm-script-preview"></div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Admin Tab (role-gated) ‚ïê‚ïê‚ïê -->
<div id="tab-admin" style="display:none">
<div class="grid">
  <div class="card">
    <h2>üîß System Controls</h2>
    <div style="padding:4px">
      <div class="admin-toggle">
        <label>üçÅ Canada-Only Mode</label>
        <label class="switch"><input type="checkbox" id="admin-canada-only" onchange="toggleCanadaOnly()"><span class="slider"></span></label>
      </div>
      <div class="admin-toggle">
        <label>üîí Maintenance Mode</label>
        <label class="switch"><input type="checkbox" id="admin-maintenance"><span class="slider"></span></label>
      </div>
      <div style="padding:8px;display:flex;flex-wrap:wrap;gap:6px">
        <button class="btn btn-secondary" onclick="adminSpotUpdate()" style="font-size:11px">üíπ Update Spot Prices</button>
        <button class="btn btn-secondary" onclick="adminPreemptionCycle()" style="font-size:11px">‚ö° Preemption Cycle</button>
        <button class="btn btn-secondary" onclick="adminScaleUp()" style="font-size:11px">üìà Scale Up</button>
        <button class="btn btn-secondary" onclick="adminScaleDown()" style="font-size:11px">üìâ Scale Down</button>
        <button class="btn" onclick="adminEnforceSLA()" style="font-size:11px;background:#f44336">üõ°Ô∏è Enforce SLA</button>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>üìä System Metrics</h2>
    <div id="admin-metrics" style="padding:8px;font-size:12px;color:#aaa">
      <button class="btn btn-secondary" onclick="fetchAdminMetrics()" style="font-size:11px;margin-bottom:8px">‚Üª Refresh Metrics</button>
      <div id="admin-metrics-data">Click refresh to load system metrics.</div>
    </div>
  </div>
  <div class="card">
    <h2>üîî Alert Configuration</h2>
    <div style="padding:8px">
      <div class="form-group"><label>Telegram Bot Token</label><input id="alert-telegram-token" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div class="form-group"><label>Telegram Chat ID</label><input id="alert-telegram-chat" placeholder="e.g. -100123456789"></div>
      <div class="form-group"><label>Mining Alert Threshold</label>
        <select id="alert-mining-thresh">
          <option value="0.8">High (80%+ util for 5 min)</option>
          <option value="0.9">Very High (90%+ util for 5 min)</option>
          <option value="0.95">Critical Only (95%+)</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="loadAlertConfig()" style="font-size:11px;flex:1">‚Üª Load Config</button>
        <button class="btn" onclick="saveAlertConfig()" style="font-size:11px;flex:1;background:#4caf50">üíæ Save Config</button>
      </div>
      <div id="alert-config-result" style="margin-top:8px;font-size:11px;color:#aaa"></div>
    </div>
  </div>
  <div class="card">
    <h2>üîó Audit Chain</h2>
    <div style="padding:8px">
      <button class="btn" onclick="verifyAuditChain()" style="font-size:11px;background:#4caf50">‚úì Verify Chain Integrity</button>
      <div id="audit-chain-result" style="margin-top:8px;font-size:12px;color:#aaa"></div>
    </div>
  </div>
  <div class="card">
    <h2>‚öñÔ∏è Legal Requests</h2>
    <div style="padding:8px">
      <div class="form-group"><label>Type</label>
        <select id="legal-type">
          <option value="law_enforcement">Law Enforcement</option>
          <option value="subpoena">Subpoena</option>
          <option value="national_security">National Security</option>
          <option value="civil_litigation">Civil Litigation</option>
        </select>
      </div>
      <div class="form-group"><label>Agency</label><input id="legal-agency" placeholder="e.g. RCMP"></div>
      <div class="form-group"><label>Description</label><textarea id="legal-desc" rows="2" placeholder="Brief description"></textarea></div>
      <button class="btn" onclick="recordLegalRequest()" style="width:100%;font-size:11px">Record Legal Request</button>
    </div>
  </div>
  <div class="card">
    <h2>üê≥ Image Builder</h2>
    <div style="padding:8px">
      <div class="form-group"><label>Image Name</label><input id="build-image" placeholder="xcelsior/my-image:latest"></div>
      <div class="form-group"><label>Base Image</label><input id="build-base" placeholder="nvidia/cuda:12.1.0-runtime-ubuntu22.04" value="nvidia/cuda:12.1.0-runtime-ubuntu22.04"></div>
      <div class="form-group"><label>Packages (space-separated)</label><input id="build-packages" placeholder="torch transformers"></div>
      <button class="btn" onclick="buildImage()" style="width:100%;background:#2196f3;font-size:11px">üî® Build Image</button>
      <div id="build-result" style="margin-top:8px;font-size:11px;color:#aaa"></div>
    </div>
  </div>
  <div class="card">
    <h2>üì¶ Recent Builds</h2>
    <table>
      <thead><tr><th>Image</th><th>Status</th><th>Built</th></tr></thead>
      <tbody id="builds-table"><tr><td colspan="3" style="text-align:center;color:#555">No builds yet</td></tr></tbody>
    </table>
    <button class="btn btn-secondary" onclick="fetchBuilds()" style="font-size:11px;margin-top:4px">‚Üª Refresh</button>
  </div>
</div>
</div>

</div><!-- end #main-app -->

<!-- Session Timeout Modal -->
<div id="session-timeout-modal" class="session-modal-overlay" style="display:none">
  <div class="session-modal">
    <h3>‚è∞ Session Expired</h3>
    <p>Your session has expired. Please log in again to continue.</p>
    <button class="btn" onclick="window.location.reload()" style="padding:8px 24px">üîë Log In</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê Modals ‚ïê‚ïê‚ïê -->

<!-- Deposit Modal -->
<div id="deposit-modal" class="modal-overlay">
  <div class="modal" style="max-width:400px;text-align:left">
    <h2 style="text-align:center">üí∞ Add Credits</h2>
    <p style="text-align:center;color:#888;font-size:12px;margin-bottom:16px">Credits are used to pay for compute jobs.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">
      <button class="btn btn-secondary" onclick="setDepositAmount(10)" style="padding:10px">$10</button>
      <button class="btn btn-secondary" onclick="setDepositAmount(25)" style="padding:10px">$25</button>
      <button class="btn btn-secondary" onclick="setDepositAmount(50)" style="padding:10px">$50</button>
      <button class="btn btn-secondary" onclick="setDepositAmount(100)" style="padding:10px">$100</button>
      <button class="btn btn-secondary" onclick="setDepositAmount(250)" style="padding:10px">$250</button>
      <button class="btn btn-secondary" onclick="setDepositAmount(500)" style="padding:10px">$500</button>
    </div>
    <div class="form-group"><label>Custom Amount (CAD)</label><input id="deposit-amount" type="number" min="5" step="5" value="25" placeholder="25.00"></div>
    <div style="text-align:center;margin-top:14px">
      <button class="btn" onclick="processDeposit()" style="background:#4caf50;padding:10px 32px">üí≥ Add Credits</button>
      <button class="btn btn-secondary" onclick="closeModal('deposit-modal')" style="margin-left:6px">Cancel</button>
    </div>
  </div>
</div>

<!-- Job Detail Modal -->
<div id="job-detail-modal" class="modal-overlay">
  <div class="modal detail-panel" style="text-align:left">
    <h2 style="text-align:center">Job Details</h2>
    <div id="job-detail-content" style="font-size:12px;color:#aaa">Loading...</div>
    <div style="text-align:center;margin-top:14px">
      <button class="btn" id="job-cancel-btn" onclick="cancelJob()" style="background:#f44336;display:none">‚úï Cancel Job</button>
      <button class="btn" id="job-requeue-btn" onclick="requeueJob()" style="background:#ff9800;display:none">‚Üª Requeue</button>
      <button class="btn btn-secondary" onclick="closeModal('job-detail-modal')">Close</button>
    </div>
  </div>
</div>

<!-- Onboarding modal (first visit) -->
<div id="onboarding-modal" class="modal-overlay">
  <div class="modal" style="max-width:480px">
    <h2>Welcome to Xcelsior</h2>
    <p style="color:#888;margin-bottom:16px">Distributed Canadian GPU compute ‚Äî ever upward.<br>Choose your role to get started:</p>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="btn" onclick="setRole('provider')" style="background:#4caf50;padding:12px;font-size:13px">üñ•Ô∏è GPU Provider ‚Äî Share your GPU for compute jobs</button>
      <button class="btn" onclick="setRole('submitter')" style="background:#2196f3;padding:12px;font-size:13px">üì¶ Job Submitter ‚Äî Run training & inference workloads</button>
      <button class="btn btn-secondary" onclick="setRole('admin')" style="padding:12px;font-size:13px">üîß Admin / Both ‚Äî Full access to all features</button>
    </div>
    <p style="color:#444;font-size:10px;margin-top:12px">You can change this later in settings.</p>
  </div>
</div>

<!-- Add Host modal -->
<div id="add-host-modal" class="modal-overlay">
  <div class="modal" style="max-width:560px;text-align:left">
    <h2 style="text-align:center">Register GPU Host</h2>
    <p style="text-align:center;color:#888;font-size:12px">Host starts as <span class="status status-pending">pending</span> until agent reports versions and passes admission.</p>

    <div class="form-section-title">Host Identity</div>
    <div class="form-row">
      <div class="form-group"><label class="required">Host ID</label><input id="ah-id" placeholder="e.g. gpu-toronto-01"><div class="hint">Unique identifier for this host</div></div>
      <div class="form-group"><label class="required">IP Address</label><input id="ah-ip" placeholder="10.0.0.5"><div class="hint">Headscale / VPN IP</div></div>
    </div>

    <div class="form-section">
      <div class="form-section-title">GPU Hardware</div>
      <div class="form-row">
        <div class="form-group"><label class="required">GPU Model</label>
          <select id="ah-gpu" onchange="autoFillVram()">
            <optgroup label="NVIDIA Consumer">
              <option value="RTX 3060" data-vram="12">RTX 3060 (12 GB)</option>
              <option value="RTX 3070" data-vram="8">RTX 3070 (8 GB)</option>
              <option value="RTX 3080" data-vram="10">RTX 3080 (10 GB)</option>
              <option value="RTX 3090" data-vram="24">RTX 3090 (24 GB)</option>
              <option value="RTX 4060" data-vram="8">RTX 4060 (8 GB)</option>
              <option value="RTX 4060 Ti" data-vram="16">RTX 4060 Ti (16 GB)</option>
              <option value="RTX 4070" data-vram="12">RTX 4070 (12 GB)</option>
              <option value="RTX 4070 Ti" data-vram="12">RTX 4070 Ti (12 GB)</option>
              <option value="RTX 4080" data-vram="16">RTX 4080 (16 GB)</option>
              <option value="RTX 4090" data-vram="24" selected>RTX 4090 (24 GB)</option>
              <option value="RTX 5090" data-vram="32">RTX 5090 (32 GB)</option>
            </optgroup>
            <optgroup label="NVIDIA Datacenter">
              <option value="T4" data-vram="16">T4 (16 GB)</option>
              <option value="A10" data-vram="24">A10 (24 GB)</option>
              <option value="A30" data-vram="24">A30 (24 GB)</option>
              <option value="A40" data-vram="48">A40 (48 GB)</option>
              <option value="A100 40GB" data-vram="40">A100 40 GB</option>
              <option value="A100 80GB" data-vram="80">A100 80 GB</option>
              <option value="L4" data-vram="24">L4 (24 GB)</option>
              <option value="L40" data-vram="48">L40 (48 GB)</option>
              <option value="L40S" data-vram="48">L40S (48 GB)</option>
              <option value="H100 SXM" data-vram="80">H100 SXM (80 GB)</option>
              <option value="H100 PCIe" data-vram="80">H100 PCIe (80 GB)</option>
              <option value="H200" data-vram="141">H200 (141 GB)</option>
              <option value="B200" data-vram="192">B200 (192 GB)</option>
            </optgroup>
            <optgroup label="NVIDIA Professional">
              <option value="RTX A4000" data-vram="16">RTX A4000 (16 GB)</option>
              <option value="RTX A5000" data-vram="24">RTX A5000 (24 GB)</option>
              <option value="RTX A6000" data-vram="48">RTX A6000 (48 GB)</option>
            </optgroup>
            <optgroup label="AMD">
              <option value="MI250X" data-vram="128">MI250X (128 GB)</option>
              <option value="MI300X" data-vram="192">MI300X (192 GB)</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group"><label class="required">Total VRAM (GB)</label><input id="ah-vram" type="number" value="24" min="1"><div class="hint">Auto-filled from GPU selection</div></div>
      </div>
      <div class="form-group"><label class="required">Cost per Hour (CAD $)</label><input id="ah-cost" type="number" value="0.45" step="0.01" min="0" style="max-width:160px"><div class="hint">Market rate shown after registration</div></div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Location</div>
      <div class="form-row">
        <div class="form-group"><label class="required">Country</label>
          <select id="ah-country" onchange="toggleProvinceField()">
            <option value="CA" selected>üá®üá¶ Canada</option>
            <optgroup label="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"></optgroup>
            <option value="US">üá∫üá∏ United States</option>
            <option value="GB">üá¨üáß United Kingdom</option>
            <option value="DE">üá©üá™ Germany</option>
            <option value="FR">üá´üá∑ France</option>
            <option value="NL">üá≥üá± Netherlands</option>
            <option value="SE">üá∏üá™ Sweden</option>
            <option value="NO">üá≥üá¥ Norway</option>
            <option value="FI">üá´üáÆ Finland</option>
            <option value="IS">üáÆüá∏ Iceland</option>
            <option value="CH">üá®üá≠ Switzerland</option>
            <option value="AU">üá¶üá∫ Australia</option>
            <option value="NZ">üá≥üáø New Zealand</option>
            <option value="JP">üáØüáµ Japan</option>
            <option value="SG">üá∏üá¨ Singapore</option>
            <option value="IN">üáÆüá≥ India</option>
            <option value="BR">üáßüá∑ Brazil</option>
          </select>
        </div>
        <div class="form-group" id="ah-province-group"><label class="required">Province / Territory</label>
          <select id="ah-province">
            <option value="">‚Äî Select ‚Äî</option>
            <optgroup label="Provinces">
              <option value="ON">Ontario (ON)</option>
              <option value="QC">Quebec (QC)</option>
              <option value="BC">British Columbia (BC)</option>
              <option value="AB">Alberta (AB)</option>
              <option value="SK">Saskatchewan (SK)</option>
              <option value="MB">Manitoba (MB)</option>
              <option value="NB">New Brunswick (NB)</option>
              <option value="NS">Nova Scotia (NS)</option>
              <option value="PE">Prince Edward Island (PE)</option>
              <option value="NL">Newfoundland and Labrador (NL)</option>
            </optgroup>
            <optgroup label="Territories">
              <option value="NT">Northwest Territories (NT)</option>
              <option value="YT">Yukon (YT)</option>
              <option value="NU">Nunavut (NU)</option>
            </optgroup>
          </select>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:18px">
      <button class="btn" onclick="submitHost()">Register Host</button>
      <button class="btn btn-secondary" onclick="closeModal('add-host-modal')" style="margin-left:6px">Cancel</button>
    </div>
  </div>
</div>

<!-- Provider Registration modal -->
<div id="provider-reg-modal" class="modal-overlay">
  <div class="modal" style="max-width:540px;text-align:left">
    <h2 style="text-align:center">Provider Registration</h2>
    <p style="text-align:center;color:#888;font-size:12px">Register as a GPU provider on Xcelsior. Required for payouts and compliance.</p>

    <div class="form-section-title">Account</div>
    <div class="form-row">
      <div class="form-group"><label class="required">Provider ID</label><input id="pr-id" placeholder="e.g. provider-jane"><div class="hint">Your unique provider handle</div></div>
      <div class="form-group"><label class="required">Email</label><input id="pr-email" type="email" placeholder="jane@example.com"></div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Provider Type</div>
      <div class="form-group">
        <select id="pr-type" onchange="toggleCorpFields()">
          <option value="individual" selected>Individual</option>
          <option value="company">Company / Corporation</option>
        </select>
        <div class="hint">Companies must provide business registration details</div>
      </div>
    </div>

    <div id="pr-corp-fields" style="display:none">
      <div class="form-section">
        <div class="form-section-title">Corporation Details</div>
        <div class="form-row">
          <div class="form-group"><label class="required">Corporation Name</label><input id="pr-corp" placeholder="Acme GPU Inc."></div>
          <div class="form-group"><label class="required">Legal Name</label><input id="pr-legal" placeholder="Full legal entity name"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Business Number</label><input id="pr-bn" placeholder="123456789 RC0001"><div class="hint">CRA business number</div></div>
          <div class="form-group"><label>GST/HST Number</label><input id="pr-gst" placeholder="123456789 RT0001"><div class="hint">Required if revenue &gt; $30,000/yr</div></div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Location</div>
      <div class="form-group"><label class="required">Province / Territory</label>
        <select id="pr-province">
          <option value="">‚Äî Select ‚Äî</option>
          <optgroup label="Provinces">
            <option value="ON">Ontario (ON)</option>
            <option value="QC">Quebec (QC)</option>
            <option value="BC">British Columbia (BC)</option>
            <option value="AB">Alberta (AB)</option>
            <option value="SK">Saskatchewan (SK)</option>
            <option value="MB">Manitoba (MB)</option>
            <option value="NB">New Brunswick (NB)</option>
            <option value="NS">Nova Scotia (NS)</option>
            <option value="PE">Prince Edward Island (PE)</option>
            <option value="NL">Newfoundland and Labrador (NL)</option>
          </optgroup>
          <optgroup label="Territories">
            <option value="NT">Northwest Territories (NT)</option>
            <option value="YT">Yukon (YT)</option>
            <option value="NU">Nunavut (NU)</option>
          </optgroup>
        </select>
      </div>
    </div>

    <div style="text-align:center;margin-top:18px">
      <button class="btn" onclick="submitProviderReg()" style="background:#4caf50">Register as Provider</button>
      <button class="btn btn-secondary" onclick="closeModal('provider-reg-modal')" style="margin-left:6px">Cancel</button>
    </div>
  </div>
</div>

<!-- Submit Job modal -->
<div id="submit-job-modal" class="modal-overlay">
  <div class="modal" style="max-width:520px;text-align:left">
    <h2 style="text-align:center">Submit Job</h2>
    <p style="text-align:center;color:#888;font-size:12px">Schedule a GPU workload on the Xcelsior network.</p>

    <div class="form-section-title">Job Details</div>
    <div class="form-row">
      <div class="form-group"><label class="required">Job Name</label><input id="sj-name" placeholder="my-training-run" oninput="updateCostEstimate()"><div class="hint">Descriptive name for tracking</div></div>
      <div class="form-group"><label class="required">VRAM Needed (GB)</label><input id="sj-vram" type="number" value="8" min="1" oninput="updateCostEstimate()"><div class="hint">Minimum GPU memory required</div></div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Tier Selection</div>
      <div class="form-row">
        <div class="form-group"><label>Priority Tier</label>
          <select id="sj-tier" onchange="updateCostEstimate()">
            <option value="free">Free ‚Äî Best-effort, no SLA</option>
            <option value="standard" selected>Standard ‚Äî $0.10/hr base</option>
            <option value="premium">Premium ‚Äî Priority queue, 99.5% SLA</option>
            <option value="urgent">Urgent ‚Äî Immediate dispatch, 99.9% SLA</option>
          </select>
        </div>
        <div class="form-group"><label>Trust Tier</label>
          <select id="sj-trust" onchange="updateCostEstimate()">
            <option value="community" selected>Community ‚Äî Any host</option>
            <option value="residency">Residency ‚Äî üçÅ Canada-resident hosts</option>
            <option value="sovereignty">Sovereignty ‚Äî Canadian-owned only</option>
            <option value="regulated">Regulated ‚Äî Compliance-verified</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">Container</div>
      <div class="form-group"><label>Docker Image</label><input id="sj-image" placeholder="python:3.12-slim"><div class="hint">Leave blank for default runtime</div></div>
    </div>

    <div class="form-section">
      <div class="form-section-title">GPU & Pricing</div>
      <div class="form-row">
        <div class="form-group"><label>GPU Count</label>
          <select id="sj-gpu-count" onchange="updateCostEstimate()">
            <option value="1" selected>1 GPU</option>
            <option value="2">2 GPUs</option>
            <option value="4">4 GPUs</option>
            <option value="8">8 GPUs</option>
          </select>
          <div class="hint">Multi-GPU for distributed training</div>
        </div>
        <div class="form-group"><label>Pricing Mode</label>
          <select id="sj-pricing-mode" onchange="updateCostEstimate()">
            <option value="on-demand" selected>üí∞ On-Demand ‚Äî Fixed rate</option>
            <option value="spot">‚ö° Spot ‚Äî Up to 70% cheaper, may be preempted</option>
          </select>
          <div class="hint" id="sj-spot-hint" style="display:none;color:#ff9800">Spot jobs may be interrupted with 30s warning</div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="collapsible-header" onclick="toggleAdvancedJob()">Advanced Options</div>
      <div class="collapsible-body" id="sj-advanced">
        <div class="form-section-title">NFS Mount (Optional)</div>
        <div class="form-row">
          <div class="form-group"><label>NFS Server</label><input id="sj-nfs-server" placeholder="10.0.0.100"><div class="hint">NFS server IP or hostname</div></div>
          <div class="form-group"><label>NFS Path</label><input id="sj-nfs-path" placeholder="/exports/datasets"><div class="hint">Remote export path</div></div>
        </div>
        <div class="form-group"><label>Mount Point</label><input id="sj-nfs-mount" placeholder="/mnt/data"><div class="hint">Container mount point</div></div>
        <div class="form-section-title" style="margin-top:12px">Environment Variables</div>
        <div class="form-group"><label>Env Vars (KEY=VALUE, one per line)</label><textarea id="sj-env" rows="2" placeholder="BATCH_SIZE=32&#10;LEARNING_RATE=0.001"></textarea></div>
      </div>
    </div>

    <div class="estimate-box" id="sj-estimate">
      <div class="est-label">Estimated Cost</div>
      <div class="est-value" id="sj-est-value">~$0.10/hr</div>
      <div id="sj-est-comparison" style="display:none;font-size:10px;color:#ff9800;margin-top:4px"></div>
      <div style="font-size:10px;color:#555">Based on tier + current market rates. Actual cost may vary.</div>
    </div>

    <div style="text-align:center;margin-top:18px">
      <button class="btn" onclick="submitJob()">Submit Job</button>
      <button class="btn btn-secondary" onclick="closeModal('submit-job-modal')" style="margin-left:6px">Cancel</button>
    </div>
  </div>
</div>

<!-- Host Detail Modal -->
<div id="host-detail-modal" class="modal-overlay">
  <div class="modal host-detail-panel" style="text-align:left">
    <h2 style="text-align:center">Host Details</h2>
    <div id="host-detail-content" style="font-size:12px;color:#aaa">Loading...</div>
    <div id="host-provider-panel" style="display:none;margin-top:12px">
      <div class="provider-panel">
        <div class="pp-title">Provider Earnings</div>
        <div class="provider-stats">
          <div class="provider-stat"><div class="ps-val" id="hp-total-earned">$0</div><div class="ps-label">Total Earned</div></div>
          <div class="provider-stat"><div class="ps-val" id="hp-pending">$0</div><div class="ps-label">Pending Payout</div></div>
          <div class="provider-stat"><div class="ps-val" id="hp-jobs-done">0</div><div class="ps-label">Jobs Completed</div></div>
          <div class="provider-stat"><div class="ps-val" id="hp-uptime">‚Äî</div><div class="ps-label">Uptime</div></div>
        </div>
        <div style="text-align:center;margin-top:10px">
          <button class="btn" onclick="requestProviderPayout()" style="background:#4caf50;font-size:11px">üí∏ Request Payout</button>
        </div>
      </div>
    </div>
    <div style="text-align:center;margin-top:14px">
      <button class="btn" id="host-marketplace-btn" onclick="toggleHostMarketplace()" style="background:#4caf50;display:none">üì¢ List on Marketplace</button>
      <button class="btn btn-secondary" onclick="closeModal('host-detail-modal')">Close</button>
    </div>
  </div>
</div>

<p class="refresh-note">Real-time updates via SSE. Falls back to polling every 10s.</p>

<script>
const API = '';

// ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  ['tab-overview', 'tab-telemetry', 'tab-trust', 'tab-billing-tab', 'tab-earnings', 'tab-reputation-tab', 'tab-job-logs', 'tab-analytics', 'tab-artifacts', 'tab-slurm', 'tab-admin', 'tab-logs', 'tab-settings'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === `tab-${name}`) ? '' : 'none';
  });
  // Start telemetry polling when tab is visible
  if (name === 'telemetry') { startTelemetryPolling(); } else { stopTelemetryPolling(); }
}

function s(status) {
  return `<span class="status status-${status}">${status}</span>`;
}

function t(tier) {
  return `<span class="tier tier-${tier || 'free'}">${tier || 'free'}</span>`;
}

function repTier(tier) {
  const t = (tier || 'new_user').toLowerCase().replace(' ', '_');
  const icons = { 'new_user': 'üîò', 'new-user': 'üîò', 'bronze': 'ü•â', 'silver': 'ü•à', 'gold': 'ü•á', 'platinum': 'üíé', 'diamond': 'üëë' };
  const icon = icons[t] || 'üîò';
  return `<span class="tier-badge ${t}">${icon} ${t.replace('_', ' ').toUpperCase()}</span>`;
}

function verBadge(status) {
  const cls = status === 'verified' ? 'badge-verified' : status === 'deverified' ? 'badge-deverified' : 'badge-unverified';
  return `<span class="badge ${cls}">${status}</span>`;
}

async function fetchHosts() {
  const r = await fetch(`${API}/hosts?active_only=false`);
  const d = await r.json();
  const active = d.hosts.filter(h => h.status === 'active').length;
  const ca = d.hosts.filter(h => (h.country || '').toUpperCase() === 'CA').length;
  document.getElementById('stat-hosts').textContent = active;
  document.getElementById('stat-ca-hosts').textContent = ca;
  document.getElementById('hosts-table').innerHTML = d.hosts.map(h => {
    const loc = (h.country === 'CA' ? 'üçÅ CA' : (h.country || '‚Äî')) + (h.province ? ` <span class="prov-badge">${h.province}</span>` : '');
    const admitted = h.admitted ? '<span class="badge badge-admitted">‚úì</span>' : '<span class="badge badge-not-admitted">‚úó</span>';
    return `<tr><td style="cursor:pointer;color:#90caf9" onclick="showHostDetail('${h.host_id}')">${h.host_id}</td><td>${h.ip}</td><td>${h.gpu_model}</td><td>${h.free_vram_gb}GB</td><td>$${h.cost_per_hour}</td><td>${loc}</td><td>${admitted}</td><td>${s(h.status)}</td><td><button class="btn btn-secondary" style="padding:1px 6px;font-size:10px" onclick="removeHost('${h.host_id}')">‚úï</button></td></tr>`;
  }).join('');
}

async function fetchJobs() {
  const r = await fetch(`${API}/jobs`);
  const d = await r.json();
  const running = d.jobs.filter(j => j.status === 'running').length;
  const queued = d.jobs.filter(j => j.status === 'queued').length;
  document.getElementById('stat-jobs').textContent = d.jobs.length;
  document.getElementById('stat-running').textContent = running;
  document.getElementById('stat-queued').textContent = queued;
  document.getElementById('jobs-table').innerHTML = d.jobs.map(j =>
    `<tr><td style="cursor:pointer;color:#90caf9" onclick="showJobDetail('${j.job_id}')">${j.job_id}</td><td>${j.name}</td><td>${j.vram_needed_gb}GB</td><td>${t(j.tier)}</td><td>${j.host_id || '‚Äî'}</td><td>${s(j.status)} ${jobProgress(j)}</td><td><button class="btn" style="padding:2px 8px;font-size:10px" onclick="streamJobLogs('${j.job_id}')">üìã</button>${j.status === 'running' || j.status === 'queued' ? ` <button class="btn" style="padding:2px 8px;font-size:10px;background:#f44336" onclick="cancelJobDirect('${j.job_id}')">‚úï</button>` : ''}</td></tr>`
  ).join('');
}

async function fetchBilling() {
  const r = await fetch(`${API}/billing`);
  const d = await r.json();
  document.getElementById('stat-revenue').textContent = `$${d.total_revenue}`;
  document.getElementById('billing-table').innerHTML = d.records.map(b =>
    `<tr><td>${b.job_id}</td><td>${b.job_name}</td><td>${b.host_id || '‚Äî'}</td><td>${t(b.tier)}</td><td>${b.duration_sec}s</td><td>$${b.rate_per_hour}/hr</td><td>$${b.cost}</td></tr>`
  ).join('');
}

async function fetchMarketplace() {
  const r = await fetch(`${API}/marketplace`);
  const d = await r.json();
  document.getElementById('stat-market').textContent = d.listings.length;
  document.getElementById('market-table').innerHTML = d.listings.map(l =>
    `<tr><td>${l.host_id}</td><td>${l.gpu_model}</td><td>${l.vram_gb}GB</td><td>$${l.price_per_hour}</td><td>${l.owner}</td><td>${l.total_jobs || 0}</td><td>$${l.total_earned || 0}</td></tr>`
  ).join('');
}

async function fetchPool() {
  const r = await fetch(`${API}/autoscale/pool`);
  const d = await r.json();
  document.getElementById('stat-pool').textContent = d.pool.length;
  document.getElementById('pool-table').innerHTML = d.pool.map(p =>
    `<tr><td>${p.host_id}</td><td>${p.gpu_model}</td><td>${p.vram_gb}GB</td><td>$${p.cost_per_hour}</td><td>${p.country || '‚Äî'}</td><td>${p.provisioned ? s('active') : s('queued')}</td></tr>`
  ).join('');
}

async function fetchSpotPrices() {
  try {
    const r = await fetch(`${API}/spot-prices`);
    const d = await r.json();
    const prices = d.prices || {};
    const keys = Object.keys(prices);
    document.getElementById('stat-spot').textContent = keys.length;
    document.getElementById('spot-table').innerHTML = keys.map(k => {
      const p = prices[k];
      return `<tr><td>${k}</td><td>$${(p.spot_price || 0).toFixed(3)}</td><td>${p.supply || 0}</td><td>${p.demand || 0}</td></tr>`;
    }).join('');
  } catch(e) {
    document.getElementById('stat-spot').textContent = '?';
  }
}

async function fetchComputeScores() {
  try {
    const r = await fetch(`${API}/compute-scores`);
    const d = await r.json();
    const scores = d.scores || {};
    document.getElementById('score-table').innerHTML = Object.entries(scores).map(([hid, s]) =>
      `<tr><td>${hid}</td><td>${s.gpu_model}</td><td>${s.score.toFixed(1)}</td></tr>`
    ).join('');
  } catch(e) {}
}

// ‚îÄ‚îÄ Trust & Verification fetchers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchVerification() {
  try {
    const r = await fetch(`${API}/api/verified-hosts`);
    const d = await r.json();
    const hosts = d.hosts || [];
    document.getElementById('stat-verified').textContent = hosts.filter(h => h.status === 'verified').length;
    document.getElementById('verification-table').innerHTML = hosts.map(h => {
      const loc = h.country === 'CA' ? `üçÅ ${h.province || 'CA'}` : (h.country || '‚Äî');
      const score = h.overall_score != null ? h.overall_score.toFixed(0) + '%' : '‚Äî';
      const lastCheck = h.last_check ? new Date(h.last_check * 1000).toLocaleString() : '‚Äî';
      const actions = h.status === 'verified'
        ? `<button class="btn btn-secondary" onclick="adminRejectHost('${h.host_id}')" style="font-size:10px;padding:2px 8px">‚úó Reject</button>`
        : `<button class="btn" onclick="adminApproveHost('${h.host_id}')" style="font-size:10px;padding:2px 8px;background:#4caf50">‚úì Approve</button>` +
          (h.status === 'deverified' ? ` <span style="font-size:10px;color:#f44336" title="${h.deverify_reason || ''}">[${h.deverify_reason ? h.deverify_reason.substring(0,30) : ''}]</span>` : '');
      return `<tr><td>${h.host_id}</td><td>${h.gpu_model || '‚Äî'}</td><td>${verBadge(h.status)}</td><td>${score}</td><td>${lastCheck}</td><td>${loc}</td><td>${actions}</td></tr>`;
    }).join('') || '<tr><td colspan="7" style="color:#555">No verification data</td></tr>';
  } catch(e) {
    document.getElementById('verification-table').innerHTML = '<tr><td colspan="7" style="color:#555">Verification unavailable</td></tr>';
  }
}

async function adminApproveHost(hostId) {
  if (!confirm(`Approve host "${hostId}" for verified status?`)) return;
  try {
    const r = await fetch(`${API}/api/verify/${hostId}/approve`, { method: 'POST' });
    const d = await r.json();
    if (d.ok) { alert(`‚úì Host ${hostId} approved.`); refresh(); }
    else alert('Approval failed: ' + JSON.stringify(d));
  } catch(e) { alert('Approval failed: ' + e.message); }
}

async function adminRejectHost(hostId) {
  const reason = prompt(`Reason for rejecting "${hostId}":`);
  if (reason === null) return;
  try {
    const r = await fetch(`${API}/api/verify/${hostId}/reject?reason=${encodeURIComponent(reason || 'Admin rejection')}`, { method: 'POST' });
    const d = await r.json();
    if (d.ok) { alert(`‚úó Host ${hostId} rejected.`); refresh(); }
    else alert('Rejection failed: ' + JSON.stringify(d));
  } catch(e) { alert('Rejection failed: ' + e.message); }
}

async function fetchTransparency() {
  try {
    const r = await fetch(`${API}/api/transparency/report?months=12`);
    const d = await r.json();
    const s = d.summary || {};
    const byType = s.by_type || {};
    const byJurisdiction = s.by_jurisdiction || {};
    const typeRows = Object.entries(byType).map(([k,v]) => `<span style="color:#ff3333">${k}</span>: ${v}`).join(' ¬∑ ') || 'None';
    const jurisdRows = Object.entries(byJurisdiction).map(([k,v]) => `<span style="color:#4caf50">${k}</span>: ${v}`).join(' ¬∑ ') || 'None';

    // Simple bar chart for request types
    const maxVal = Math.max(1, ...Object.values(byType));
    const bars = Object.entries(byType).map(([k,v]) =>
      `<div style="margin:4px 0"><span style="display:inline-block;width:100px;font-size:11px;color:#888">${k}</span><div style="display:inline-block;background:#ff3333;height:14px;width:${(v/maxVal)*150}px;border-radius:2px;vertical-align:middle"></div> <span style="font-size:11px;color:#666">${v}</span></div>`
    ).join('');

    document.getElementById('transparency-report').innerHTML = `
      <div style="margin-bottom:8px">
        <strong style="color:#e0e0e0">12-Month Summary</strong>
        <span style="font-size:10px;color:#444;margin-left:8px">${d.cloud_act_note ? 'üõ°Ô∏è CLOUD Act diligence' : ''}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px">
        <div>üì® Requests received: <strong style="color:#e0e0e0">${s.requests_received || 0}</strong></div>
        <div>‚úÖ Complied: <strong style="color:#4caf50">${s.complied || 0}</strong></div>
        <div>‚öñÔ∏è Challenged: <strong style="color:#ff9800">${s.challenged || 0}</strong></div>
        <div>‚è≥ Pending: <strong style="color:#666">${s.pending || 0}</strong></div>
        <div>üìä Data disclosures: <strong style="color:#e0e0e0">${s.data_disclosures || 0}</strong></div>
      </div>
      ${bars ? '<div style="margin-top:8px"><div style="font-size:10px;color:#555;text-transform:uppercase;margin-bottom:4px">By Type</div>' + bars + '</div>' : ''}
      <div style="margin-top:8px;font-size:11px;color:#555">By Jurisdiction: ${jurisdRows}</div>
      <div style="margin-top:6px;font-size:10px;color:#333">Canary: ${d.canary || 'Xcelsior has not received any national security letters or secret court orders.'}</div>
    `;
  } catch(e) {
    document.getElementById('transparency-report').innerHTML = '<p style="color:#555">Transparency data unavailable</p>';
  }
}

async function fetchReputation() {
  try {
    const r = await fetch(`${API}/api/reputation/leaderboard?limit=20`);
    const d = await r.json();
    const lb = d.leaderboard || [];
    const avg = lb.length ? (lb.reduce((s, h) => s + h.score, 0) / lb.length).toFixed(0) : '‚Äî';
    document.getElementById('stat-reputation-avg').textContent = avg;
    document.getElementById('reputation-table').innerHTML = lb.map((h, i) =>
      `<tr><td>${h.host_id}</td><td>${h.score}</td><td><span class="tooltip-wrap">${repTier(h.tier)}<span class="tooltip-text">${repTooltip(h)}</span></span></td><td>${h.jobs_completed || 0}</td><td>${h.reliability ? (h.reliability * 100).toFixed(0) + '%' : '‚Äî'}</td></tr>`
    ).join('') || '<tr><td colspan="5" style="color:#555">No reputation data</td></tr>';
  } catch(e) {
    document.getElementById('reputation-table').innerHTML = '<tr><td colspan="5" style="color:#555">Reputation unavailable</td></tr>';
  }
}

async function fetchTrustTiers() {
  try {
    const r = await fetch(`${API}/api/trust-tiers`);
    const d = await r.json();
    const tiers = d.tiers || [];
    document.getElementById('trust-tier-table').innerHTML = tiers.map(t =>
      `<tr><td>${t.name}</td><td>${t.pricing_multiplier ? t.pricing_multiplier.toFixed(1) + 'x' : '‚Äî'}</td><td>${t.requirements || '‚Äî'}</td></tr>`
    ).join('') || '<tr><td colspan="3" style="color:#555">No tier data</td></tr>';
  } catch(e) {
    document.getElementById('trust-tier-table').innerHTML = '<tr><td colspan="3" style="color:#555">Trust tiers unavailable</td></tr>';
  }
}

async function fetchJurisdiction() {
  try {
    const r = await fetch(`${API}/hosts?active_only=false`);
    const d = await r.json();
    const hosts = d.hosts || [];
    const ca = hosts.filter(h => (h.country || '').toUpperCase() === 'CA');
    const total = hosts.length;
    document.getElementById('jurisdiction-info').innerHTML = `
      <p><strong>Total Hosts:</strong> ${total}</p>
      <p><strong>üçÅ Canadian Hosts:</strong> ${ca.length} (${total ? ((ca.length / total) * 100).toFixed(0) : 0}%)</p>
      <p><strong>Provinces:</strong> ${[...new Set(ca.map(h => h.province || 'Unknown'))].join(', ') || 'N/A'}</p>
      <p style="margin-top:8px;font-size:11px;color:#666">Canada-first routing applies 10% sovereignty premium.<br>AI Compute Access Fund reimburses 67% for Canadian providers.</p>
    `;
  } catch(e) {
    document.getElementById('jurisdiction-info').innerHTML = '<p style="color:#555">Jurisdiction data unavailable</p>';
  }
}

// ‚îÄ‚îÄ Billing & Fund fetchers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchPricing() {
  try {
    const r = await fetch(`${API}/api/pricing/reference`);
    const d = await r.json();
    const rates = d.rates || d;
    document.getElementById('pricing-table').innerHTML = Object.entries(rates).map(([gpu, p]) =>
      `<tr><td>${gpu}</td><td>$${p.base_cad_per_hour?.toFixed(2) || '‚Äî'}</td><td>$${p.subsidized?.toFixed(2) || '‚Äî'}</td><td>$${p.premium?.toFixed(2) || '‚Äî'}</td><td>$${p.min?.toFixed(2) || '‚Äî'}</td><td>$${p.max?.toFixed(2) || '‚Äî'}</td></tr>`
    ).join('') || '<tr><td colspan="6" style="color:#555">No pricing data</td></tr>';
  } catch(e) {
    document.getElementById('pricing-table').innerHTML = '<tr><td colspan="6" style="color:#555">Pricing unavailable</td></tr>';
  }
}

async function fetchFundStats() {
  try {
    const r = await fetch(`${API}/api/billing/attestation`);
    const d = await r.json();
    document.getElementById('stat-fund-eligible').textContent = '$' + (d.total_eligible_cad || 0).toFixed(2);
    document.getElementById('stat-ca-compute').textContent = '$' + (d.canadian_compute_cad || 0).toFixed(2);
    document.getElementById('stat-effective-cost').textContent = '$' + (d.effective_cost_cad || 0).toFixed(2);
    document.getElementById('attestation-info').innerHTML = `
      <p><strong>Supplier:</strong> ${d.supplier || 'Xcelsior Compute Inc.'}</p>
      <p><strong>Period:</strong> ${d.period || 'Current billing cycle'}</p>
      <p><strong>Canadian Provider Rate:</strong> ${d.ca_reimbursement_rate || '67%'}</p>
      <p><strong>Non-Canadian Rate:</strong> ${d.intl_reimbursement_rate || '50%'}</p>
      <p style="margin-top:8px"><strong>Total Compute (CAD):</strong> $${(d.total_compute_cad || 0).toFixed(2)}</p>
      <p><strong>Fund Eligible:</strong> $${(d.total_eligible_cad || 0).toFixed(2)}</p>
    `;
  } catch(e) {
    document.getElementById('attestation-info').innerHTML = '<p style="color:#555">Attestation unavailable</p>';
  }
}

async function estimateCost() {
  const gpu = document.getElementById('est-gpu').value;
  const hours = parseFloat(document.getElementById('est-hours').value) || 1;
  const spot = document.getElementById('est-spot').checked;
  const sovereign = document.getElementById('est-sov').checked;
  const resultEl = document.getElementById('est-result');
  resultEl.innerHTML = 'Estimating...';
  try {
    const r = await fetch(`${API}/api/pricing/estimate`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({gpu_model: gpu, hours: hours, spot: spot, canada_only: sovereign})
    });
    const d = await r.json();
    resultEl.innerHTML = `
      <strong>Estimated Cost: $${(d.total_cad || d.estimated_cost || 0).toFixed(2)} CAD</strong><br>
      Rate: $${(d.rate_per_hour || 0).toFixed(2)}/hr
      ${d.fund_rebate ? `<br><span class="fund-highlight">Fund Rebate: -$${d.fund_rebate.toFixed(2)}</span>` : ''}
      ${d.effective_cost ? `<br>Effective: $${d.effective_cost.toFixed(2)} CAD` : ''}
      ${spot ? '<br><span style="color:#ff9800">‚ö° Spot pricing applied</span>' : ''}
      ${sovereign ? '<br><span style="color:#ff3333">üçÅ Sovereignty premium applied</span>' : ''}
    `;
  } catch(e) {
    resultEl.innerHTML = '<span style="color:#f44">Estimate failed</span>';
  }
}

// ‚îÄ‚îÄ GPU Telemetry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let telemetryInterval = null;

function startTelemetryPolling() {
  if (telemetryInterval) return;
  fetchTelemetry();
  telemetryInterval = setInterval(fetchTelemetry, 5000);
}
function stopTelemetryPolling() {
  if (telemetryInterval) { clearInterval(telemetryInterval); telemetryInterval = null; }
}

async function fetchTelemetry() {
  try {
    const r = await fetch(`${API}/api/telemetry/all`);
    const d = await r.json();
    const entries = Object.entries(d.telemetry || d || {});
    document.getElementById('stat-telem-hosts').textContent = entries.length;
    if (entries.length === 0) {
      document.getElementById('telemetry-table').innerHTML = '';
      document.getElementById('telemetry-empty').style.display = '';
      document.getElementById('stat-avg-util').textContent = '‚Äî';
      document.getElementById('stat-avg-temp').textContent = '‚Äî';
      document.getElementById('stat-mem-errors').textContent = '0';
      document.getElementById('util-histogram').innerHTML = '<span style="color:#555">No data</span>';
      document.getElementById('thermal-summary').innerHTML = '<span style="color:#555">No data</span>';
      return;
    }
    document.getElementById('telemetry-empty').style.display = 'none';

    let totalUtil = 0, totalTemp = 0, totalErrors = 0;
    const utilBuckets = [0,0,0,0,0]; // 0-20,20-40,40-60,60-80,80-100

    const rows = entries.map(([hid, t]) => {
      const util = t.gpu_utilization ?? t.utilization ?? 0;
      const temp = t.temperature ?? t.temp ?? 0;
      const memUsed = t.memory_used_mb ?? 0;
      const memTotal = t.memory_total_mb ?? 1;
      const memPct = memTotal > 0 ? ((memUsed / memTotal) * 100) : 0;
      const power = t.power_draw_w ?? t.power ?? 0;
      const ecc = t.ecc_errors ?? t.memory_errors ?? 0;
      const gpu = t.gpu_model ?? '‚Äî';
      const ts = t.timestamp ? new Date(t.timestamp * 1000).toLocaleTimeString() : (t.last_seen || '‚Äî');

      totalUtil += util;
      totalTemp += temp;
      totalErrors += ecc;
      const bucket = Math.min(Math.floor(util / 20), 4);
      utilBuckets[bucket]++;

      return `<tr>
        <td>${hid}</td>
        <td>${gpu}</td>
        <td><div class="gauge-bar"><div class="gauge-fill util" style="width:${util}%"></div><span class="gauge-label">Util</span><span class="gauge-val">${util.toFixed(0)}%</span></div></td>
        <td><div class="gauge-bar"><div class="gauge-fill temp" style="width:${Math.min(temp / 100 * 100, 100)}%"></div><span class="gauge-label">¬∞C</span><span class="gauge-val">${temp}¬∞C</span></div></td>
        <td><div class="gauge-bar"><div class="gauge-fill mem" style="width:${memPct.toFixed(0)}%"></div><span class="gauge-label">Mem</span><span class="gauge-val">${(memUsed/1024).toFixed(1)}/${(memTotal/1024).toFixed(1)}GB</span></div></td>
        <td>${power}W</td>
        <td>${ecc > 0 ? '<span style="color:#f44336;font-weight:bold">' + ecc + '</span>' : '<span style="color:#4caf50">0</span>'}</td>
        <td style="font-size:11px;color:#666">${ts}</td>
      </tr>`;
    });

    document.getElementById('telemetry-table').innerHTML = rows.join('');
    document.getElementById('stat-avg-util').textContent = (totalUtil / entries.length).toFixed(0) + '%';
    document.getElementById('stat-avg-temp').textContent = (totalTemp / entries.length).toFixed(0) + '¬∞C';
    document.getElementById('stat-mem-errors').textContent = totalErrors;

    // Utilization histogram (ASCII-style bars)
    const maxBucket = Math.max(...utilBuckets, 1);
    const labels = ['0-20%', '20-40%', '40-60%', '60-80%', '80-100%'];
    const colors = ['#4caf50', '#8bc34a', '#ff9800', '#ff5722', '#f44336'];
    document.getElementById('util-histogram').innerHTML = labels.map((l, i) => {
      const w = (utilBuckets[i] / maxBucket * 100).toFixed(0);
      return `<div style="margin:3px 0"><span style="display:inline-block;width:55px;color:#888">${l}</span><div class="gauge-bar" style="display:inline-block;width:calc(100% - 80px);vertical-align:middle"><div style="height:100%;width:${w}%;background:${colors[i]};border-radius:3px"></div></div> <span style="color:#aaa;font-size:11px">${utilBuckets[i]}</span></div>`;
    }).join('');

    // Thermal summary
    const cold = entries.filter(([,t]) => (t.temperature ?? t.temp ?? 0) < 50).length;
    const warm = entries.filter(([,t]) => { const v = t.temperature ?? t.temp ?? 0; return v >= 50 && v < 75; }).length;
    const hot = entries.filter(([,t]) => (t.temperature ?? t.temp ?? 0) >= 75).length;
    document.getElementById('thermal-summary').innerHTML = `
      <div style="margin:4px 0"><span style="color:#2196f3">‚ùÑÔ∏è Cool (&lt;50¬∞C):</span> <strong>${cold}</strong> hosts</div>
      <div style="margin:4px 0"><span style="color:#ff9800">üå°Ô∏è Warm (50-75¬∞C):</span> <strong>${warm}</strong> hosts</div>
      <div style="margin:4px 0"><span style="color:#f44336">üî• Hot (&gt;75¬∞C):</span> <strong>${hot}</strong> hosts</div>
      ${hot > 0 ? '<div style="margin-top:8px;color:#f44336;font-size:11px">‚ö†Ô∏è Check cooling on hot hosts to prevent thermal throttling.</div>' : ''}
    `;
  } catch(e) {
    document.getElementById('telemetry-table').innerHTML = '';
    document.getElementById('telemetry-empty').style.display = '';
    document.getElementById('telemetry-empty').textContent = 'Telemetry endpoint unavailable: ' + e.message;
  }
}

// ‚îÄ‚îÄ My Earnings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchEarnings() {
  try {
    // Fetch billing data to compute earnings per host
    const br = await fetch(`${API}/billing`);
    const bd = await br.json();
    const records = bd.records || [];

    // Aggregate by host
    const byHost = {};
    let totalEarned = 0;
    records.forEach(r => {
      const hid = r.host_id || 'unassigned';
      if (!byHost[hid]) byHost[hid] = { jobs: 0, hours: 0, earned: 0, gpu: '‚Äî' };
      byHost[hid].jobs++;
      byHost[hid].hours += (r.duration_sec || 0) / 3600;
      byHost[hid].earned += parseFloat(r.cost) || 0;
      totalEarned += parseFloat(r.cost) || 0;
    });

    document.getElementById('stat-total-earned').textContent = '$' + totalEarned.toFixed(2);
    document.getElementById('stat-pending-payout').textContent = '$' + (totalEarned * 0.15).toFixed(2); // Estimate 15% pending
    document.getElementById('stat-total-payouts').textContent = records.length;

    // Utilization rate: compute total hours running / total hours possible
    const hostCount = Object.keys(byHost).length || 1;
    const totalHours = Object.values(byHost).reduce((s, h) => s + h.hours, 0);
    const utilRate = hostCount > 0 ? ((totalHours / (hostCount * 24)) * 100) : 0;
    document.getElementById('stat-utilization-rate').textContent = Math.min(utilRate, 100).toFixed(0) + '%';

    document.getElementById('earnings-by-host-table').innerHTML = Object.entries(byHost).map(([hid, h]) =>
      `<tr><td>${hid}</td><td>${h.gpu}</td><td>${h.jobs}</td><td>${h.hours.toFixed(1)}</td><td class="fund-highlight">$${h.earned.toFixed(2)}</td></tr>`
    ).join('') || '<tr><td colspan="5" style="color:#555">No earnings data</td></tr>';

    // Simple payouts table (placeholder ‚Äî real impl would call /api/billing/payouts)
    document.getElementById('payouts-table').innerHTML = totalEarned > 0
      ? `<tr><td>${new Date().toLocaleDateString()}</td><td>All hosts</td><td class="fund-highlight">$${totalEarned.toFixed(2)}</td><td>Wallet Credit</td><td>${s('completed')}</td></tr>`
      : '<tr><td colspan="5" style="color:#555">No payouts yet</td></tr>';

    document.getElementById('earnings-by-period-table').innerHTML =
      `<tr><td>Current cycle</td><td>$${totalEarned.toFixed(2)}</td><td>$${(totalEarned * 0.67).toFixed(2)}</td><td>$${(totalEarned * 0.33).toFixed(2)}</td></tr>`;

  } catch(e) {
    document.getElementById('earnings-by-host-table').innerHTML = '<tr><td colspan="5" style="color:#555">Earnings unavailable</td></tr>';
  }
}

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}
function showAddHostForm() {
  document.getElementById('add-host-modal').classList.add('active');
  autoFillVram();
  toggleProvinceField();
}
function showSubmitJobForm() {
  document.getElementById('submit-job-modal').classList.add('active');
  updateCostEstimate();
}
function showProviderRegForm() {
  document.getElementById('provider-reg-modal').classList.add('active');
  toggleCorpFields();
}

// ‚îÄ‚îÄ Form UX: auto-fill VRAM from GPU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function autoFillVram() {
  const sel = document.getElementById('ah-gpu');
  const opt = sel.options[sel.selectedIndex];
  const vram = opt.getAttribute('data-vram');
  if (vram) document.getElementById('ah-vram').value = vram;
}

// ‚îÄ‚îÄ Form UX: show/hide province when country=CA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleProvinceField() {
  const country = document.getElementById('ah-country').value;
  const pg = document.getElementById('ah-province-group');
  pg.style.display = country === 'CA' ? '' : 'none';
  if (country !== 'CA') document.getElementById('ah-province').value = '';
}

// ‚îÄ‚îÄ Form UX: show/hide corp fields for provider registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleCorpFields() {
  const t = document.getElementById('pr-type').value;
  document.getElementById('pr-corp-fields').style.display = t === 'company' ? '' : 'none';
}

// ‚îÄ‚îÄ Form UX: cost estimate for Submit Job ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCostEstimate() {
  const tier = document.getElementById('sj-tier').value;
  const trust = document.getElementById('sj-trust').value;
  const rates = { free: 0, standard: 0.10, premium: 0.45, urgent: 1.20 };
  const trustMultiplier = { community: 1.0, residency: 1.1, sovereignty: 1.3, regulated: 1.5 };
  const base = rates[tier] || 0.10;
  const mult = trustMultiplier[trust] || 1.0;
  const est = base * mult;
  const el = document.getElementById('sj-est-value');
  if (tier === 'free') {
    el.textContent = 'Free (best-effort)';
    el.style.color = '#4caf50';
  } else {
    el.textContent = `~$${est.toFixed(2)}/hr CAD`;
    el.style.color = '#4caf50';
  }
}

// ‚îÄ‚îÄ Onboarding ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkOnboarding() {
  if (!localStorage.getItem('xcelsior_role')) {
    document.getElementById('onboarding-modal').classList.add('active');
  }
}
function setRole(role) {
  localStorage.setItem('xcelsior_role', role);
  sessionStorage.setItem('xcelsior_role', role);
  closeModal('onboarding-modal');
  // Show/hide admin tab
  const adminBtn = document.getElementById('admin-tab-btn');
  if (adminBtn) adminBtn.style.display = (role === 'admin') ? '' : 'none';
  if (role === 'admin') loadAdminPanel();
}

// ‚îÄ‚îÄ Form validation helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function validateRequired(fields) {
  let valid = true;
  fields.forEach(({id, msg}) => {
    const el = document.getElementById(id);
    const val = el.value.trim();
    const group = el.closest('.form-group');
    if (!val) {
      group.classList.add('error');
      const hint = group.querySelector('.hint');
      if (hint) hint.textContent = msg || 'Required';
      valid = false;
    } else {
      group.classList.remove('error');
    }
  });
  return valid;
}

// ‚îÄ‚îÄ Add Host submission ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitHost() {
  if (!validateRequired([
    {id: 'ah-id', msg: 'Host ID is required'},
    {id: 'ah-ip', msg: 'IP address is required'},
  ])) return;
  const data = {
    host_id: document.getElementById('ah-id').value.trim(),
    ip: document.getElementById('ah-ip').value.trim(),
    gpu_model: document.getElementById('ah-gpu').value,
    total_vram_gb: parseInt(document.getElementById('ah-vram').value) || 24,
    free_vram_gb: parseInt(document.getElementById('ah-vram').value) || 24,
    cost_per_hour: parseFloat(document.getElementById('ah-cost').value) || 0.45,
    country: document.getElementById('ah-country').value || 'CA',
    province: document.getElementById('ah-province').value || '',
  };
  try {
    const r = await fetch(`${API}/host`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
    const d = await r.json();
    closeModal('add-host-modal');
    alert(d.admitted ? '‚úì Host admitted ‚Äî status: active' : '‚è≥ Host registered as pending. Start the worker agent to complete admission.');
    refresh();
  } catch(e) {
    alert('Registration failed: ' + e.message);
  }
}

// ‚îÄ‚îÄ Provider Registration submission ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitProviderReg() {
  const fields = [
    {id: 'pr-id', msg: 'Provider ID is required'},
    {id: 'pr-email', msg: 'Email is required'},
    {id: 'pr-province', msg: 'Province is required'},
  ];
  const isCompany = document.getElementById('pr-type').value === 'company';
  if (isCompany) {
    fields.push({id: 'pr-corp', msg: 'Corporation name is required'});
    fields.push({id: 'pr-legal', msg: 'Legal name is required'});
  }
  if (!validateRequired(fields)) return;
  const data = {
    provider_id: document.getElementById('pr-id').value.trim(),
    email: document.getElementById('pr-email').value.trim(),
    provider_type: document.getElementById('pr-type').value,
    province: document.getElementById('pr-province').value,
    corporation_name: isCompany ? document.getElementById('pr-corp').value.trim() : '',
    legal_name: isCompany ? document.getElementById('pr-legal').value.trim() : '',
    business_number: document.getElementById('pr-bn').value.trim(),
    gst_hst_number: document.getElementById('pr-gst').value.trim(),
  };
  try {
    const r = await fetch(`${API}/api/providers/register`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
    if (!r.ok) throw new Error((await r.json()).detail || r.statusText);
    closeModal('provider-reg-modal');
    alert('‚úì Provider registered successfully! You can now add GPU hosts.');
    refresh();
  } catch(e) {
    alert('Registration failed: ' + e.message);
  }
}

// ‚îÄ‚îÄ Submit Job ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitJob() {
  if (!validateRequired([{id: 'sj-name', msg: 'Job name is required'}])) return;
  const data = {
    name: document.getElementById('sj-name').value.trim(),
    vram_needed_gb: parseInt(document.getElementById('sj-vram').value) || 8,
    tier: document.getElementById('sj-tier').value,
    trust_tier: document.getElementById('sj-trust').value,
    docker_image: document.getElementById('sj-image').value.trim() || undefined,
  };
  try {
    await fetch(`${API}/job`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
    closeModal('submit-job-modal');
    refresh();
  } catch(e) {
    alert('Job submission failed: ' + e.message);
  }
}

// ‚îÄ‚îÄ Export Rebate Docs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportRebateDocs() {
  try {
    const r = await fetch(`${API}/api/billing/export/caf/default`);
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'xcelsior_caf_export.csv';
    a.click();
    URL.revokeObjectURL(url);
  } catch(e) {
    alert('Export failed. Ensure billing records exist.');
  }
}

// ‚îÄ‚îÄ Event log fetcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchEventLog() {
  try {
    const r = await fetch(`${API}/api/events/leases/all`);
    const d = await r.json();
    const events = d.events || [];
    document.getElementById('event-log-full').innerHTML = events.slice(0, 200).map(ev =>
      `<div style="border-bottom:1px solid #1a1a1a;padding:2px 0">
        <span style="color:#444">${ev.timestamp || '‚Äî'}</span>
        <span style="color:#ff3333">${ev.event_type || ev.type || '‚Äî'}</span>
        <span>${ev.entity_id || ev.job_id || ''}</span>
        <span style="color:#666">${JSON.stringify(ev.data || ev.details || {}).substring(0, 150)}</span>
      </div>`
    ).join('') || '<div style="color:#555">No events recorded</div>';
  } catch(e) {
    document.getElementById('event-log-full').innerHTML = '<div style="color:#555">Event log unavailable</div>';
  }
}

// ‚îÄ‚îÄ Sovereign queue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function processQueueSovereign() {
  try {
    await fetch(`${API}/api/queue/process-sovereign`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({canada_only: true})
    });
  } catch(e) {}
  refresh();
}

async function refresh() {
  await Promise.all([
    fetchHosts(), fetchJobs(), fetchBilling(), fetchMarketplace(), fetchPool(), fetchSpotPrices(), fetchComputeScores(),
    fetchVerification(), fetchReputation(), fetchTrustTiers(), fetchJurisdiction(), fetchTransparency(),
    fetchPricing(), fetchFundStats(), fetchEventLog(), fetchEarnings(),
    fetchTransactionHistoryFiltered(), fetchAnalytics(), fetchMarketplaceStats(), fetchInvoices(),
    fetchSlurmProfiles()
  ]);
}

async function processQueue() {
  await fetch(`${API}/queue/process`, { method: 'POST' });
  refresh();
}

async function billAll() {
  await fetch(`${API}/billing/bill-all`, { method: 'POST' });
  refresh();
}

async function pingHosts() {
  await fetch(`${API}/hosts/check`, { method: 'POST' });
  refresh();
}

async function runFailover() {
  await fetch(`${API}/failover`, { method: 'POST' });
  refresh();
}

async function runAutoscale() {
  await fetch(`${API}/autoscale/cycle`, { method: 'POST' });
  refresh();
}

// ‚îÄ‚îÄ SSE (Server-Sent Events) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let evtSource = null;
const eventLog = document.getElementById('event-log');
const sseStatus = document.getElementById('sse-status');
const MAX_LOG_ENTRIES = 100;

function addLogEntry(event, data) {
  const time = new Date().toLocaleTimeString();
  const el = document.createElement('div');
  el.style.borderBottom = '1px solid #1a1a1a';
  el.style.padding = '2px 0';
  el.innerHTML = `<span style="color:#444">${time}</span> <span style="color:#ff3333">${event}</span> ${JSON.stringify(data).substring(0, 200)}`;
  eventLog.prepend(el);
  // Trim old entries
  while (eventLog.children.length > MAX_LOG_ENTRIES) {
    eventLog.removeChild(eventLog.lastChild);
  }
}

// ‚îÄ‚îÄ Per-Job Log Streaming ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let jobLogSource = null;

function streamJobLogs(jobId) {
  document.getElementById('jl-job-id').value = jobId;
  showTab('job-logs');
  // Find and activate the tab button
  document.querySelectorAll('.tab-btn').forEach(b => {
    if (b.textContent.includes('Job Logs')) b.classList.add('active');
    else b.classList.remove('active');
  });
  startJobLogStream();
}

function startJobLogStream() {
  const jobId = document.getElementById('jl-job-id').value.trim();
  if (!jobId) { alert('Enter a Job ID'); return; }
  stopJobLogStream();

  const output = document.getElementById('job-log-output');
  const status = document.getElementById('jl-status');
  output.innerHTML = '';
  status.textContent = '‚è≥ connecting...';
  status.style.color = '#ff9800';

  jobLogSource = new EventSource(`${API}/jobs/${jobId}/logs/stream`);

  jobLogSource.addEventListener('connected', function(e) {
    status.textContent = 'üü¢ streaming';
    status.style.color = '#4caf50';
  });

  jobLogSource.addEventListener('job_log', function(e) {
    const data = JSON.parse(e.data);
    const ts = new Date(data.timestamp * 1000).toLocaleTimeString();
    const levelColor = data.level === 'error' ? '#ff3333' : data.level === 'warn' ? '#ff9800' : '#888';
    const el = document.createElement('div');
    el.innerHTML = `<span style="color:#555">${ts}</span> <span style="color:${levelColor}">[${data.level}]</span> ${data.line}`;
    output.appendChild(el);
    output.scrollTop = output.scrollHeight;
  });

  jobLogSource.addEventListener('job_status', function(e) {
    const data = JSON.parse(e.data);
    const el = document.createElement('div');
    el.innerHTML = `<span style="color:#2196f3;font-weight:bold">‚îÄ‚îÄ STATUS: ${data.status} ‚îÄ‚îÄ</span>`;
    output.appendChild(el);
    output.scrollTop = output.scrollHeight;
    if (data.status === 'completed' || data.status === 'failed') {
      status.textContent = `‚èπ ${data.status}`;
      status.style.color = data.status === 'completed' ? '#4caf50' : '#ff3333';
    }
  });

  jobLogSource.onerror = function() {
    status.textContent = 'üî¥ disconnected';
    status.style.color = '#ff3333';
  };
}

function stopJobLogStream() {
  if (jobLogSource) { jobLogSource.close(); jobLogSource = null; }
  const status = document.getElementById('jl-status');
  if (status) { status.textContent = '‚èπ stopped'; status.style.color = '#666'; }
}

function connectSSE() {
  if (evtSource) { evtSource.close(); }

  evtSource = new EventSource(`${API}/api/stream`);

  evtSource.addEventListener('connected', function(e) {
    sseStatus.textContent = 'üü¢ live';
    sseStatus.style.color = '#4caf50';
    addLogEntry('connected', JSON.parse(e.data));
  });

  // Refresh on data-changing events
  const refreshEvents = [
    'host_update', 'host_removed', 'job_submitted', 'job_status',
    'queue_processed', 'spot_prices_updated', 'spot_job_submitted',
    'benchmark_result', 'node_admission',
    'verification_updated', 'reputation_change', 'lease_started', 'lease_ended',
  ];
  refreshEvents.forEach(evt => {
    evtSource.addEventListener(evt, function(e) {
      const data = JSON.parse(e.data);
      addLogEntry(evt, data);
      refresh();  // Update all panels on any event
    });
  });

  // Alert events (don't refresh, just log + toast)
  evtSource.addEventListener('mining_alert', function(e) {
    const data = JSON.parse(e.data);
    addLogEntry('‚ö†Ô∏è MINING ALERT', data);
    handleMiningAlert(data);
  });

  evtSource.addEventListener('sla_violation', function(e) {
    const data = JSON.parse(e.data);
    addLogEntry('‚ö†Ô∏è SLA VIOLATION', data);
    handleSLAViolation(data);
  });

  evtSource.addEventListener('preemption_scheduled', function(e) {
    const data = JSON.parse(e.data);
    addLogEntry('‚ö†Ô∏è PREEMPTION', data);
    refresh();
  });

  // Telemetry events ‚Äî update GPU gauge panel if visible
  evtSource.addEventListener('telemetry_update', function(e) {
    const data = JSON.parse(e.data);
    addLogEntry('üìä telemetry', data);
    if (document.getElementById('tab-telemetry').style.display !== 'none') {
      fetchTelemetry();
    }
  });

  evtSource.addEventListener('node_admission', function(e) {
    const data = JSON.parse(e.data);
    addLogEntry('üîê admission', data);
    refresh();
  });

  evtSource.onerror = function() {
    sseStatus.textContent = 'üî¥ disconnected';
    sseStatus.style.color = '#f44336';
    // EventSource auto-reconnects, but let's update status
    setTimeout(() => {
      if (evtSource.readyState === EventSource.CONNECTING) {
        sseStatus.textContent = 'üü° reconnecting...';
        sseStatus.style.color = '#ff9800';
      }
    }, 1000);
  };
}

// Initial load
checkAuth();

// Fallback polling (in case SSE is not available or disconnected)
setInterval(() => {
  if (!evtSource || evtSource.readyState === EventSource.CLOSED) {
    refresh();
  }
}, 10000);

// ‚îÄ‚îÄ Auth / Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser = null;

function checkAuth() {
  const token = sessionStorage.getItem('xcelsior_token');
  const devMode = localStorage.getItem('xcelsior_dev_mode');
  if (token || devMode) {
    showApp();
  } else {
    document.getElementById('login-page').classList.add('active');
    document.getElementById('main-app').style.display = 'none';
  }
}

function showApp() {
  document.getElementById('login-page').classList.remove('active');
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('main-app').style.display = '';
  // Show admin tab for admin role
  const role = localStorage.getItem('xcelsior_role') || sessionStorage.getItem('xcelsior_role') || 'submitter';
  const adminBtn = document.getElementById('admin-tab-btn');
  if (adminBtn) adminBtn.style.display = (role === 'admin') ? '' : 'none';
  if (role === 'admin') loadAdminPanel();
  refresh();
  connectSSE();
  checkOnboarding();
  fetchWalletBalance();
  loadUserProfile();
  startSessionCheck();
}

function oauthLogin(provider) {
  showToast(`Signing in with ${provider}...`, 'info');
  fetch(`${API}/api/auth/oauth/${provider}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}' })
    .then(r => r.json())
    .then(d => {
      if (d.ok && d.access_token) {
        sessionStorage.setItem('xcelsior_token', d.access_token);
        sessionStorage.setItem('xcelsior_provider', provider);
        if (d.user) {
          sessionStorage.setItem('xcelsior_email', d.user.email || '');
          sessionStorage.setItem('xcelsior_role', d.user.role || 'submitter');
          localStorage.setItem('xcelsior_customer_id', d.user.customer_id || '');
          localStorage.setItem('xcelsior_role', d.user.role || 'submitter');
        }
        sessionStorage.setItem('xcelsior_login_time', String(Math.floor(Date.now()/1000)));
        showToast(`Signed in via ${provider}`, 'success');
        setTimeout(() => showApp(), 300);
      } else { showToast(d.detail || 'OAuth failed', 'error'); }
    })
    .catch(() => {
      // Fallback to simulated login if backend not available
      sessionStorage.setItem('xcelsior_token', `dev-${provider}-${Date.now()}`);
      sessionStorage.setItem('xcelsior_provider', provider);
      showToast(`OAuth with ${provider} (dev mode)`, 'success');
      setTimeout(() => showApp(), 300);
    });
}

function emailLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email) { showToast('Email is required', 'error'); return; }
  if (!password) { showToast('Password is required', 'error'); return; }
  fetch(`${API}/api/auth/login`, {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ email, password })
  })
    .then(r => r.json())
    .then(d => {
      if (d.ok && d.access_token) {
        sessionStorage.setItem('xcelsior_token', d.access_token);
        sessionStorage.setItem('xcelsior_email', email);
        if (d.user) {
          sessionStorage.setItem('xcelsior_role', d.user.role || 'submitter');
          localStorage.setItem('xcelsior_customer_id', d.user.customer_id || '');
          localStorage.setItem('xcelsior_role', d.user.role || 'submitter');
        }
        sessionStorage.setItem('xcelsior_login_time', String(Math.floor(Date.now()/1000)));
        showToast(`Signed in as ${email}`, 'success');
        setTimeout(() => showApp(), 300);
      } else { showToast(d.detail || 'Invalid credentials', 'error'); }
    })
    .catch(() => {
      // Fallback to dev mode
      sessionStorage.setItem('xcelsior_token', `dev-email-${Date.now()}`);
      sessionStorage.setItem('xcelsior_email', email);
      showToast(`Signed in as ${email} (dev mode)`, 'success');
      setTimeout(() => showApp(), 300);
    });
}

function toggleSignup() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email) { showToast('Email is required', 'error'); return; }
  if (!password || password.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }
  fetch(`${API}/api/auth/register`, {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ email, password })
  })
    .then(r => r.json())
    .then(d => {
      if (d.ok && d.access_token) {
        sessionStorage.setItem('xcelsior_token', d.access_token);
        sessionStorage.setItem('xcelsior_email', email);
        if (d.user) {
          sessionStorage.setItem('xcelsior_role', d.user.role || 'submitter');
          localStorage.setItem('xcelsior_customer_id', d.user.customer_id || '');
          localStorage.setItem('xcelsior_role', d.user.role || 'submitter');
        }
        showToast(`Account created! Welcome ${d.user?.name || email}`, 'success');
        setTimeout(() => showApp(), 300);
      } else { showToast(d.detail || 'Registration failed', 'error'); }
    })
    .catch(() => { showToast('Sign up failed ‚Äî try dev mode', 'error'); });
}

function skipLogin() {
  localStorage.setItem('xcelsior_dev_mode', '1');
  showToast('Dev mode ‚Äî no auth required', 'warning');
  showApp();
}

function doLogout() {
  sessionStorage.clear();
  localStorage.removeItem('xcelsior_dev_mode');
  location.reload();
}

function toggleUserMenu() {
  document.getElementById('user-dropdown').classList.toggle('active');
}
function closeUserMenu() {
  document.getElementById('user-dropdown').classList.remove('active');
}
// Close dropdown on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.user-menu')) closeUserMenu();
});

function loadUserProfile() {
  const email = sessionStorage.getItem('xcelsior_email') || '';
  const provider = sessionStorage.getItem('xcelsior_provider') || '';
  const role = localStorage.getItem('xcelsior_role') || 'submitter';
  const avatar = document.getElementById('user-avatar');
  if (email) {
    avatar.textContent = email[0].toUpperCase();
  } else if (provider) {
    const icons = { google: 'G', github: '‚å•', huggingface: 'ü§ó' };
    avatar.textContent = icons[provider] || '?';
  }
  // Settings tab
  document.getElementById('set-email').value = email || `dev@xcelsior.ca`;
  document.getElementById('set-customer-id').value = `cust-${(email || 'dev').replace(/[^a-z0-9]/gi,'').slice(0,8)}`;
  document.getElementById('set-role').value = role;
  // Enhanced profile (avatar, member since)
  loadEnhancedProfile();
  // SSH keys from local storage
  renderSshKeys();
  // Load notification prefs from local storage
  document.getElementById('notif-sound-toggle').checked = localStorage.getItem('xcelsior_notif_sound') === 'true';
  document.getElementById('notif-push-toggle').checked = localStorage.getItem('xcelsior_push_notifs') === 'true';
  // Load teams & notification prefs
  fetchMyTeams();
  loadNotificationPrefs();
  // Load score breakdown & history
  const custId = document.getElementById('set-customer-id')?.value || 'default';
  fetchScoreBreakdown(custId);
  fetchScoreHistory(custId);
}

// ‚îÄ‚îÄ Wallet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let walletBalance = 0;

async function fetchWalletBalance() {
  try {
    const customerId = document.getElementById('set-customer-id')?.value || 'dev';
    const r = await fetch(`${API}/api/billing/wallet/${customerId}`);
    if (r.ok) {
      const d = await r.json();
      walletBalance = d.balance || 0;
    }
  } catch(e) { /* wallet endpoint may not exist in dev */ }
  updateWalletDisplay();
}

function updateWalletDisplay() {
  const el = document.getElementById('wallet-balance');
  el.textContent = `$${walletBalance.toFixed(2)}`;
  el.className = 'amount' + (walletBalance < 5 ? ' critical' : walletBalance < 25 ? ' low' : '');
  checkLowBalance();
}

function showDepositModal() { document.getElementById('deposit-modal').classList.add('active'); }

function setDepositAmount(amt) {
  document.getElementById('deposit-amount').value = amt;
}

async function processDeposit() {
  const amount = parseFloat(document.getElementById('deposit-amount').value);
  if (!amount || amount < 1) { showToast('Minimum deposit is $1', 'error'); return; }
  try {
    const customerId = document.getElementById('set-customer-id')?.value || 'dev';
    const r = await fetch(`${API}/api/billing/wallet/${customerId}/deposit`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ amount, method: 'card' })
    });
    if (r.ok) {
      const d = await r.json();
      walletBalance = d.balance || (walletBalance + amount);
      updateWalletDisplay();
      closeModal('deposit-modal');
      showToast(`Added $${amount.toFixed(2)} credits`, 'success');
    } else {
      // Simulated success for dev
      walletBalance += amount;
      updateWalletDisplay();
      closeModal('deposit-modal');
      showToast(`Added $${amount.toFixed(2)} credits (dev mode)`, 'success');
    }
  } catch(e) {
    walletBalance += amount;
    updateWalletDisplay();
    closeModal('deposit-modal');
    showToast(`Added $${amount.toFixed(2)} credits (offline mode)`, 'warning');
  }
}

// ‚îÄ‚îÄ Host Remove ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function removeHost(hostId) {
  if (!confirm(`Remove host "${hostId}"? This will unlist it from the marketplace.`)) return;
  try {
    const r = await fetch(`${API}/host/${hostId}`, { method: 'DELETE' });
    if (r.ok) { showToast(`Host ${hostId} removed`, 'success'); refresh(); }
    else { showToast('Failed to remove host: ' + (await r.json()).detail, 'error'); }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Job Detail / Cancel / Requeue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentJobId = null;

async function showJobDetail(jobId) {
  currentJobId = jobId;
  document.getElementById('job-detail-modal').classList.add('active');
  const content = document.getElementById('job-detail-content');
  content.innerHTML = 'Loading...';
  try {
    const r = await fetch(`${API}/job/${jobId}`);
    const j = await r.json();
    // Calculate cost breakdown
    let costInfo = '';
    if (j.started_at && (j.completed_at || j.status === 'running')) {
      const start = j.started_at;
      const end = j.completed_at || (Date.now() / 1000);
      const durationHrs = ((end - start) / 3600).toFixed(2);
      const rate = j.rate_per_hour || j.cost_per_hour || 0;
      const cost = (durationHrs * rate).toFixed(4);
      costInfo = `<div style="background:#0a1a0a;border:1px solid #1a3a1a;border-radius:4px;padding:10px;margin:10px 0;font-size:12px">
        <div style="color:#666;font-size:10px;text-transform:uppercase">Cost Breakdown</div>
        <div style="color:#4caf50;font-weight:bold;font-size:16px;margin:4px 0">$${cost} CAD</div>
        <div style="color:#888">${durationHrs} hrs √ó $${rate}/hr</div>
      </div>`;
    }
    const rows = [
      ['Job ID', j.job_id], ['Name', j.name], ['Status', j.status],
      ['Tier', j.tier || 'free'], ['VRAM Needed', `${j.vram_needed_gb} GB`],
      ['Host', j.host_id || '‚Äî'], ['Docker Image', j.docker_image || '‚Äî'],
      ['GPU Count', j.gpu_count || 1], ['Pricing Mode', j.pricing_mode || 'on-demand'],
      ['Created', j.created_at ? new Date(j.created_at * 1000).toLocaleString() : '‚Äî'],
      ['Started', j.started_at ? new Date(j.started_at * 1000).toLocaleString() : '‚Äî'],
      ['Completed', j.completed_at ? new Date(j.completed_at * 1000).toLocaleString() : '‚Äî'],
    ];
    let html = `<div class="detail-tabs">
      <button class="detail-tab active" onclick="showJobDetailTab('overview')">Overview</button>
      <button class="detail-tab" onclick="showJobDetailTab('logs')">üìã Logs</button>
      <button class="detail-tab" onclick="showJobDetailTab('artifacts')">üì¶ Artifacts</button>
      <button class="detail-tab" onclick="showJobDetailTab('audit')">üîó Audit</button>
    </div>`;
    html += `<div id="job-tab-overview">`;
    html += rows.map(([l, v]) =>
      `<div class="detail-row"><span class="label">${l}</span><span class="value">${v}</span></div>`
    ).join('');
    html += costInfo;
    html += `</div>`;
    html += `<div id="job-tab-logs" style="display:none">
      <button class="btn btn-secondary" onclick="fetchJobLogsInDetail('${j.job_id}')" style="font-size:11px;margin-bottom:8px">üìã Load Logs</button>
      <button class="btn btn-secondary" onclick="streamJobLogsInDetail('${j.job_id}')" style="font-size:11px;margin-bottom:8px">‚ñ∂ Stream Live</button>
      <div id="job-detail-logs" class="log-viewer">Click "Load Logs" to view job output.</div>
    </div>`;
    html += `<div id="job-tab-artifacts" style="display:none">
      <div id="job-detail-artifacts" style="font-size:12px;color:#888">Loading artifacts...</div>
    </div>`;
    html += `<div id="job-tab-audit" style="display:none">
      <div id="job-detail-audit" style="font-size:12px;color:#888">Loading audit trail...</div>
    </div>`;
    content.innerHTML = html;
    // Show cancel button for active jobs
    document.getElementById('job-cancel-btn').style.display = (j.status === 'running' || j.status === 'queued') ? '' : 'none';
    document.getElementById('job-requeue-btn').style.display = (j.status === 'failed') ? '' : 'none';
    // Auto-fetch artifacts + audit
    fetchJobArtifactsInDetail(jobId);
    fetchJobAuditInDetail(jobId);
  } catch(e) {
    content.innerHTML = `<p style="color:#f44336">Failed to load job: ${e.message}</p>`;
  }
}

function showJobDetailTab(tab) {
  ['overview', 'logs', 'artifacts', 'audit'].forEach(t => {
    const el = document.getElementById(`job-tab-${t}`);
    if (el) el.style.display = t === tab ? '' : 'none';
  });
  document.querySelectorAll('#job-detail-content .detail-tab').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}

async function fetchJobLogsInDetail(jobId) {
  const el = document.getElementById('job-detail-logs');
  try {
    const r = await fetch(`${API}/jobs/${jobId}/logs`);
    if (r.ok) {
      const d = await r.json();
      const lines = d.logs || d.entries || [];
      el.innerHTML = lines.length ? lines.map(l => `<div>${typeof l === 'string' ? l : (l.line || l.message || JSON.stringify(l))}</div>`).join('') : '<span style="color:#555">No logs available.</span>';
    } else { el.innerHTML = '<span style="color:#555">No logs available.</span>'; }
  } catch(e) { el.innerHTML = `<span style="color:#f44336">Error: ${e.message}</span>`; }
}

function streamJobLogsInDetail(jobId) {
  const el = document.getElementById('job-detail-logs');
  el.innerHTML = '<span style="color:#ff9800">Connecting to log stream...</span>';
  try {
    const es = new EventSource(`${API}/jobs/${jobId}/logs/stream`);
    es.onmessage = e => { el.innerHTML += `<div>${e.data}</div>`; el.scrollTop = el.scrollHeight; };
    es.onerror = () => { es.close(); el.innerHTML += '<div style="color:#666">[stream ended]</div>'; };
  } catch(e) { el.innerHTML = `<span style="color:#555">Log streaming not available</span>`; }
}

async function fetchJobArtifactsInDetail(jobId) {
  const el = document.getElementById('job-detail-artifacts');
  if (!el) return;
  try {
    const r = await fetch(`${API}/api/artifacts/${jobId}`);
    if (r.ok) {
      const d = await r.json();
      const arts = d.artifacts || [];
      if (!arts.length) { el.innerHTML = '<span style="color:#555">No artifacts for this job.</span>'; return; }
      el.innerHTML = `<table style="width:100%"><thead><tr><th>ID</th><th>Type</th><th>Size</th><th>Residency</th><th>Actions</th></tr></thead><tbody>` +
        arts.map(a => `<tr><td style="font-size:10px">${(a.artifact_id || '').slice(0,8)}‚Ä¶</td><td>${a.artifact_type}</td><td>${formatBytes(a.size_bytes)}</td><td>${a.residency_policy || '‚Äî'}</td><td><button class="btn btn-secondary" style="padding:1px 6px;font-size:10px" onclick="downloadArtifact('${a.artifact_id}')">‚¨á</button></td></tr>`).join('') +
        `</tbody></table>`;
    } else { el.innerHTML = '<span style="color:#555">No artifacts.</span>'; }
  } catch(e) { el.innerHTML = '<span style="color:#555">Artifacts not available.</span>'; }
}

async function fetchJobAuditInDetail(jobId) {
  const el = document.getElementById('job-detail-audit');
  if (!el) return;
  try {
    const r = await fetch(`${API}/api/audit/job/${jobId}`);
    if (r.ok) {
      const d = await r.json();
      const entries = d.entries || d.events || [];
      if (!entries.length) { el.innerHTML = '<span style="color:#555">No audit trail for this job.</span>'; return; }
      el.innerHTML = entries.map(e => `<div class="detail-row"><span class="label">${e.timestamp ? new Date(e.timestamp * 1000).toLocaleString() : '‚Äî'}</span><span class="value">${e.action || e.event || e.type || '‚Äî'}: ${e.detail || e.description || ''}</span></div>`).join('');
    } else { el.innerHTML = '<span style="color:#555">No audit trail.</span>'; }
  } catch(e) { el.innerHTML = '<span style="color:#555">Audit trail not available.</span>'; }
}

function formatBytes(b) {
  if (!b || b === 0) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(b) / Math.log(1024));
  return (b / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
}

async function cancelJob() {
  if (!currentJobId) return;
  try {
    const r = await fetch(`${API}/job/${currentJobId}`, {
      method: 'PATCH', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ status: 'cancelled' })
    });
    if (r.ok) { showToast(`Job ${currentJobId} cancelled`, 'success'); closeModal('job-detail-modal'); refresh(); }
    else { showToast('Cancel failed: ' + (await r.json()).detail, 'error'); }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function cancelJobDirect(jobId) {
  if (!confirm(`Cancel job "${jobId}"?`)) return;
  try {
    const r = await fetch(`${API}/job/${jobId}`, {
      method: 'PATCH', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ status: 'cancelled' })
    });
    if (r.ok) { showToast(`Job ${jobId} cancelled`, 'success'); refresh(); }
    else { showToast('Cancel failed', 'error'); }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function requeueJob() {
  if (!currentJobId) return;
  try {
    const r = await fetch(`${API}/job/${currentJobId}/requeue`, { method: 'POST' });
    if (r.ok) { showToast(`Job ${currentJobId} requeued`, 'success'); closeModal('job-detail-modal'); refresh(); }
    else { showToast('Requeue failed', 'error'); }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Settings Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveProfile() {
  const role = document.getElementById('set-role').value;
  localStorage.setItem('xcelsior_role', role);
  showToast('Profile saved', 'success');
}

async function generateApiKey() {
  const name = document.getElementById('key-name').value.trim() || 'default';
  const token = sessionStorage.getItem('xcelsior_token') || '';
  try {
    // Try auth-aware endpoint first, fallback to legacy
    let r = await fetch(`${API}/api/keys/generate?name=${encodeURIComponent(name)}`, {
      method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}
    });
    if (!r.ok) {
      r = await fetch(`${API}/token/generate`, { method: 'POST', headers: {'Content-Type': 'application/json'} });
    }
    if (r.ok) {
      const d = await r.json();
      const keyVal = d.key || d.token;
      const keyDisplay = document.getElementById('new-key-display');
      document.getElementById('new-key-value').textContent = keyVal;
      keyDisplay.style.display = '';
      showToast('API key generated ‚Äî copy it now!', 'success');
    } else {
      showToast('Key generation failed', 'error');
    }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

function copyApiKey() {
  const key = document.getElementById('new-key-value').textContent;
  navigator.clipboard.writeText(key).then(() => showToast('Copied to clipboard', 'success'));
}

async function generateSshKey() {
  try {
    const r = await fetch(`${API}/ssh/keygen`, { method: 'POST' });
    if (r.ok) { showToast('SSH key pair generated', 'success'); showSshPubkey(); }
    else { showToast('Key generation failed', 'error'); }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function showSshPubkey() {
  try {
    const r = await fetch(`${API}/ssh/pubkey`);
    if (r.ok) {
      const d = await r.json();
      const el = document.getElementById('ssh-key-display');
      el.textContent = d.public_key || d.pubkey || JSON.stringify(d);
      el.style.display = '';
    }
  } catch(e) { showToast('No SSH key found ‚Äî generate one first', 'warning'); }
}

function saveConsent() {
  showToast('Consent preferences saved', 'success');
}

// ‚îÄ‚îÄ SLA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchSLATargets() {
  try {
    const r = await fetch(`${API}/api/sla/targets`);
    if (r.ok) {
      const d = await r.json();
      const table = document.getElementById('sla-targets-table');
      if (d.tiers) {
        table.innerHTML = d.tiers.map(t =>
          `<tr><td><span class="tier tier-standard">${t.name}</span></td><td>${t.target_uptime}%</td><td>${t.description || ''}</td></tr>`
        ).join('');
      }
      showToast('SLA data refreshed', 'success');
    }
  } catch(e) { /* keep default content */ }
}

// ‚îÄ‚îÄ Reputation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchMyReputation() {
  const customerId = document.getElementById('set-customer-id')?.value || 'dev';
  try {
    const r = await fetch(`${API}/api/reputation/${customerId}`);
    if (r.ok) {
      const d = await r.json();
      document.getElementById('stat-my-score').textContent = d.score || 0;
      document.getElementById('stat-my-tier').textContent = (d.tier || 'new_user').toUpperCase();
      document.getElementById('stat-my-jobs').textContent = d.jobs_completed || 0;
      updateTierDisplay(d.tier || 'new_user', d.score || 0);
      fetchReputationHistory(customerId);
    }
  } catch(e) { /* keep defaults */ }
}

function updateTierDisplay(tier, score) {
  const icons = { 'new_user': 'üîò', 'bronze': 'ü•â', 'silver': 'ü•à', 'gold': 'ü•á', 'platinum': 'üíé', 'diamond': 'üëë' };
  const thresholds = { 'new_user': [0, 100], 'bronze': [100, 250], 'silver': [250, 450], 'gold': [450, 650], 'platinum': [650, 850], 'diamond': [850, 1500] };
  document.getElementById('my-tier-badge').textContent = icons[tier] || 'üîò';
  document.getElementById('my-tier-label').innerHTML = repTier(tier);
  const [min, max] = thresholds[tier] || [0, 100];
  const pct = Math.min(100, ((score - min) / (max - min)) * 100);
  document.getElementById('score-progress').style.width = pct + '%';
  const nextTierNames = ['new_user', 'bronze', 'silver', 'gold', 'platinum', 'diamond'];
  const idx = nextTierNames.indexOf(tier);
  const nextTier = idx < 5 ? nextTierNames[idx + 1] : 'MAX';
  const remaining = Math.max(0, max - score);
  document.getElementById('score-label').textContent = tier === 'diamond' ?
    `${score} points ‚Äî Maximum tier achieved!` :
    `${score} points ‚Äî ${remaining} to ${nextTier.replace('_', ' ').toUpperCase()}`;
}

// ‚îÄ‚îÄ Analytics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchAnalytics() {
  try {
    const group = document.getElementById('analytics-group').value;
    const days = document.getElementById('analytics-days').value;
    const custId = localStorage.getItem('xcelsior_customer_id') || '';
    const url = `${API}/api/analytics/usage?days=${days}&group_by=${group}` + (custId ? `&customer_id=${custId}` : '');
    const r = await fetch(url);
    const d = await r.json();
    if (!d.ok) return;
    // Summary stats
    const s = d.summary || {};
    document.getElementById('stat-a-jobs').textContent = s.total_jobs || 0;
    document.getElementById('stat-a-spend').textContent = `$${(s.total_spend_cad || 0).toFixed(2)}`;
    document.getElementById('stat-a-hours').textContent = (s.total_gpu_hours || 0).toFixed(1);
    document.getElementById('stat-a-util').textContent = `${(s.avg_gpu_utilization_pct || 0).toFixed(1)}%`;
    // Table
    const rows = d.analytics || [];
    const tbody = document.getElementById('analytics-table');
    if (!rows.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#555">No data for this period</td></tr>'; }
    else { tbody.innerHTML = rows.map(r => `<tr><td>${r.period}</td><td>${r.job_count}</td><td>${(r.total_gpu_hours||0).toFixed(1)}</td><td>$${(r.total_cost_cad||0).toFixed(2)}</td><td>${r.canadian_jobs||0}</td></tr>`).join(''); }
    // Chart
    const chart = document.getElementById('analytics-chart');
    if (rows.length) {
      const maxVal = Math.max(...rows.map(r => r.total_cost_cad || 0), 1);
      chart.innerHTML = rows.map(r => {
        const pct = ((r.total_cost_cad || 0) / maxVal * 100).toFixed(0);
        return `<div class="chart-col" style="height:${Math.max(pct, 2)}%;min-height:4px" title="${r.period}: $${(r.total_cost_cad||0).toFixed(2)}"><span class="chart-val">$${(r.total_cost_cad||0).toFixed(0)}</span><span class="chart-label">${String(r.period).slice(-5)}</span></div>`;
      }).join('');
    } else { chart.innerHTML = '<div style="color:#555;text-align:center;width:100%;padding:40px">No data</div>'; }
    // Canada ratio
    const canJobs = rows.reduce((a, r) => a + (r.canadian_jobs || 0), 0);
    const intlJobs = rows.reduce((a, r) => a + (r.international_jobs || 0), 0);
    const total = canJobs + intlJobs || 1;
    document.getElementById('can-bar').style.width = `${(canJobs / total * 100).toFixed(0)}%`;
    document.getElementById('can-bar').textContent = `${canJobs} üçÅ`;
    document.getElementById('intl-bar').style.width = `${(intlJobs / total * 100).toFixed(0)}%`;
    document.getElementById('intl-bar').textContent = `${intlJobs} üåê`;
  } catch(e) { console.error('Analytics:', e); }
}

// ‚îÄ‚îÄ Transaction History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchTransactionHistory() {
  try {
    const custId = localStorage.getItem('xcelsior_customer_id') || 'default';
    const r = await fetch(`${API}/api/billing/wallet/${custId}/history?limit=50`);
    const d = await r.json();
    const tbody = document.getElementById('txn-history-table');
    const txns = d.transactions || [];
    if (!txns.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#555">No transactions yet</td></tr>'; return; }
    tbody.innerHTML = txns.map(t => {
      const date = t.created_at ? new Date(t.created_at * 1000).toLocaleDateString() : '‚Äî';
      const amount = t.amount_cad || t.amount || 0;
      const color = amount >= 0 ? '#4caf50' : '#f44336';
      return `<tr><td>${date}</td><td>${t.description || '‚Äî'}</td><td style="color:${color}">${amount >= 0 ? '+' : ''}$${Math.abs(amount).toFixed(2)}</td><td>$${(t.balance_after || 0).toFixed(2)}</td></tr>`;
    }).join('');
  } catch(e) { console.error('TxnHistory:', e); }
}

function exportTransactions() {
  const rows = document.querySelectorAll('#txn-history-table tr');
  let csv = 'Date,Description,Amount,Balance\n';
  rows.forEach(r => {
    const cells = r.querySelectorAll('td');
    if (cells.length >= 4) csv += Array.from(cells).map(c => `"${c.textContent}"`).join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'xcelsior_transactions.csv';
  a.click();
}

// ‚îÄ‚îÄ Reserved Pricing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function reservePlan(type) {
  const custId = localStorage.getItem('xcelsior_customer_id') || 'default';
  if (!confirm(`Subscribe to ${type.replace('_', ' ')} reserved plan?`)) return;
  try {
    const r = await fetch(`${API}/api/pricing/reserve`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ customer_id: custId, gpu_model: 'RTX 4090', commitment_type: type, province: 'ON' })
    });
    const d = await r.json();
    if (d.ok) showToast(`Reserved plan created! Save ${d.discount_pct}% ‚Äî $${d.monthly_estimate_cad}/mo`, 'success');
    else showToast(d.detail || 'Failed to create plan', 'error');
  } catch(e) { showToast('Network error', 'error'); }
}

// ‚îÄ‚îÄ Artifacts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchArtifacts() {
  const jobId = document.getElementById('art-job-id').value.trim();
  if (!jobId) { showToast('Enter a Job ID', 'warning'); return; }
  try {
    const r = await fetch(`${API}/api/artifacts/${jobId}`);
    const d = await r.json();
    const tbody = document.getElementById('artifacts-table');
    const arts = d.artifacts || [];
    document.getElementById('stat-art-count').textContent = arts.length;
    if (!arts.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#555">No artifacts for this job</td></tr>'; return; }
    // Fetch expiry info
    const expiryData = await fetchArtifactExpiry(jobId);
    const expiryMap = {};
    expiryData.forEach(e => { expiryMap[e.artifact_id] = e; });
    let totalSize = 0;
    tbody.innerHTML = arts.map(a => {
      totalSize += a.size_bytes || 0;
      const date = a.created_at ? new Date(a.created_at * 1000).toLocaleDateString() : '‚Äî';
      const sizeStr = formatBytes(a.size_bytes || 0);
      const exp = expiryMap[a.artifact_id];
      let expiryHtml = '<span style="color:#555">‚Äî</span>';
      if (exp) {
        const days = exp.days_remaining || 0;
        const cls = days > 30 ? 'expiry-ok' : days > 7 ? 'expiry-warn' : 'expiry-crit';
        expiryHtml = `<span class="expiry-badge ${cls}">${days}d left</span>`;
      }
      return `<tr><td style="font-family:monospace;font-size:10px">${(a.artifact_id||'').slice(0,12)}...</td><td>${a.artifact_type||'‚Äî'}</td><td>${a.job_id||'‚Äî'}</td><td>${sizeStr}</td><td>${a.residency_policy||'‚Äî'}</td><td>${date}</td><td>${expiryHtml}</td><td><button class="btn btn-secondary" onclick="downloadArtifact('${a.job_id}','${a.artifact_id}')" style="font-size:10px;padding:2px 6px">‚¨á</button></td></tr>`;
    }).join('');
    document.getElementById('stat-art-size').textContent = formatBytes(totalSize);
  } catch(e) { showToast('Error loading artifacts', 'error'); }
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
  return (bytes / 1073741824).toFixed(1) + ' GB';
}

async function downloadArtifact(jobId, artifactId) {
  try {
    const r = await fetch(`${API}/api/artifacts/download`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ job_id: jobId, artifact_id: artifactId })
    });
    const d = await r.json();
    if (d.url) { window.open(d.url, '_blank'); showToast('Download started', 'success'); }
    else showToast(d.detail || 'Download failed', 'error');
  } catch(e) { showToast('Download error', 'error'); }
}

async function uploadArtifact() {
  try {
    const r = await fetch(`${API}/api/artifacts/upload`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        job_id: document.getElementById('art-upload-job').value.trim(),
        artifact_type: document.getElementById('art-upload-type').value,
        residency_policy: document.getElementById('art-upload-residency').value,
        size_bytes: parseInt(document.getElementById('art-upload-size').value) || 1048576
      })
    });
    const d = await r.json();
    if (d.upload_url || d.url) { showToast('Upload URL generated ‚Äî use curl/SDK to upload', 'success'); }
    else showToast(d.detail || 'Upload setup failed', 'error');
  } catch(e) { showToast('Upload error', 'error'); }
}

// ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function toggleCanadaOnly() {
  const enabled = document.getElementById('admin-canada-only').checked;
  try {
    await fetch(`${API}/canada`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ enabled }) });
    showToast(`Canada-only mode ${enabled ? 'enabled' : 'disabled'}`, enabled ? 'success' : 'warning');
  } catch(e) { showToast('Failed to toggle', 'error'); }
}

async function adminSpotUpdate() {
  await fetch(`${API}/spot-prices/update`, { method: 'POST' });
  showToast('Spot prices updated', 'success');
}

async function adminPreemptionCycle() {
  const r = await fetch(`${API}/spot/preemption-cycle`, { method: 'POST' });
  const d = await r.json();
  showToast(`Preemption cycle: ${d.preempted || 0} jobs preempted`, 'success');
}

async function adminScaleUp() {
  const r = await fetch(`${API}/autoscale/up`, { method: 'POST' });
  const d = await r.json();
  showToast(`Scale up: ${d.activated || 0} hosts activated`, 'success');
}

async function adminScaleDown() {
  const r = await fetch(`${API}/autoscale/down`, { method: 'POST' });
  const d = await r.json();
  showToast(`Scale down: ${d.deactivated || 0} hosts deactivated`, 'success');
}

async function fetchAdminMetrics() {
  try {
    const r = await fetch(`${API}/metrics`);
    const d = await r.json();
    const el = document.getElementById('admin-metrics-data');
    const m = d.metrics || d;
    el.innerHTML = Object.entries(m).map(([k, v]) =>
      `<div class="detail-row"><span class="label">${k}</span><span class="value">${typeof v === 'object' ? JSON.stringify(v) : v}</span></div>`
    ).join('');
  } catch(e) { showToast('Failed to load metrics', 'error'); }
}

async function verifyAuditChain() {
  try {
    const r = await fetch(`${API}/api/audit/verify-chain`);
    const d = await r.json();
    const el = document.getElementById('audit-chain-result');
    if (d.valid) { el.innerHTML = '<span style="color:#4caf50">‚úì Audit chain is valid ‚Äî all hashes verified</span>'; }
    else { el.innerHTML = `<span style="color:#f44336">‚úï Chain integrity broken: ${d.error || 'unknown'}</span>`; }
  } catch(e) { document.getElementById('audit-chain-result').innerHTML = '<span style="color:#f44336">Error verifying chain</span>'; }
}

async function recordLegalRequest() {
  try {
    const r = await fetch(`${API}/api/transparency/legal-request`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        request_type: document.getElementById('legal-type').value,
        requesting_agency: document.getElementById('legal-agency').value,
        description: document.getElementById('legal-desc').value,
        jurisdiction: 'CA'
      })
    });
    const d = await r.json();
    if (d.ok) { showToast('Legal request recorded', 'success'); document.getElementById('legal-desc').value = ''; }
    else showToast(d.detail || 'Failed', 'error');
  } catch(e) { showToast('Error recording legal request', 'error'); }
}

async function buildImage() {
  try {
    const packages = document.getElementById('build-packages').value.trim().split(/\s+/);
    const r = await fetch(`${API}/build`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        image_name: document.getElementById('build-image').value.trim(),
        base_image: document.getElementById('build-base').value.trim(),
        packages: packages
      })
    });
    const d = await r.json();
    document.getElementById('build-result').innerHTML = d.ok ? `<span style="color:#4caf50">Build started: ${d.image_name || ''}</span>` : `<span style="color:#f44336">${d.detail || 'Build failed'}</span>`;
    fetchBuilds();
  } catch(e) { showToast('Build error', 'error'); }
}

async function fetchBuilds() {
  try {
    const r = await fetch(`${API}/builds`);
    const d = await r.json();
    const builds = d.builds || [];
    const tbody = document.getElementById('builds-table');
    if (!builds.length) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#555">No builds</td></tr>'; return; }
    tbody.innerHTML = builds.slice(0, 10).map(b => `<tr><td style="font-size:11px">${b.image_name || '‚Äî'}</td><td>${s(b.status || 'unknown')}</td><td>${b.created_at ? new Date(b.created_at * 1000).toLocaleDateString() : '‚Äî'}</td></tr>`).join('');
  } catch(e) {}
}

async function loadAdminPanel() {
  try {
    const r = await fetch(`${API}/canada`);
    const d = await r.json();
    document.getElementById('admin-canada-only').checked = !!d.enabled;
  } catch(e) {}
}

// ‚îÄ‚îÄ Toast Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ Host Detail Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentHostId = null;
async function showHostDetail(hostId) {
  currentHostId = hostId;
  document.getElementById('host-detail-modal').classList.add('active');
  const content = document.getElementById('host-detail-content');
  content.innerHTML = 'Loading...';
  try {
    const [hostR, slaR, scoreR] = await Promise.allSettled([
      fetch(`${API}/host/${hostId}`),
      fetch(`${API}/api/sla/${hostId}`),
      fetch(`${API}/compute-score/${hostId}`)
    ]);
    const h = hostR.status === 'fulfilled' && hostR.value.ok ? await hostR.value.json() : null;
    const sla = slaR.status === 'fulfilled' && slaR.value.ok ? await slaR.value.json() : null;
    const score = scoreR.status === 'fulfilled' && scoreR.value.ok ? await scoreR.value.json() : null;
    if (!h) { content.innerHTML = '<p style="color:#f44336">Host not found.</p>'; return; }
    const loc = (h.country === 'CA' ? 'üçÅ CA' : (h.country || '‚Äî')) + (h.province ? ` ‚Äî ${h.province}` : '');
    const uptime = sla ? `${(sla.uptime_pct || sla.uptime || 0).toFixed(2)}%` : '‚Äî';
    const xcu = score ? (score.xcu || score.score || 0).toFixed(1) : '‚Äî';
    let html = `<div class="host-detail-grid">
      <div class="host-stat"><div class="hs-val">${h.gpu_model}</div><div class="hs-label">GPU Model</div></div>
      <div class="host-stat"><div class="hs-val">${h.free_vram_gb || h.vram_gb || '‚Äî'} GB</div><div class="hs-label">VRAM</div></div>
      <div class="host-stat"><div class="hs-val">$${h.cost_per_hour}</div><div class="hs-label">Cost/Hour</div></div>
      <div class="host-stat"><div class="hs-val">${xcu}</div><div class="hs-label">XCU Score</div></div>
      <div class="host-stat"><div class="hs-val">${uptime}</div><div class="hs-label">SLA Uptime</div></div>
      <div class="host-stat"><div class="hs-val">${loc}</div><div class="hs-label">Location</div></div>
    </div>`;
    const rows = [
      ['Host ID', h.host_id], ['IP Address', h.ip], ['Status', h.status],
      ['Admitted', h.admitted ? '‚úì Yes' : '‚úó No'],
      ['Verification', h.verified ? '‚úÖ Verified' : '‚ö†Ô∏è Unverified'],
      ['Jobs Run', h.jobs_completed || h.total_jobs || '‚Äî'],
      ['Total Earned', h.total_earned ? `$${h.total_earned}` : '‚Äî'],
    ];
    html += rows.map(([l, v]) =>
      `<div class="detail-row"><span class="label">${l}</span><span class="value">${v}</span></div>`
    ).join('');
    if (sla) {
      html += `<div style="margin-top:12px;border-top:1px solid #222;padding-top:8px">
        <div style="font-size:11px;color:#ff3333;text-transform:uppercase;margin-bottom:6px">SLA Details</div>`;
      const slaRows = [
        ['Target Uptime', `${sla.target_uptime || 99}%`],
        ['Actual Uptime', uptime],
        ['Violations', sla.violations || 0],
        ['Downtimes', sla.downtimes || sla.downtime_count || 0],
      ];
      html += slaRows.map(([l, v]) =>
        `<div class="detail-row"><span class="label">${l}</span><span class="value">${v}</span></div>`
      ).join('');
      html += `</div>`;
    }
    content.innerHTML = html;
    // Load provider earnings panel
    loadProviderPanel(h);
    // Show marketplace toggle button
    const mktBtn = document.getElementById('host-marketplace-btn');
    mktBtn.style.display = '';
    const isListed = h.marketplace_listed || h.listed || false;
    mktBtn.textContent = isListed ? 'üì§ Unlist from Marketplace' : 'üì¢ List on Marketplace';
    mktBtn.style.background = isListed ? '#ff9800' : '#4caf50';
  } catch(e) {
    content.innerHTML = `<p style="color:#f44336">Error loading host: ${e.message}</p>`;
  }
}

async function toggleHostMarketplace() {
  if (!currentHostId) return;
  try {
    const r = await fetch(`${API}/marketplace/${currentHostId}/toggle`, { method: 'POST' });
    if (r.ok) { showToast(`Marketplace listing updated for ${currentHostId}`, 'success'); showHostDetail(currentHostId); }
    else { showToast('Failed to update marketplace listing', 'error'); }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Forgot Password / Password Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showForgotPassword() {
  document.getElementById('forgot-password-form').style.display = '';
  document.getElementById('reset-confirm-form').style.display = 'none';
}
function hideForgotPassword() {
  document.getElementById('forgot-password-form').style.display = 'none';
  document.getElementById('reset-confirm-form').style.display = 'none';
}

async function requestPasswordReset() {
  const email = document.getElementById('reset-email').value.trim();
  if (!email) { showToast('Please enter your email', 'error'); return; }
  try {
    const r = await fetch(`${API}/api/auth/password-reset`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ email })
    });
    const d = await r.json();
    showToast('If an account exists for that email, a reset link has been sent.', 'success');
    // In test mode the token is returned directly
    if (d.reset_token) {
      document.getElementById('reset-token').value = d.reset_token;
    }
    document.getElementById('forgot-password-form').style.display = 'none';
    document.getElementById('reset-confirm-form').style.display = '';
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function confirmPasswordReset() {
  const token = document.getElementById('reset-token').value.trim();
  const pw = document.getElementById('reset-new-password').value;
  if (!token) { showToast('Please enter the reset token', 'error'); return; }
  if (pw.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }
  try {
    const r = await fetch(`${API}/api/auth/password-reset/confirm`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ token, new_password: pw })
    });
    if (r.ok) {
      showToast('Password has been reset! Please sign in.', 'success');
      hideForgotPassword();
    } else {
      const d = await r.json();
      showToast(d.detail || 'Reset failed', 'error');
    }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Change Password (Settings) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function changePassword() {
  const current = document.getElementById('set-current-pw').value;
  const newPw = document.getElementById('set-new-pw').value;
  const confirm = document.getElementById('set-confirm-pw').value;
  if (!current) { showToast('Please enter your current password', 'error'); return; }
  if (newPw.length < 8) { showToast('New password must be at least 8 characters', 'error'); return; }
  if (newPw !== confirm) { showToast('New passwords do not match', 'error'); return; }
  const token = sessionStorage.getItem('xcelsior_token') || '';
  try {
    const r = await fetch(`${API}/api/auth/change-password`, {
      method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
      body: JSON.stringify({ current_password: current, new_password: newPw })
    });
    if (r.ok) {
      showToast('Password changed successfully', 'success');
      document.getElementById('set-current-pw').value = '';
      document.getElementById('set-new-pw').value = '';
      document.getElementById('set-confirm-pw').value = '';
    } else {
      const d = await r.json();
      showToast(d.detail || 'Password change failed', 'error');
    }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Delete Account ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function deleteAccount() {
  if (!confirm('‚ö†Ô∏è This will permanently delete your account and all data. This cannot be undone.\n\nAre you sure?')) return;
  if (!confirm('Please confirm again: DELETE your Xcelsior account?')) return;
  const token = sessionStorage.getItem('xcelsior_token') || '';
  try {
    const r = await fetch(`${API}/api/auth/me`, {
      method: 'DELETE', headers: {'Authorization': `Bearer ${token}`}
    });
    if (r.ok) {
      showToast('Account deleted. Goodbye!', 'success');
      setTimeout(() => { sessionStorage.clear(); location.reload(); }, 2000);
    } else {
      const d = await r.json();
      showToast(d.detail || 'Failed to delete account', 'error');
    }
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Marketplace Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function searchMarketplace() {
  const params = new URLSearchParams();
  const gpu = document.getElementById('mkt-search-gpu').value.trim();
  const vram = document.getElementById('mkt-search-vram').value;
  const price = document.getElementById('mkt-search-price').value;
  const prov = document.getElementById('mkt-search-prov').value;
  const sort = document.getElementById('mkt-search-sort').value;
  if (gpu) params.set('gpu_model', gpu);
  if (vram) params.set('min_vram', vram);
  if (price) params.set('max_price', price);
  if (prov) params.set('province', prov);
  if (sort) params.set('sort_by', sort);
  try {
    const r = await fetch(`${API}/marketplace/search?${params}`);
    if (r.ok) {
      const d = await r.json();
      const listings = d.listings || [];
      document.getElementById('stat-market').textContent = listings.length;
      document.getElementById('market-table').innerHTML = listings.length ? listings.map(l =>
        `<tr><td style="cursor:pointer;color:#90caf9" onclick="showHostDetail('${l.host_id}')">${l.host_id}</td><td>${l.gpu_model}</td><td>${l.vram_gb || l.free_vram_gb || '‚Äî'}GB</td><td>$${l.cost_per_hour || l.price_per_hour || '‚Äî'}</td><td>${l.owner || l.provider_id || '‚Äî'}</td><td>${l.total_jobs || 0}</td><td>$${l.total_earned || 0}</td></tr>`
      ).join('') : '<tr><td colspan="7" style="text-align:center;color:#555">No matching listings</td></tr>';
      showToast(`Found ${listings.length} listings`, 'success');
    } else { showToast('Search failed', 'error'); }
  } catch(e) { showToast('Search error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Event Log Filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allEventLogEntries = [];

function addEventLogEntry(entry) {
  allEventLogEntries.push(entry);
  filterEventLog();
}

function filterEventLog() {
  const severity = document.getElementById('log-severity-filter').value;
  const type = document.getElementById('log-type-filter').value;
  const search = document.getElementById('log-search').value.toLowerCase();
  let filtered = allEventLogEntries;
  if (severity !== 'all') {
    filtered = filtered.filter(e => (e.severity || 'info') === severity);
  }
  if (type !== 'all') {
    filtered = filtered.filter(e => {
      const t = (e.type || e.event || '').toLowerCase();
      return t.includes(type);
    });
  }
  if (search) {
    filtered = filtered.filter(e => {
      const text = JSON.stringify(e).toLowerCase();
      return text.includes(search);
    });
  }
  const el = document.getElementById('event-log-full');
  el.innerHTML = filtered.map(e => {
    const sev = e.severity || 'info';
    const ts = e.timestamp ? new Date(e.timestamp * 1000).toLocaleTimeString() : '';
    return `<div style="padding:3px 0;border-bottom:1px solid #1a1a1a"><span class="sev-badge ${sev}">${sev}</span> <span style="color:#555">${ts}</span> <span class="sev-${sev}">${e.event || e.type || '‚Äî'}</span>: ${e.detail || e.message || e.data || ''}</div>`;
  }).reverse().join('');
  document.getElementById('log-count').textContent = `${filtered.length} / ${allEventLogEntries.length} events`;
}

function clearEventLog() {
  allEventLogEntries = [];
  document.getElementById('event-log-full').innerHTML = '';
  document.getElementById('log-count').textContent = '0 events';
}

// ‚îÄ‚îÄ Submit Job Enhancements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAdvancedJob() {
  const header = event.target;
  const body = document.getElementById('sj-advanced');
  header.classList.toggle('open');
  body.classList.toggle('open');
}

// ‚îÄ‚îÄ Compliance Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchComplianceData() {
  // Fetch province compliance matrix
  try {
    const r = await fetch(`${API}/api/compliance/provinces`);
    if (r.ok) {
      const d = await r.json();
      const provinces = d.provinces || d;
      const el = document.getElementById('compliance-provinces');
      if (Array.isArray(provinces)) {
        el.innerHTML = provinces.map(p => `<div class="compliance-cell"><div class="prov-name">${p.code || p.province}</div><div class="prov-status">${p.compliant ? '‚úÖ Compliant' : '‚ö†Ô∏è Review'}</div><div style="font-size:9px;color:#555">${p.notes || ''}</div></div>`).join('');
      } else if (typeof provinces === 'object') {
        el.innerHTML = Object.entries(provinces).map(([k, v]) => `<div class="compliance-cell"><div class="prov-name">${k}</div><div class="prov-status">${typeof v === 'object' ? (v.compliant ? '‚úÖ' : '‚ö†Ô∏è') : v}</div></div>`).join('');
      }
    }
  } catch(e) { /* compliance endpoint may not exist */ }
  // Fetch tax rates
  try {
    const r = await fetch(`${API}/api/compliance/tax-rates`);
    if (r.ok) {
      const d = await r.json();
      const rates = d.rates || d;
      const tbody = document.getElementById('compliance-tax-table');
      if (Array.isArray(rates)) {
        tbody.innerHTML = rates.map(r => `<tr><td>${r.province}</td><td>${r.gst || 5}%</td><td>${r.pst || r.hst || 0}%</td><td>${r.total || (r.gst || 5) + (r.pst || r.hst || 0)}%</td><td>${r.type || 'GST+PST'}</td></tr>`).join('');
      } else if (typeof rates === 'object') {
        tbody.innerHTML = Object.entries(rates).map(([k, v]) => `<tr><td>${k}</td><td>${v.gst || 5}%</td><td>${v.pst || v.hst || 0}%</td><td>${v.total || (v.gst || 5) + (v.pst || v.hst || 0)}%</td><td>${v.type || '‚Äî'}</td></tr>`).join('');
      }
    }
  } catch(e) {}
  // Fetch trust tier requirements
  try {
    const r = await fetch(`${API}/api/compliance/trust-tier-requirements`);
    if (r.ok) {
      const d = await r.json();
      const tiers = d.tiers || d;
      const tbody = document.getElementById('compliance-tier-req-table');
      if (Array.isArray(tiers)) {
        tbody.innerHTML = tiers.map(t => `<tr><td><span class="tier tier-${t.name || 'free'}">${t.name || t.tier}</span></td><td>${t.checks_required || '‚Äî'}</td><td>${t.min_score || '‚Äî'}</td><td>${t.features || '‚Äî'}</td></tr>`).join('');
      } else if (typeof tiers === 'object') {
        tbody.innerHTML = Object.entries(tiers).map(([k, v]) => `<tr><td><span class="tier">${k}</span></td><td>${v.checks_required || '‚Äî'}</td><td>${v.min_score || '‚Äî'}</td><td>${Array.isArray(v.features) ? v.features.join(', ') : (v.features || '‚Äî')}</td></tr>`).join('');
      }
    }
  } catch(e) {}
  // Fetch GST registration threshold
  fetchGSTThreshold();
}
  try {
    const r = await fetch(`${API}/api/compliance/quebec-pia-check`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ provider_id: document.getElementById('set-customer-id')?.value || 'test', data_types: ['personal', 'usage', 'billing'] })
    });
    const d = await r.json();
    const el = document.getElementById('quebec-pia-result');
    el.style.display = '';
    if (d.compliant || d.passed) {
      el.style.borderColor = '#1a3a1a';
      el.innerHTML = `<span style="color:#4caf50;font-weight:bold">‚úÖ Quebec PIA: Compliant</span><br><span style="color:#888;font-size:11px">${d.detail || d.message || 'All checks passed.'}</span>`;
    } else {
      el.style.borderColor = '#3a1a1a';
      el.style.background = '#1a0a0a';
      el.innerHTML = `<span style="color:#f44336;font-weight:bold">‚ö†Ô∏è Quebec PIA: Issues Found</span><br><span style="color:#888;font-size:11px">${d.detail || d.message || d.issues?.join(', ') || 'Review required.'}</span>`;
    }
  } catch(e) { showToast('PIA check error: ' + e.message, 'error'); 
}


// ‚îÄ‚îÄ Spot pricing hint ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSpotHint() {
  const mode = document.getElementById('sj-pricing-mode')?.value;
  const hint = document.getElementById('sj-spot-hint');
  if (hint) hint.style.display = mode === 'spot' ? '' : 'none';
  const comp = document.getElementById('sj-est-comparison');
  if (comp && mode === 'spot') {
    comp.style.display = '';
    comp.textContent = '‚ö° Spot pricing: ~30-70% cheaper than on-demand, but may be preempted';
  } else if (comp) { comp.style.display = 'none'; }
}

// Hook into pricing mode change
const sjPricingMode = document.getElementById('sj-pricing-mode');
if (sjPricingMode) sjPricingMode.addEventListener('change', updateSpotHint);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Invoice List, SLA Cards, Marketplace Stats, Filters, Tooltips
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Invoice List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchInvoices() {
  try {
    const custId = localStorage.getItem('xcelsior_customer_id') || 'default';
    const r = await fetch(`${API}/api/billing/invoices/${custId}?limit=12`);
    const d = await r.json();
    const invoices = d.invoices || [];
    const tbody = document.getElementById('invoice-table');
    if (!invoices.length) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#555">No invoices found</td></tr>';
      return;
    }
    tbody.innerHTML = invoices.map(inv => {
      const start = new Date(inv.period_start * 1000).toLocaleDateString();
      const end = new Date(inv.period_end * 1000).toLocaleDateString();
      return `<tr>
        <td style="font-family:monospace;font-size:11px">${inv.invoice_id}</td>
        <td style="font-size:11px">${start} ‚Äî ${end}</td>
        <td>$${(inv.subtotal_cad || 0).toFixed(2)}</td>
        <td>$${(inv.tax_cad || 0).toFixed(2)}</td>
        <td style="font-weight:bold">$${(inv.total_cad || 0).toFixed(2)}</td>
        <td style="color:#4caf50">$${(inv.caf_eligible_cad || 0).toFixed(2)}</td>
        <td><span class="inv-status inv-paid">${inv.status}</span></td>
        <td><button class="btn btn-secondary" style="padding:1px 6px;font-size:10px" onclick="downloadInvoice('${inv.invoice_id}')">üì•</button></td>
      </tr>`;
    }).join('');
  } catch(e) { console.error('Invoices:', e); }
}

function downloadInvoice(invoiceId) {
  showToast(`Invoice ${invoiceId} ‚Äî PDF generation coming soon`, 'info');
}

// ‚îÄ‚îÄ Transaction Type Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allTransactions = [];
let activeTxnFilter = 'all';

async function fetchTransactionHistoryFiltered() {
  try {
    const custId = localStorage.getItem('xcelsior_customer_id') || 'default';
    const r = await fetch(`${API}/api/billing/wallet/${custId}/history?limit=100`);
    const d = await r.json();
    allTransactions = d.transactions || [];
    renderFilteredTransactions();
  } catch(e) { console.error('TxnHistory:', e); }
}

function filterTransactions(type) {
  activeTxnFilter = type;
  document.querySelectorAll('.txn-pill').forEach(p => {
    p.classList.toggle('active', p.dataset.txnType === type);
  });
  renderFilteredTransactions();
}

function renderFilteredTransactions() {
  let txns = activeTxnFilter === 'all' ? allTransactions :
    allTransactions.filter(t => (t.tx_type || t.type || '').toLowerCase().includes(activeTxnFilter));
  // Apply date range filter
  if (txnDateFrom) txns = txns.filter(t => (t.created_at || 0) >= txnDateFrom);
  if (txnDateTo) txns = txns.filter(t => (t.created_at || 0) <= txnDateTo);
  const tbody = document.getElementById('txn-history-table');
  if (!txns.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#555">No transactions</td></tr>';
    renderBalanceChart([]);
    return;
  }
  tbody.innerHTML = txns.map(t => {
    const date = t.created_at ? new Date(t.created_at * 1000).toLocaleDateString() : '‚Äî';
    const amount = t.amount_cad || t.amount || 0;
    const color = amount >= 0 ? '#4caf50' : '#f44336';
    const typeTag = t.tx_type || t.type || '';
    return `<tr><td>${date}</td><td>${typeTag ? '<span style="background:#222;padding:1px 4px;border-radius:2px;font-size:9px;margin-right:4px">' + typeTag + '</span>' : ''}${t.description || '‚Äî'}</td><td style="color:${color}">${amount >= 0 ? '+' : ''}$${Math.abs(amount).toFixed(2)}</td><td>$${(t.balance_after || 0).toFixed(2)}</td></tr>`;
  }).join('');
  renderBalanceChart(txns);
}

// ‚îÄ‚îÄ SLA Host Cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchSLAHostCards() {
  try {
    const r = await fetch(`${API}/api/sla/hosts-summary`);
    const d = await r.json();
    const hosts = d.hosts || [];
    const container = document.getElementById('sla-host-cards');
    if (!hosts.length) {
      container.innerHTML = '<div style="color:#555;font-size:12px;text-align:center;padding:16px">No hosts found.</div>';
      return;
    }
    container.innerHTML = hosts.map(h => {
      const uptime = (h.uptime_30d_pct * 100).toFixed(2);
      const uptimeClass = uptime >= 99.5 ? 'ok' : uptime >= 95 ? 'warn' : 'crit';
      return `<div class="sla-card">
        <div class="sla-host">${h.host_id} <span style="float:right;font-weight:normal;font-size:10px">${s(h.status)}</span></div>
        <div class="sla-uptime ${uptimeClass}">${uptime}%</div>
        <div class="sla-meta">${h.gpu_model || 'Unknown GPU'} ¬∑ ${h.sla_tier} tier ¬∑ ${h.violation_count} violations</div>
        <div class="sla-meta">${h.country || ''}${h.province ? ' ' + h.province : ''}</div>
      </div>`;
    }).join('');
  } catch(e) { console.error('SLA Host Cards:', e); }
}

// ‚îÄ‚îÄ SLA Violations & Downtimes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchSLAViolations() {
  try {
    // Fetch from all known hosts via summary
    const r = await fetch(`${API}/api/sla/hosts-summary`);
    const d = await r.json();
    const hosts = d.hosts || [];
    const allViolations = [];
    for (const h of hosts.slice(0, 10)) {
      try {
        const vr = await fetch(`${API}/api/sla/violations/${h.host_id}`);
        const vd = await vr.json();
        (vd.violations || []).forEach(v => allViolations.push({ host_id: h.host_id, ...v }));
      } catch(e) {}
    }
    const tbody = document.getElementById('sla-violations-table');
    if (!allViolations.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#555">No violations recorded</td></tr>';
      return;
    }
    tbody.innerHTML = allViolations.slice(0, 50).map(v => {
      const time = v.timestamp ? new Date(v.timestamp * 1000).toLocaleString() : '‚Äî';
      return `<tr><td>${v.host_id}</td><td>${v.type || v.event_type || '‚Äî'}</td><td>${v.severity || '‚Äî'}</td><td>${time}</td><td style="font-size:11px">${v.detail || v.message || '‚Äî'}</td></tr>`;
    }).join('');
  } catch(e) { console.error('SLA Violations:', e); }
}

async function fetchSLADowntimes() {
  try {
    const r = await fetch(`${API}/api/sla/downtimes`);
    const d = await r.json();
    const downtimes = d.downtimes || [];
    const tbody = document.getElementById('sla-downtimes-table');
    if (!downtimes.length) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#555">No active downtimes</td></tr>';
      return;
    }
    tbody.innerHTML = downtimes.map(dt => {
      const started = dt.started_at ? new Date(dt.started_at * 1000).toLocaleString() : '‚Äî';
      const dur = dt.started_at ? Math.round((Date.now()/1000 - dt.started_at) / 60) + ' min' : '‚Äî';
      return `<tr><td>${dt.host_id}</td><td>${started}</td><td>${dur}</td><td>${dt.reason || '‚Äî'}</td></tr>`;
    }).join('');
  } catch(e) { console.error('SLA Downtimes:', e); }
}

// ‚îÄ‚îÄ Marketplace Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchMarketplaceStats() {
  try {
    const r = await fetch(`${API}/marketplace/stats`);
    const d = await r.json();
    const stats = d.stats || {};
    const el = document.getElementById('mkt-stats-summary');
    if (el) {
      el.style.display = '';
      document.getElementById('mkt-s-total').textContent = stats.total_listings || 0;
      document.getElementById('mkt-s-active').textContent = stats.active_listings || 0;
      document.getElementById('mkt-s-avgprice').textContent = stats.avg_price_per_hour ? '$' + stats.avg_price_per_hour.toFixed(2) : '‚Äî';
      document.getElementById('mkt-s-vram').textContent = stats.total_vram_gb ? stats.total_vram_gb.toFixed(0) : '‚Äî';
    }
    const badge = document.getElementById('mkt-stats-badge');
    if (badge) badge.textContent = `(${stats.active_listings || 0} active)`;
  } catch(e) { /* stats optional */ }
}

// ‚îÄ‚îÄ Reputation Leaderboard Enhancement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function repTooltip(host) {
  const tierName = (host.tier || 'new_user').replace('_', ' ');
  return `${tierName.charAt(0).toUpperCase() + tierName.slice(1)} ‚Äî Score: ${host.score || 0} ‚Äî ${host.jobs_completed || 0} jobs completed`;
}

// ‚îÄ‚îÄ Reputation Score History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchReputationHistory(entityId) {
  try {
    const r = await fetch(`${API}/api/reputation/${entityId}/history?limit=30`);
    const d = await r.json();
    const events = d.events || [];
    if (!events.length) return;
    // Build a simple text-based sparkline
    const scores = events.map(e => e.score_after || e.score || 0).reverse();
    const max = Math.max(...scores, 1);
    const sparkBars = scores.slice(-20).map(s => {
      const h = Math.round((s / max) * 8);
      return '‚ñÅ‚ñÇ‚ñÉ‚ñÑ‚ñÖ‚ñÜ‚ñá‚ñà'[Math.min(h, 8)] || '‚ñÅ';
    }).join('');
    const el = document.getElementById('rep-history-chart');
    if (el) {
      el.innerHTML = `<div style="font-family:monospace;font-size:14px;letter-spacing:1px;color:#4caf50">${sparkBars}</div>
        <div style="font-size:10px;color:#555;margin-top:2px">Last ${scores.length} events ¬∑ Current: ${scores[scores.length-1] || 0}</div>`;
    }
  } catch(e) { /* optional */ }
}

// ‚îÄ‚îÄ Job Progress Indicator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function jobProgress(job) {
  if (job.status !== 'running' || !job.started_at) return '';
  const elapsed = Math.round(Date.now()/1000 - job.started_at);
  const hrs = Math.floor(elapsed / 3600);
  const mins = Math.floor((elapsed % 3600) / 60);
  const secs = elapsed % 60;
  const timeStr = hrs > 0 ? `${hrs}h ${mins}m` : mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
  return `<div class="job-progress">‚è± ${timeStr}</div>`;
}

// ‚îÄ‚îÄ Low Balance Warning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkLowBalance() {
  const banner = document.getElementById('low-balance-banner');
  if (banner) {
    banner.style.display = walletBalance < 5 ? '' : 'none';
  }
  // Yellow warning when balance is moderate-low
  if (walletBalance > 5 && walletBalance < 15 && !window._moderateBalanceToasted) {
    showToast('üíõ Balance getting low ($' + walletBalance.toFixed(2) + '). Consider adding credits.', 'warning');
    window._moderateBalanceToasted = true;
  }
  // Critical red toast when very low
  if (walletBalance > 0 && walletBalance < 5 && !window._lowBalanceToasted) {
    showToast('üî¥ Critical: Low balance! Add credits to avoid job interruptions.', 'error');
    window._lowBalanceToasted = true;
  }
}

// ‚îÄ‚îÄ Session Timeout Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sessionCheckInterval = null;

function startSessionCheck() {
  if (sessionCheckInterval) clearInterval(sessionCheckInterval);
  sessionCheckInterval = setInterval(() => {
    const token = sessionStorage.getItem('xcelsior_token');
    const loginTime = parseInt(sessionStorage.getItem('xcelsior_login_time') || '0');
    if (!token) return;
    const elapsed = Date.now() / 1000 - loginTime;
    const maxSession = 86400 * 30; // 30 days
    const warnAt = maxSession - 3600; // Warn 1 hour before
    if (elapsed >= maxSession) {
      document.getElementById('session-timeout-modal').style.display = '';
      clearInterval(sessionCheckInterval);
    } else if (elapsed >= warnAt && !window._sessionWarned) {
      showToast('‚è∞ Session expires in less than 1 hour', 'warning');
      window._sessionWarned = true;
    }
  }, 60000); // Check every minute
}

// ‚îÄ‚îÄ Auto-refresh JWT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshAuthToken() {
  const token = sessionStorage.getItem('xcelsior_token');
  if (!token) return;
  try {
    const r = await fetch(`${API}/api/auth/refresh`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });
    if (r.ok) {
      const d = await r.json();
      if (d.token) {
        sessionStorage.setItem('xcelsior_token', d.token);
        sessionStorage.setItem('xcelsior_login_time', String(Math.floor(Date.now()/1000)));
      }
    }
  } catch(e) { /* silent refresh */ }
}

// Refresh token every 12 hours
setInterval(refreshAuthToken, 12 * 3600 * 1000);

// ‚îÄ‚îÄ Alert Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAlertConfig() {
  try {
    const r = await fetch(`${API}/alerts/config`);
    const d = await r.json();
    const cfg = d.config || d;
    if (cfg.telegram_bot_token) document.getElementById('alert-telegram-token').value = cfg.telegram_bot_token === '[REDACTED]' ? '' : cfg.telegram_bot_token;
    if (cfg.telegram_chat_id) document.getElementById('alert-telegram-chat').value = cfg.telegram_chat_id || '';
    document.getElementById('alert-config-result').innerHTML = '<span style="color:#4caf50">Config loaded</span>';
  } catch(e) {
    document.getElementById('alert-config-result').innerHTML = '<span style="color:#f44336">Failed to load config</span>';
  }
}

async function saveAlertConfig() {
  try {
    const token = document.getElementById('alert-telegram-token').value;
    const chatId = document.getElementById('alert-telegram-chat').value;
    const body = {};
    if (token) body.telegram_bot_token = token;
    if (chatId) body.telegram_chat_id = chatId;
    const r = await fetch(`${API}/alerts/config`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (r.ok) {
      document.getElementById('alert-config-result').innerHTML = '<span style="color:#4caf50">‚úì Config saved</span>';
      showToast('Alert configuration saved', 'success');
    } else {
      document.getElementById('alert-config-result').innerHTML = '<span style="color:#f44336">Save failed</span>';
    }
  } catch(e) {
    document.getElementById('alert-config-result').innerHTML = '<span style="color:#f44336">Network error</span>';
  }
}

// ‚îÄ‚îÄ GST/HST Threshold in Compliance Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchGSTThreshold() {
  try {
    const r = await fetch(`${API}/api/billing/gst-threshold`);
    const d = await r.json();
    const el = document.getElementById('gst-threshold-display');
    if (!el) return;
    const exceeded = d.exceeded || d.must_register;
    el.style.display = '';
    el.innerHTML = `
      <div style="color:${exceeded ? '#f44336' : '#4caf50'};font-weight:bold;font-size:13px">
        ${exceeded ? '‚ö†Ô∏è GST/HST Registration REQUIRED' : '‚úÖ Below GST/HST Threshold'}
      </div>
      <div style="font-size:12px;color:#888;margin-top:4px">
        Revenue: <strong>$${(d.total_revenue_cad || 0).toLocaleString()}</strong> / $30,000 threshold
        <div style="background:#222;height:8px;border-radius:4px;margin-top:4px;overflow:hidden">
          <div style="background:${exceeded ? '#f44336' : '#4caf50'};height:100%;width:${Math.min(100, ((d.total_revenue_cad || 0) / 30000) * 100).toFixed(1)}%;border-radius:4px"></div>
        </div>
      </div>
      <div style="font-size:10px;color:#555;margin-top:4px">${d.quarters_assessed || 0} quarters assessed</div>`;
  } catch(e) { /* optional */ }
}

// ‚îÄ‚îÄ Event Detail Expansion (UI-12.2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleEventDetail(eventId) {
  const detail = document.getElementById(`event-detail-${eventId}`);
  if (detail) detail.classList.toggle('open');
}

// ‚îÄ‚îÄ Enhanced Mining/SLA/Credit Toasts (UI-12.1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleMiningAlert(data) {
  showToast(`üö® Mining detected on ${data.host_id || 'unknown host'}! ${data.detail || ''}`, 'error');
  // Also show a persistent banner
  const banner = document.getElementById('low-balance-banner');
  if (banner) {
    const alertBanner = document.createElement('div');
    alertBanner.className = 'low-balance-banner';
    alertBanner.style.display = '';
    alertBanner.style.background = '#3a0a0a';
    alertBanner.style.borderColor = '#f44336';
    alertBanner.style.color = '#f44336';
    alertBanner.innerHTML = `üö® <strong>Mining Alert!</strong> Suspicious activity detected on host ${data.host_id || 'unknown'}. Investigation in progress.`;
    banner.parentNode.insertBefore(alertBanner, banner.nextSibling);
    setTimeout(() => alertBanner.remove(), 30000);
  }
}

function handleSLAViolation(data) {
  showToast(`‚ö†Ô∏è SLA violation on ${data.host_id || 'host'}: ${data.detail || data.message || 'uptime below target'}`, 'warning');
}

// ‚îÄ‚îÄ Team Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchMyTeams() {
  const container = document.getElementById('teams-list');
  if (!container) return;
  try {
    const r = await fetch(`${API}/api/teams/me`, { headers: authHeaders() });
    if (!r.ok) { container.innerHTML = '<p style="font-size:11px;color:#555;text-align:center">No teams yet.</p>'; return; }
    const data = await r.json();
    const teams = data.teams || [];
    if (teams.length === 0) { container.innerHTML = '<p style="font-size:11px;color:#555;text-align:center">No teams yet. Create one above.</p>'; return; }
    container.innerHTML = teams.map(t => `
      <div class="team-card" data-team-id="${t.id}">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="team-name">${t.name}</div><div class="team-meta"><span class="team-badge">${t.plan || 'free'}</span> ¬∑ Created ${new Date(t.created_at).toLocaleDateString()}</div></div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-secondary" onclick="showTeamDetail('${t.id}')" style="font-size:10px;padding:2px 8px">üë• Members</button>
            <button class="btn btn-secondary" onclick="deleteTeam('${t.id}')" style="font-size:10px;padding:2px 8px;color:#f44336">‚úï</button>
          </div>
        </div>
        <div id="team-members-${t.id}" style="display:none;margin-top:8px"></div>
      </div>`).join('');
  } catch (e) { container.innerHTML = `<p style="font-size:11px;color:#f44336">${e.message}</p>`; }
}

async function createTeam() {
  const name = document.getElementById('team-name-input').value.trim();
  const plan = document.getElementById('team-plan-input').value;
  if (!name) { showToast('Enter a team name', 'error'); return; }
  try {
    const r = await fetch(`${API}/api/teams`, { method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ name, plan }) });
    if (r.ok) { showToast('Team created', 'success'); document.getElementById('team-name-input').value = ''; fetchMyTeams(); }
    else { const d = await r.json(); showToast(d.detail || 'Failed to create team', 'error'); }
  } catch (e) { showToast('Error: ' + e.message, 'error'); }
}

async function showTeamDetail(teamId) {
  const el = document.getElementById(`team-members-${teamId}`);
  if (el.style.display !== 'none') { el.style.display = 'none'; return; }
  el.style.display = '';
  el.innerHTML = 'Loading...';
  try {
    const r = await fetch(`${API}/api/teams/${teamId}`, { headers: authHeaders() });
    if (!r.ok) { el.innerHTML = '<span style="color:#f44336">Failed to load</span>'; return; }
    const data = await r.json();
    const members = data.members || [];
    let html = members.map(m => `
      <div class="team-member-row">
        <span class="tm-email">${m.email}</span>
        <span class="tm-role">${m.role}</span>
        <button class="btn btn-secondary" onclick="removeTeamMember('${teamId}','${m.email}')" style="font-size:9px;padding:1px 6px;color:#f44336">‚úï</button>
      </div>`).join('');
    html += `<div style="display:flex;gap:4px;margin-top:6px">
      <input id="add-member-${teamId}" placeholder="email@example.com" style="flex:1;padding:4px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:3px;font-size:11px">
      <select id="add-role-${teamId}" style="padding:4px;background:#1a1a1a;border:1px solid #333;color:#eee;border-radius:3px;font-size:10px">
        <option value="member">Member</option><option value="admin">Admin</option>
      </select>
      <button class="btn" onclick="addTeamMember('${teamId}')" style="font-size:10px;padding:2px 8px;background:#4caf50">+ Add</button>
    </div>`;
    el.innerHTML = html;
  } catch (e) { el.innerHTML = `<span style="color:#f44336">${e.message}</span>`; }
}

async function addTeamMember(teamId) {
  const email = document.getElementById(`add-member-${teamId}`).value.trim();
  const role = document.getElementById(`add-role-${teamId}`).value;
  if (!email) { showToast('Enter an email', 'error'); return; }
  try {
    const r = await fetch(`${API}/api/teams/${teamId}/members`, { method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ email, role }) });
    if (r.ok) { showToast('Member added', 'success'); showTeamDetail(teamId); }
    else { const d = await r.json(); showToast(d.detail || 'Failed', 'error'); }
  } catch (e) { showToast(e.message, 'error'); }
}

async function removeTeamMember(teamId, email) {
  if (!confirm(`Remove ${email} from team?`)) return;
  try {
    const r = await fetch(`${API}/api/teams/${teamId}/members/${encodeURIComponent(email)}`, { method: 'DELETE', headers: authHeaders() });
    if (r.ok) { showToast('Member removed', 'success'); showTeamDetail(teamId); }
    else { showToast('Failed to remove member', 'error'); }
  } catch (e) { showToast(e.message, 'error'); }
}

async function deleteTeam(teamId) {
  if (!confirm('Delete this team? This cannot be undone.')) return;
  try {
    const r = await fetch(`${API}/api/teams/${teamId}`, { method: 'DELETE', headers: authHeaders() });
    if (r.ok) { showToast('Team deleted', 'success'); fetchMyTeams(); }
    else { const d = await r.json(); showToast(d.detail || 'Failed', 'error'); }
  } catch (e) { showToast(e.message, 'error'); }
}

// ‚îÄ‚îÄ Admin SLA Enforcement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function adminEnforceSLA() {
  if (!confirm('Run SLA enforcement? This may issue credits for violations.')) return;
  try {
    const r = await fetch(`${API}/api/sla/enforce`, { method: 'POST', headers: authHeaders() });
    if (r.ok) { const d = await r.json(); showToast(`SLA enforced: ${d.credits_issued || 0} credits issued for ${d.violations_found || 0} violations`, 'success'); }
    else { showToast('Failed to enforce SLA', 'error'); }
  } catch (e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Provider Detail in Host Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProviderPanel(hostData) {
  const panel = document.getElementById('host-provider-panel');
  if (!panel) return;
  const providerId = hostData.provider_id || hostData.owner;
  if (!providerId) { panel.style.display = 'none'; return; }
  try {
    const r = await fetch(`${API}/api/providers/${providerId}`, { headers: authHeaders() });
    if (!r.ok) { panel.style.display = 'none'; return; }
    const p = await r.json();
    document.getElementById('hp-total-earned').textContent = `$${(p.total_earned || 0).toFixed(2)}`;
    document.getElementById('hp-pending').textContent = `$${(p.pending_payout || 0).toFixed(2)}`;
    document.getElementById('hp-jobs-done').textContent = p.jobs_completed || 0;
    document.getElementById('hp-uptime').textContent = p.uptime ? `${p.uptime.toFixed(1)}%` : '‚Äî';
    panel.style.display = '';
    panel.dataset.providerId = providerId;
  } catch (e) { panel.style.display = 'none'; }
}

async function requestProviderPayout() {
  const panel = document.getElementById('host-provider-panel');
  const providerId = panel ? panel.dataset.providerId : null;
  if (!providerId) { showToast('No provider ID', 'error'); return; }
  try {
    const r = await fetch(`${API}/api/providers/${providerId}/payout`, { method: 'POST', headers: authHeaders() });
    if (r.ok) { const d = await r.json(); showToast(`Payout of $${d.amount || 0} requested`, 'success'); loadProviderPanel({ provider_id: providerId }); }
    else { const d = await r.json(); showToast(d.detail || 'Payout failed', 'error'); }
  } catch (e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Notification Preferences ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveNotificationPrefs() {
  const prefs = {
    job_complete: document.getElementById('notif-job-complete').checked,
    job_failed: document.getElementById('notif-job-failed').checked,
    billing: document.getElementById('notif-billing').checked,
    security: document.getElementById('notif-security').checked,
    sla: document.getElementById('notif-sla').checked,
    marketing: document.getElementById('notif-marketing').checked,
    digest_frequency: document.getElementById('notif-digest-freq').value
  };
  localStorage.setItem('xcelsior_notif_prefs', JSON.stringify(prefs));
  showToast('Notification preferences saved', 'success');
}

function loadNotificationPrefs() {
  const saved = localStorage.getItem('xcelsior_notif_prefs');
  if (!saved) return;
  try {
    const prefs = JSON.parse(saved);
    if (prefs.job_complete !== undefined) document.getElementById('notif-job-complete').checked = prefs.job_complete;
    if (prefs.job_failed !== undefined) document.getElementById('notif-job-failed').checked = prefs.job_failed;
    if (prefs.billing !== undefined) document.getElementById('notif-billing').checked = prefs.billing;
    if (prefs.security !== undefined) document.getElementById('notif-security').checked = prefs.security;
    if (prefs.sla !== undefined) document.getElementById('notif-sla').checked = prefs.sla;
    if (prefs.marketing !== undefined) document.getElementById('notif-marketing').checked = prefs.marketing;
    if (prefs.digest_frequency) document.getElementById('notif-digest-freq').value = prefs.digest_frequency;
  } catch (e) {}
}

// ‚îÄ‚îÄ Privacy Consent ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function revokeAllConsent() {
  if (!confirm('Revoke all data consent? This will disable telemetry, cross-border transfers, and profiling.')) return;
  document.getElementById('consent-telemetry').checked = false;
  document.getElementById('consent-cross-border').checked = false;
  document.getElementById('consent-profiling').checked = false;
  saveConsent();
  showToast('All consent revoked', 'warning');
}

// ‚îÄ‚îÄ Slurm HPC Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _slurmRecentJobs = [];

async function fetchSlurmProfiles() {
  try {
    const r = await fetch(`${API}/api/slurm/profiles`);
    const d = await r.json();
    const profiles = d.profiles || {};
    const keys = Object.keys(profiles);
    const container = document.getElementById('slurm-profiles');
    const select = document.getElementById('slurm-profile');
    if (!keys.length) {
      container.innerHTML = '<div style="color:#888;font-size:12px">No cluster profiles available.</div>';
      return;
    }
    container.innerHTML = keys.map(k => `<div class="cluster-card" onclick="selectClusterProfile('${k}')" id="cluster-${k}"><div class="cc-name">${profiles[k]}</div><div class="cc-desc">${k}</div></div>`).join('');
    select.innerHTML = '<option value="">Auto-select</option>' + keys.map(k => `<option value="${k}">${profiles[k]}</option>`).join('');
  } catch(e) {
    document.getElementById('slurm-profiles').innerHTML = '<div style="color:#f44336;font-size:12px">Failed to load profiles.</div>';
  }
}

function selectClusterProfile(name) {
  document.querySelectorAll('.cluster-card').forEach(c => c.classList.remove('selected'));
  const el = document.getElementById(`cluster-${name}`);
  if (el) el.classList.add('selected');
  document.getElementById('slurm-profile').value = name;
}

async function submitSlurmJob(preview) {
  const name = document.getElementById('slurm-name').value.trim();
  if (!name) { showToast('Job name is required', 'error'); return; }
  const body = {
    name,
    vram_needed_gb: parseFloat(document.getElementById('slurm-vram').value) || 16,
    priority: parseInt(document.getElementById('slurm-priority').value) || 5,
    tier: document.getElementById('slurm-tier').value,
    num_gpus: parseInt(document.getElementById('slurm-gpus').value) || 1,
    image: document.getElementById('slurm-image').value.trim(),
    profile: document.getElementById('slurm-profile').value || null,
    dry_run: preview === true || document.getElementById('slurm-dryrun').checked
  };
  try {
    const r = await fetch(`${API}/api/slurm/submit`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const d = await r.json();
    if (!r.ok) { showToast(d.detail || 'Submit failed', 'error'); return; }
    if (d.script || d.dry_run) {
      document.getElementById('slurm-script-card').style.display = '';
      document.getElementById('slurm-script-content').textContent = d.script || JSON.stringify(d, null, 2);
      showToast('Dry run: script preview generated', 'info');
    } else {
      const slurmId = d.slurm_job_id || d.job_id || '?';
      _slurmRecentJobs.unshift({ id: slurmId, name, time: new Date().toLocaleTimeString(), status: 'submitted' });
      if (_slurmRecentJobs.length > 20) _slurmRecentJobs.pop();
      renderSlurmRecent();
      showToast(`Slurm job submitted: ${slurmId}`, 'success');
      document.getElementById('slurm-script-card').style.display = 'none';
    }
  } catch(e) {
    showToast('Failed to submit Slurm job', 'error');
  }
}

async function fetchSlurmStatus() {
  const jobId = document.getElementById('slurm-status-id').value.trim();
  if (!jobId) { showToast('Enter a Slurm Job ID', 'error'); return; }
  const el = document.getElementById('slurm-status-result');
  el.innerHTML = 'Checking‚Ä¶';
  try {
    const r = await fetch(`${API}/api/slurm/status/${encodeURIComponent(jobId)}`);
    const d = await r.json();
    if (!r.ok) { el.innerHTML = `<span style="color:#f44336">${d.detail || 'Not found'}</span>`; return; }
    el.innerHTML = `<div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px">
      <span style="color:#888">Job ID:</span><span>${d.slurm_job_id || jobId}</span>
      <span style="color:#888">State:</span><span class="status status-${(d.state||'unknown').toLowerCase()}">${d.state || 'unknown'}</span>
      <span style="color:#888">Partition:</span><span>${d.partition || '‚Äî'}</span>
      <span style="color:#888">Nodes:</span><span>${d.num_nodes || '‚Äî'}</span>
      <span style="color:#888">Start:</span><span>${d.start_time || '‚Äî'}</span>
      <span style="color:#888">End:</span><span>${d.end_time || '‚Äî'}</span>
    </div>`;
    // Update recent jobs list
    const recent = _slurmRecentJobs.find(j => j.id === jobId);
    if (recent) { recent.status = (d.state || 'unknown').toLowerCase(); renderSlurmRecent(); }
  } catch(e) {
    el.innerHTML = '<span style="color:#f44336">Failed to fetch status</span>';
  }
}

async function cancelSlurmJob() {
  const jobId = document.getElementById('slurm-status-id').value.trim();
  if (!jobId) { showToast('Enter a Slurm Job ID to cancel', 'error'); return; }
  if (!confirm(`Cancel Slurm job ${jobId}?`)) return;
  try {
    const r = await fetch(`${API}/api/slurm/${encodeURIComponent(jobId)}`, { method: 'DELETE' });
    const d = await r.json();
    if (!r.ok) { showToast(d.detail || 'Cancel failed', 'error'); return; }
    showToast(`Slurm job ${jobId} cancelled`, 'success');
    const recent = _slurmRecentJobs.find(j => j.id === jobId);
    if (recent) { recent.status = 'cancelled'; renderSlurmRecent(); }
  } catch(e) {
    showToast('Failed to cancel Slurm job', 'error');
  }
}

function renderSlurmRecent() {
  const el = document.getElementById('slurm-recent-jobs');
  if (!_slurmRecentJobs.length) { el.innerHTML = 'No recent submissions.'; return; }
  el.innerHTML = _slurmRecentJobs.map(j => `<div class="slurm-job-row">
    <span style="color:#90caf9">${j.id}</span>
    <span>${j.name}</span>
    <span class="status status-${j.status}">${j.status}</span>
    <span style="color:#666">${j.time}</span>
  </div>`).join('');
}

// ‚îÄ‚îÄ Spot Bid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitSpotBid() {
  const name = document.getElementById('spot-bid-name').value.trim();
  if (!name) { showToast('Job name is required', 'error'); return; }
  const body = {
    name,
    vram_needed_gb: parseFloat(document.getElementById('spot-bid-vram').value) || 16,
    max_bid: parseFloat(document.getElementById('spot-bid-max').value) || 0.50,
    priority: parseInt(document.getElementById('spot-bid-priority').value) || 5
  };
  try {
    const r = await fetch(`${API}/spot/job`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const d = await r.json();
    if (!r.ok) { showToast(d.detail || 'Spot bid failed', 'error'); return; }
    showToast(`Spot bid placed: ${d.job?.job_id || 'submitted'}`, 'success');
    document.getElementById('spot-bid-name').value = '';
    refresh();
  } catch(e) {
    showToast('Failed to submit spot bid', 'error');
  }
}

// ‚îÄ‚îÄ SLA Hosts Summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchSLAHostsSummary() {
  const el = document.getElementById('sla-hosts-summary');
  el.innerHTML = 'Loading‚Ä¶';
  try {
    const r = await fetch(`${API}/api/sla/hosts-summary`);
    const d = await r.json();
    if (!r.ok) { el.innerHTML = '<span style="color:#f44336">Failed to load</span>'; return; }
    const hosts = d.hosts || [];
    if (!hosts.length) { el.innerHTML = 'No hosts with SLA data.'; return; }
    el.innerHTML = hosts.map(h => {
      const pctClass = h.uptime_30d_pct >= 0.99 ? 'pct-good' : h.uptime_30d_pct >= 0.90 ? 'pct-warn' : 'pct-bad';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1a">
        <div><span style="color:#90caf9">${h.host_id}</span> <span style="color:#666;font-size:10px">${h.gpu_model}</span></div>
        <div style="display:flex;gap:12px;align-items:center">
          <span class="${pctClass}">${(h.uptime_30d_pct * 100).toFixed(2)}%</span>
          <span style="color:#666">${h.violation_count} violations</span>
          <span class="tier tier-${h.sla_tier}">${h.sla_tier}</span>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = '<span style="color:#f44336">Error loading SLA data</span>';
  }
}

// ‚îÄ‚îÄ Residency Trace ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchResidencyTrace() {
  const jobId = document.getElementById('residency-trace-jobid').value.trim();
  if (!jobId) { showToast('Enter a Job ID', 'error'); return; }
  const el = document.getElementById('residency-trace-result');
  el.innerHTML = 'Loading trace‚Ä¶';
  try {
    const r = await fetch(`${API}/api/jurisdiction/residency-trace/${encodeURIComponent(jobId)}`);
    const d = await r.json();
    if (!r.ok) { el.innerHTML = `<span style="color:#f44336">${d.detail || 'Not found'}</span>`; return; }
    const trace = d.trace || {};
    el.innerHTML = `<div class="residency-trace-panel">
      ${Object.entries(trace).map(([k, v]) => `<div class="rt-field"><span class="rt-label">${k.replace(/_/g, ' ')}</span><span class="rt-value">${typeof v === 'object' ? JSON.stringify(v) : v}</span></div>`).join('')}
    </div>`;
  } catch(e) {
    el.innerHTML = '<span style="color:#f44336">Failed to fetch residency trace</span>';
  }
}

// ‚îÄ‚îÄ Profile Enhancement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadEnhancedProfile() {
  try {
    const token = sessionStorage.getItem('xcelsior_token');
    if (!token) return;
    const r = await fetch(`${API}/api/auth/me`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!r.ok) return;
    const d = await r.json();
    const u = d.user || {};
    // Avatar
    const avatarEl = document.getElementById('profile-avatar');
    if (avatarEl && u.name) {
      avatarEl.textContent = u.name.charAt(0).toUpperCase();
    } else if (avatarEl && u.email) {
      avatarEl.textContent = u.email.charAt(0).toUpperCase();
    }
    // Name & email
    const nameEl = document.getElementById('profile-name-display');
    if (nameEl) nameEl.textContent = u.name || u.email || '‚Äî';
    const emailEl = document.getElementById('profile-email-display');
    if (emailEl) emailEl.textContent = u.email || '‚Äî';
    // Member since
    const sinceEl = document.getElementById('profile-member-since');
    if (sinceEl && u.created_at) {
      const date = new Date(u.created_at * 1000);
      sinceEl.textContent = `Member since ${date.toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' })}`;
    }
    // Populate settings fields
    if (u.name) document.getElementById('set-name').value = u.name;
    if (u.provider_id) document.getElementById('set-provider-id').value = u.provider_id;
    if (u.country) document.getElementById('set-country').value = u.country;
    if (u.province) document.getElementById('set-province').value = u.province;
  } catch(e) { /* optional enhancement */ }
}

// ‚îÄ‚îÄ Data Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function requestDataExport() {
  const btn = document.getElementById('data-export-btn');
  const statusEl = document.getElementById('data-export-status');
  btn.disabled = true;
  btn.textContent = '‚è≥ Preparing export...';
  try {
    const token = sessionStorage.getItem('xcelsior_token');
    const r = await fetch(`${API}/api/auth/me/data-export`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const d = await r.json();
    if (d.ok && d.data_export) {
      const blob = new Blob([JSON.stringify(d.data_export, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `xcelsior_data_export_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      statusEl.style.display = '';
      statusEl.textContent = '‚úì Data exported successfully';
      showToast('Data export downloaded', 'success');
    } else {
      showToast(d.detail || 'Export failed', 'error');
    }
  } catch(e) {
    showToast('Failed to export data', 'error');
  }
  btn.disabled = false;
  btn.textContent = 'üì• Request Data Export';
}

// ‚îÄ‚îÄ Delete Account with confirmation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmDeleteAccount() {
  const email = sessionStorage.getItem('xcelsior_email') || 'your account';
  if (!confirm(`‚ö†Ô∏è PERMANENTLY delete ${email} and ALL associated data?\n\nThis includes:\n- Profile & settings\n- Job history\n- API keys\n- Billing records\n\nThis action CANNOT be undone.`)) return;
  if (!confirm('Are you absolutely sure? Type DELETE in the next prompt.')) return;
  const typed = prompt('Type DELETE to confirm:');
  if (typed !== 'DELETE') { showToast('Account deletion cancelled', 'info'); return; }
  deleteAccount();
}

async function deleteAccount() {
  try {
    const token = sessionStorage.getItem('xcelsior_token');
    const r = await fetch(`${API}/api/auth/me`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (r.ok) {
      showToast('Account deleted', 'success');
      sessionStorage.clear();
      localStorage.clear();
      setTimeout(() => location.reload(), 1500);
    } else {
      showToast('Failed to delete account', 'error');
    }
  } catch(e) { showToast('Network error', 'error'); }
}

// ‚îÄ‚îÄ SSH Key Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _sshKeys = JSON.parse(localStorage.getItem('xcelsior_ssh_keys') || '[]');

function uploadSshKey() {
  const key = document.getElementById('ssh-upload-key').value.trim();
  const label = document.getElementById('ssh-key-label').value.trim() || 'key-' + (_sshKeys.length + 1);
  if (!key) { showToast('Paste an SSH public key', 'warning'); return; }
  if (!key.startsWith('ssh-')) { showToast('Invalid SSH key format', 'error'); return; }
  const fingerprint = btoa(key.slice(0, 32)).slice(0, 16) + '...';
  _sshKeys.push({ name: label, fingerprint, added: new Date().toISOString().slice(0, 10), key: key.slice(0, 80) });
  localStorage.setItem('xcelsior_ssh_keys', JSON.stringify(_sshKeys));
  renderSshKeys();
  document.getElementById('ssh-upload-key').value = '';
  document.getElementById('ssh-key-label').value = '';
  showToast(`SSH key "${label}" added`, 'success');
}

function removeSshKey(idx) {
  if (!confirm('Remove this SSH key?')) return;
  _sshKeys.splice(idx, 1);
  localStorage.setItem('xcelsior_ssh_keys', JSON.stringify(_sshKeys));
  renderSshKeys();
  showToast('SSH key removed', 'success');
}

function renderSshKeys() {
  const tbody = document.getElementById('ssh-keys-table');
  if (!_sshKeys.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="color:#555;text-align:center;font-size:11px">No SSH keys uploaded</td></tr>';
    return;
  }
  tbody.innerHTML = _sshKeys.map((k, i) =>
    `<tr><td style="font-size:11px">${k.name}</td><td style="font-family:monospace;font-size:10px;color:#888">${k.fingerprint}</td><td style="font-size:11px;color:#666">${k.added}</td><td><button class="btn btn-secondary" onclick="removeSshKey(${i})" style="font-size:9px;padding:1px 6px;color:#f44336">‚úï</button></td></tr>`
  ).join('');
}

// ‚îÄ‚îÄ Score Breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchScoreBreakdown(entityId) {
  const el = document.getElementById('score-breakdown');
  if (!el) return;
  try {
    const r = await fetch(`${API}/api/reputation/${entityId}/breakdown`);
    const d = await r.json();
    if (!d.ok) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-desc">No score data available</div></div>'; return; }
    const b = d.breakdown || {};
    const maxVal = Math.max(b.jobs_completed || 0, b.uptime_bonus || 0, b.penalties || 0, b.decay || 0, 1);
    el.innerHTML = `
      <div class="breakdown-bar"><span class="bar-label">Jobs</span><div class="bar-track"><div class="bar-fill green" style="width:${((b.jobs_completed || 0) / maxVal * 100).toFixed(0)}%"></div></div><span class="bar-value">+${(b.jobs_completed || 0).toFixed(1)}</span></div>
      <div class="breakdown-bar"><span class="bar-label">Uptime</span><div class="bar-track"><div class="bar-fill blue" style="width:${((b.uptime_bonus || 0) / maxVal * 100).toFixed(0)}%"></div></div><span class="bar-value">+${(b.uptime_bonus || 0).toFixed(1)}</span></div>
      <div class="breakdown-bar"><span class="bar-label">Penalties</span><div class="bar-track"><div class="bar-fill red" style="width:${((b.penalties || 0) / maxVal * 100).toFixed(0)}%"></div></div><span class="bar-value">-${(b.penalties || 0).toFixed(1)}</span></div>
      <div class="breakdown-bar"><span class="bar-label">Decay</span><div class="bar-track"><div class="bar-fill amber" style="width:${((b.decay || 0) / maxVal * 100).toFixed(0)}%"></div></div><span class="bar-value">-${(b.decay || 0).toFixed(1)}</span></div>
      <div style="font-size:11px;color:#666;margin-top:4px;text-align:right">${d.events_analyzed || 0} events analyzed</div>
    `;
  } catch(e) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-desc">Score breakdown unavailable</div></div>'; }
}

// ‚îÄ‚îÄ Score History List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchScoreHistory(entityId) {
  const el = document.getElementById('score-history');
  if (!el) return;
  try {
    const r = await fetch(`${API}/api/reputation/${entityId}/history?limit=20`);
    const d = await r.json();
    const events = d.events || [];
    if (!events.length) {
      el.innerHTML = '<div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-desc">No score history yet</div></div>';
      return;
    }
    el.innerHTML = `<table style="font-size:11px"><thead><tr><th>Time</th><th>Event</th><th>Delta</th><th>Reason</th></tr></thead><tbody>` +
      events.slice(0, 15).map(e => {
        const ts = e.created_at ? new Date(e.created_at * 1000).toLocaleDateString() : '‚Äî';
        const delta = e.points_delta || e.score_delta || e.delta || 0;
        const color = delta >= 0 ? '#4caf50' : '#f44336';
        return `<tr><td style="color:#666">${ts}</td><td>${e.event_type || '‚Äî'}</td><td style="color:${color}">${delta >= 0 ? '+' : ''}${Number(delta).toFixed(1)}</td><td style="color:#888;font-size:10px">${e.reason || '‚Äî'}</td></tr>`;
      }).join('') +
      `</tbody></table>`;
  } catch(e) { el.innerHTML = '<div style="color:#555;font-size:11px">History unavailable</div>'; }
}

// ‚îÄ‚îÄ Balance Trend Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBalanceChart(transactions) {
  const el = document.getElementById('balance-chart');
  if (!el || !transactions.length) {
    if (el) el.innerHTML = '<div class="empty-state"><div class="empty-icon">üìà</div><div class="empty-desc">No transaction data for chart</div></div>';
    return;
  }
  const balances = transactions.slice().reverse().map(t => t.balance_after || 0);
  const max = Math.max(...balances, 1);
  const min = Math.min(...balances, 0);
  const range = max - min || 1;
  const width = Math.min(balances.length, 60);
  const chartHeight = 6;
  let rows = [];
  for (let row = chartHeight; row >= 0; row--) {
    let line = '';
    const threshold = min + (range * row / chartHeight);
    for (let i = 0; i < width; i++) {
      const idx = Math.floor(i * balances.length / width);
      line += balances[idx] >= threshold ? '‚ñà' : ' ';
    }
    rows.push(line);
  }
  const latest = balances[balances.length - 1] || 0;
  el.innerHTML = `<div style="color:#4caf50;letter-spacing:0">${rows.join('\n')}</div>
    <div style="display:flex;justify-content:space-between;font-size:10px;color:#555;margin-top:2px">
      <span>$${min.toFixed(2)}</span>
      <span>${transactions.length} transactions ¬∑ Latest: $${latest.toFixed(2)}</span>
      <span>$${max.toFixed(2)}</span>
    </div>`;
}

// ‚îÄ‚îÄ Date Range Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let txnDateFrom = null, txnDateTo = null;

function applyDateFilter() {
  const fromVal = document.getElementById('txn-date-from').value;
  const toVal = document.getElementById('txn-date-to').value;
  txnDateFrom = fromVal ? new Date(fromVal).getTime() / 1000 : null;
  txnDateTo = toVal ? (new Date(toVal).getTime() / 1000 + 86400) : null;
  renderFilteredTransactions();
}

function clearDateFilter() {
  txnDateFrom = null;
  txnDateTo = null;
  document.getElementById('txn-date-from').value = '';
  document.getElementById('txn-date-to').value = '';
  renderFilteredTransactions();
}

// ‚îÄ‚îÄ Notification Sound + Push ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let notifSoundEnabled = localStorage.getItem('xcelsior_notif_sound') === 'true';

function toggleNotifSound() {
  notifSoundEnabled = document.getElementById('notif-sound-toggle').checked;
  localStorage.setItem('xcelsior_notif_sound', String(notifSoundEnabled));
  showToast(notifSoundEnabled ? 'Alert sounds enabled' : 'Alert sounds disabled', 'info');
}

function togglePushNotifs() {
  const enabled = document.getElementById('notif-push-toggle').checked;
  if (enabled && 'Notification' in window) {
    Notification.requestPermission().then(perm => {
      if (perm === 'granted') {
        showToast('Push notifications enabled', 'success');
        localStorage.setItem('xcelsior_push_notifs', 'true');
      } else {
        document.getElementById('notif-push-toggle').checked = false;
        showToast('Push notification permission denied', 'warning');
      }
    });
  } else {
    localStorage.setItem('xcelsior_push_notifs', 'false');
  }
}

function playAlertSound() {
  if (!notifSoundEnabled) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = 800;
    gain.gain.value = 0.1;
    osc.start();
    osc.stop(ctx.currentTime + 0.15);
  } catch(e) { /* audio not available */ }
}

// ‚îÄ‚îÄ Enhanced Artifact Fetch with Expiry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchArtifactExpiry(jobId) {
  try {
    const r = await fetch(`${API}/api/artifacts/${jobId}/expiry`);
    const d = await r.json();
    return d.artifacts || [];
  } catch(e) { return []; }
}

function showToast(message, type = 'info') {
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
  toast.innerHTML = `<span style="font-size:14px">${icons[type] || '‚Ñπ'}</span> ${message}`;
  container.appendChild(toast);
  if (type === 'error' || type === 'warning') playAlertSound();
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
}
</script>
</body>
</html>
